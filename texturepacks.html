<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCHub — Texture Packs</title>
    <!-- Favicon Configuration -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/favicon/favicon-16x16.png">
    <link rel="manifest" href="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/favicon/site.webmanifest">
    <link rel="shortcut icon" href="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/favicon/favicon.ico">
    <!-- End Favicon Configuration -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
    /* Prevents the "flash of the wrong theme" by keeping the body hidden until the theme is ready */
    body {
        opacity: 0;
        transition: opacity 0.2s ease-in;
    }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-0: #000000;
            --bg-1: #1c1c1c;
            --bg-2: #2c2c2c;
            --muted: #a8b3cf;
            --text: #e8eefc;
            --border: rgba(255, 255, 255, .12);
            --brand-1: #de212a;
            --brand-2: #b21a22;
            --shadow-brand: 0 12px 30px rgba(222, 33, 42, .22);
            --danger: #ef4444;
            --success: #22c55e;
            --border-strong: rgba(255, 255, 255, .2);
            --primary: var(--brand-1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; scroll-behavior: smooth; }
        body {
            margin: 0;
            background-color: var(--bg-0);
            color: var(--text);
            font: 500 15px/1.6 Inter, sans-serif;
            padding-top: 80px;
        }
        body::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-image: var(--bg-image, url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg'));
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(8px);
            opacity: 0.25;
            z-index: -1;
            transition: background-image 0.5s ease-in-out;
        }
        a { color: inherit; text-decoration: none; }
        
        /* ====== Header Styles (Mobile First) ====== */
        header { 
            position: fixed;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            z-index: 50; 
            background: none;
            border: none;
        }
        .nav { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 12px 18px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: rgba(28, 28, 28, 0.7);
            backdrop-filter: blur(20px) saturate(1.2);
            border: 1px solid var(--border);
            border-radius: 1.25rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge {
            height: 40px; width: 40px; border-radius: 10px;
            display: grid; place-items: center;
            background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
            box-shadow: var(--shadow-brand);
        }
        .brand-title { font-weight: 800; letter-spacing: .6px; font-size: 15px; }
        .nav-actions { display: none; }
        .btn { padding: 8px 16px; border-radius: 12px; font-weight: 700; display: inline-flex; align-items: center; gap: .55rem; cursor: pointer; border: 1px solid transparent; }
        .ghost { border-color: var(--border); background: transparent; color: var(--text); }
        .primary {
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            box-shadow: var(--shadow-brand);
            color: white;
        }
        .btn.danger { background-color: #ef444420; border-color: #ef444490; color: var(--danger); }
        .btn.success { background-color: #22c55e20; border-color: #22c55e90; color: var(--success); }
        .container { max-width: 1200px; margin: 0 auto; padding: 28px 18px; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { position: sticky; top: 100px; height: fit-content; }
        .card { background: var(--bg-1); border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 24px 70px rgba(0, 0, 0, .55); }
        .panel { padding: 18px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 14px; letter-spacing: .4px; color: #cbd5e1; text-transform: uppercase; }
        .search { display: flex; align-items: center; position: relative; }
        .search input { flex: 1; padding: .7rem 1rem; padding-right: 2.5rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); min-width: 0; }
        .search .btn.sm.ghost { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: .5rem; line-height: 1; height: 32px; width: 32px; display: grid; place-items: center; background: transparent; border: none; color: var(--muted); }
        .swatches, .resolutions { display: flex; flex-wrap: wrap; gap: 8px; }
        .swatch { width: 34px; height: 34px; border-radius: 999px; border: 2px solid rgba(255, 255, 255, .12); cursor: pointer; position: relative; display: grid; place-items: center; font-size: 16px; color: white; }
        .swatch.active, .res-box.active { outline: 3px solid var(--brand-1) !important; }
        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            padding: .45rem .7rem; border-radius: 999px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            cursor: pointer; color: var(--muted); font-weight: 700;
            text-transform: capitalize; 
            transition: all 0.2s ease;
        }
        .tag:hover {
            border-color: var(--border-strong);
            color: var(--text);
        }
        .tag.active { 
            background: var(--brand-1);
            border-color: var(--brand-2);
            color: white;
        }
        .res-box { padding: .45rem .7rem; border-radius: 8px; background: var(--bg-2); border: 1px solid var(--border); cursor: pointer; font-weight: 700; color: white; text-transform: capitalize; }
        .tiny { font-size: 12px; color: var(--muted); }
        .packs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }
        .pack { 
            overflow: hidden; 
            position: relative; 
            cursor: pointer;
        }
        .pack.card { box-shadow: 0 24px 70px rgba(0, 0, 0, .55); transition: box-shadow .2s, transform .2s, border-color .2s; }
        .pack.card:hover { transform: translateY(-4px); box-shadow: 0 28px 75px rgba(0, 0, 0, .65); border-color: rgba(255,255,255,.2); }
        .thumb { height: 140px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .pack .thumb { border-bottom-color: var(--border) !important; }
        .thumb .pack-icon-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(8px) brightness(0.7); transform: scale(1.1); }
        .thumb .pack-icon { position: relative; width: 90px; height: 90px; border-radius: 8px; object-fit: cover; z-index: 1; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }
        .thumb .glyph { height: 68px; width: 68px; border-radius: 14px; display: grid; place-items: center; color: white; }
        .content { padding: 14px; }
        .content h4 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .badge { font-size: 12px; padding: .25rem .55rem; border-radius: 999px; border: 1px solid var(--border); background: var(--bg-2); color: white; font-weight: 700; text-transform: capitalize;}
        .pack-stats-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--muted); }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .pack-options-btn { position: absolute; top: 8px; right: 8px; z-index: 2; background: rgba(0, 0, 0, 0.4); color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; width: 30px; height: 30px; display: grid; place-items: center; cursor: pointer; padding: 0; }
        .pack-options-menu { display: none; position: absolute; top: 42px; right: 8px; z-index: 3; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: visible; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); min-width: 150px; }
        .pack-options-menu a, .pack-options-menu button { display: flex; align-items: center; gap: 10px; padding: 10px 14px; font-size: 14px; background: none; border: none; color: var(--text); cursor: pointer; width: 100%; text-align: left; transition: background 0.2s; }
        .pack-options-menu a:hover, .pack-options-menu button:hover { background: var(--brand-1); }
        .pack-options-menu a i, .pack-options-menu button i { width: 16px; text-align: center; }
        .share-item { position: relative; }
        .share-item:hover > .share-submenu,
        .share-submenu:hover,
        .share-submenu.show { display: block; }
        .share-submenu { display: none; position: absolute; left: 100%; top: 0; margin-left: 8px; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); min-width: 180px; z-index: 4; }
        .share-submenu a { padding: 10px 14px; display: flex; align-items: center; gap: 10px; color: var(--text); transition: background 0.2s; }
        .share-submenu a:hover { background: var(--brand-1); }
        .share-submenu a i { width: 18px; text-align: center; }
        .btn.sm { padding: .25rem .5rem; border-radius: 8px; font-weight: 700; display: inline-flex; align-items: center; gap: .4rem; min-width: auto; }
        .btn.sm.btn-clear {
            padding: .2rem .6rem; font-size: 12px; font-weight: 800;
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            color: white; border: none;
        }
        .backdrop { position: fixed; inset: 0; background: rgba(2, 6, 23, .8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 60; }
        .backdrop.on-top { z-index: 70; }
        .modal { width: 100%; max-width: 760px; background: var(--bg-2); border-radius: 12px; overflow-y: auto; max-height: 90vh; }
        .modal .panel { padding: 20px; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 12px 20px 20px; }
        .modal-footer .right-actions { display: flex; gap: 10px; }
        .modal-footer.center-actions { justify-content: center; }
        .file-upload-area { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; border: 2px dashed var(--border); border-radius: 12px; background: var(--bg-0); text-align: center; cursor: pointer; grid-column: span 2; }
        .file-upload-area.bulk-mode { grid-column: 1 / -1; }
        .file-upload-area:hover { border-color: var(--brand-1); background: rgba(255, 255, 255, .05); }
        .file-upload-area i { font-size: 32px; margin-bottom: 12px; color: var(--brand-1); }
        .file-hint { margin-top: 6px; color: var(--muted); }
        .label-with-icon { display: flex; align-items: center; gap: 6px; }
        input[type="text"], textarea { width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:var(--bg-2);color:var(--text); font-family: inherit; font-size: inherit; }
        textarea { resize: vertical; height: 120px; }
        .sort-container { position: relative; }
        .sort-btn { padding: .25rem .5rem; gap: .5rem; }
        .sort-btn #currentSort, .sort-btn #mobileCurrentSort { color: var(--text); }
        .sort-btn .fa-chevron-down { font-size: 10px; transition: transform .2s; }
        .sort-container.open .fa-chevron-down { transform: rotate(180deg); }
        .sort-menu { display: none; position: absolute; top: 100%; left: 0; margin-top: 6px; z-index: 10; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.4); min-width: 160px; }
        .sort-menu a { display: block; padding: 8px 14px; font-size: 14px; }
        .sort-menu a:hover { background: var(--brand-1); }
        .sort-menu a.active { font-weight: 800; color: var(--text); }
        .brand-icon-custom { width: 100%; height: 100%; object-fit: contain; padding: 4px; transform: translateY(-11px); }
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 18px; border-radius: 8px; color: white; font-weight: 700; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out forwards; }
        .toast.error { background: var(--danger); }
        .toast.success { background: var(--success); }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 20px; }
        .pagination-btn { background: var(--bg-2); border: 1px solid var(--border); color: var(--text); width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; }
        .pagination-btn:hover { border-color: white; }
        fieldset { border: none; padding: 0; margin: 0; }
        #uploadFormFieldset:disabled { opacity: 0.5; pointer-events: none; }
        
        #tagSearchInput { padding: .5rem .8rem; }
        
        #tagSelectModal .modal-body {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 20px;
            padding-top: 10px;
        }
        #tagSelectModal .tag-checkbox {
            font-size: 11px;
            padding: .2rem .4rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-0);
            color: white;
            font-weight: 700;
            text-transform: capitalize;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        #tagSelectModal .tag-checkbox:hover {
            border-color: var(--brand-1);
        }
        #tagSelectModal .tag-checkbox.selected {
            background-color: var(--brand-1);
            border-color: var(--brand-2);
            color: white;
        }
        #admin-actions { display: none; }
        
        .user-dropdown { position: relative; display: inline-block; }
        .user-menu-btn {
            background: var(--bg-2); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 12px; display: flex; align-items: center;
            gap: 10px; cursor: pointer; font-weight: 600;
        }
        .nav-avatar-img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .user-menu-btn .fa-chevron-down { font-size: 0.8em; transition: transform 0.2s; }
        .user-menu-btn:hover { border-color: var(--border-strong); }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 110%;
            background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px;
            min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10;
            overflow: hidden;
        }
        .dropdown-content.show { display: block; }
        .dropdown-content a {
            color: var(--muted); padding: 12px 16px; text-decoration: none;
            display: flex; align-items: center; gap: 10px; font-weight: 600;
        }
        .dropdown-content a:hover { background: var(--bg-2); color: var(--text); }
        .logout-link { color: var(--brand-1) !important; }
        .logout-link:hover { background: rgba(222, 33, 42, .15) !important; color: #ff525a !important; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ====== MOBILE NAV ====== */
        .mobile-nav-controls { display: flex; align-items: center; gap: 0.5rem; }
        .mobile-nav-btn { background: none; border: none; color: var(--text); font-size: 1rem; cursor: pointer; z-index: 1001; padding: 0.5rem; }
        .mobile-nav-toggle { display: none; background: none; border: none; color: var(--text); font-size: 1rem; cursor: pointer; z-index: 1001; }
        .mobile-nav-backdrop { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 998; opacity: 0; transition: opacity 0.3s ease; }
        .mobile-nav-backdrop.show { display: block; opacity: 1; }
        .mobile-nav-sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 280px; background: var(--bg-1);
            z-index: 999; transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .mobile-nav-sidebar.show { transform: translateX(0); }
        .mobile-nav-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
        .mobile-nav-header { padding: 1.5rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--border); }
        .mobile-nav-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .mobile-nav-user-info { display: flex; flex-direction: column; }
        .mobile-nav-username { font-weight: 700; color: var(--text); }
        .mobile-nav-email { font-size: 0.8rem; color: var(--muted); }
        .mobile-nav-main-links, .mobile-nav-footer-links { display: flex; flex-direction: column; padding: 1rem; }
        .mobile-nav-main-links { flex-grow: 1; }
        .mobile-nav-main-links a, .mobile-nav-footer-links a {
            padding: 1rem; border-radius: 10px; display: flex; align-items: center; gap: 1rem;
            font-weight: 600; color: var(--muted); transition: all 0.2s ease;
        }
        .mobile-nav-main-links a:hover, .mobile-nav-footer-links a:hover { background: var(--bg-2); color: var(--text); }
        .mobile-nav-main-links a i, .mobile-nav-footer-links a i { width: 24px; text-align: center; font-size: 1.1rem; }
        .mobile-nav-main-links a.active-mobile-link { background: var(--bg-2); color: var(--brand-1); font-weight: 800; }
        .mobile-nav-footer-links .login-mobile-link { background-color: var(--bg-2); color: var(--text); }
        .primary-mobile-link { background: linear-gradient(90deg, var(--brand-1), var(--brand-2)); color: white !important; box-shadow: var(--shadow-brand); }
        
        /* ====== MOBILE USER HEADER ====== */
        .mobile-nav-user-header {
            padding: 1rem 1.5rem; display: flex; align-items: center;
            gap: 1rem; border-bottom: 1px solid var(--border);
        }
        .mobile-nav-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .mobile-nav-user-info { display: flex; flex-direction: column; }
        .mobile-nav-username { font-weight: 700; color: var(--text); }
        .mobile-nav-email { font-size: 0.8rem; color: var(--muted); }

        /* ====== MOBILE TOOLS COLLAPSIBLE ====== */
        .mobile-nav-collapsible .collapsible-trigger {
            display: flex; justify-content: space-between; align-items: center;
        }
        .mobile-nav-collapsible .arrow {
            font-size: 0.8em; transition: transform 0.3s ease;
        }
        .mobile-nav-collapsible.open .arrow { transform: rotate(180deg); }
        .collapsible-content {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out;
            padding-left: 1rem;
        }
        .collapsible-content .sub-link { padding-top: 0.5rem; padding-bottom: 0.5rem; }

        /* ====== DESKTOP NAVBAR & RESPONSIVENESS ====== */
        .desktop-nav-links, .desktop-nav-right { display: none; }
        .nav-left-desktop { display: contents; }

        /* ====== NOTIFICATION STYLES (MODAL) ====== */
        .notification-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .notification-backdrop.show { display: flex; }
        .notification-panel {
            width: 100%;
            max-width: 420px;
            background: var(--bg-1);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 101;
            overflow: hidden;
            color: var(--text);
            animation: slideInFromTop 0.3s ease-out;
        }
        .notification-btn-desktop {
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 1.2rem;
            line-height: 1;
            position: relative;
            cursor: pointer;
        }
        .notification-btn-desktop:hover {
            border-color: var(--border-strong);
            color: var(--text);
        }
        .mobile-nav-btn.notification-toggle-btn { color: white; }
        .notification-toggle-btn { position: relative; }
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            font-size: 8px;
            background-color: var(--brand-1);
            border-radius: 50%;
            border: 2px solid var(--bg-1);
        }
        .mobile-nav-btn .notification-badge { top: 6px; right: 6px; border-color: var(--bg-2); }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-2);
        }
        .notification-header h3 { margin: 0; font-size: 1rem; }
        .notification-header button { background: none; border: none; color: var(--muted); cursor: pointer; }
        #close-notifications-btn { font-size: 1.5rem; line-height: 1; }
        .notification-list { max-height: 400px; overflow-y: auto; }
        .notification-item {
            padding: 1rem; display: flex; gap: 1rem; align-items: flex-start;
            border-bottom: 1px solid var(--border); font-size: 0.9rem;
            position: relative; transition: background-color 0.2s;
        }
        .notification-item a { text-decoration: none; color: inherit; }
        .notification-item:hover { background-color: var(--bg-2); }
        .notification-item.read { opacity: 0.6; }
        .notification-icon { font-size: 1.2rem; color: var(--muted); padding-top: 2px; }
        .notification-content p { margin: 0 0 0.25rem 0; color: var(--text); }
        .notification-content .time { font-size: 0.75rem; color: var(--muted); }
        .dismiss-notification-btn {
            position: absolute; top: 0.5rem; right: 0.5rem; background: none;
            border: none; color: var(--muted); cursor: pointer;
            font-size: 1rem; display: none;
        }
        .notification-item:hover .dismiss-notification-btn { display: block; }
        .notification-list-empty { padding: 2rem; text-align: center; color: var(--muted); }
        .notification-list-empty .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .notification-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border); background: var(--bg-2); display: flex; justify-content: space-between; align-items: center;}
        .notification-footer-btn { font-size: 0.8rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 6px; background: none; border: none; cursor: pointer; color: var(--brand-1); transition: background-color 0.2s; }
        .notification-footer-btn:hover { background-color: var(--bg-1); }

        /* ====== TOOLS DROPDOWN ====== */
        .tools-dropdown-container { position: relative; }
        #tools-menu {
            display: none; position: absolute; left: 0; top: calc(100% + 0.5rem);
            background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px;
            min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10;
            overflow: hidden;
        }
        .tools-dropdown-container.open #tools-menu { display: block; }
        #tools-menu a {
            color: var(--muted); padding: 12px 16px; text-decoration: none;
            display: flex; align-items: center; gap: 10px; font-weight: 600;
        }
        #tools-menu a:hover { background: var(--bg-2); color: var(--text); }
        #tools-btn .fa-chevron-down { font-size: 0.7em; transition: transform 0.2s; }
        .tools-dropdown-container.open #tools-btn .fa-chevron-down { transform: rotate(180deg); }

        /* ====== DESKTOP SEARCH MODAL ====== */
        .desktop-search-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 10vh;
            animation: fadeIn 0.3s ease;
        }
        .desktop-search-modal-backdrop.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .desktop-search-modal-content {
            background: var(--bg-1);
            border-radius: 1rem;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 700px;
            padding: 1rem;
            padding-top: 3rem;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: slideDown 0.4s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-search-modal-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--muted);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: grid;
            place-items: center;
            z-index: 15;
        }
        .close-search-modal-btn:hover {
            background: var(--bg-1);
            color: var(--text);
        }
        .search-hub-container { max-width: 700px; margin: 2.5rem auto 0; position: relative; }
        .search-input-wrapper { display: flex; position: relative; background: var(--bg-1); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); transition: border-color 0.2s, box-shadow 0.2s; }
        .search-input-wrapper:focus-within { border-color: var(--brand-1); box-shadow: 0 15px 40px rgba(0,0,0,0.3), 0 0 0 3px rgba(222, 33, 42, .3); }
        .search-type-dropdown { position: relative; }
        #search-type-btn, #modal-search-type-btn { display: flex; align-items: center; gap: 0.5rem; height: 100%; padding: 0 1.2rem; background: var(--bg-2); border: none; color: var(--text); font-weight: 600; border-radius: 15px 0 0 15px; cursor: pointer; border-right: 1px solid var(--border); }
        #search-type-btn .fa-chevron-down, #modal-search-type-btn .fa-chevron-down { font-size: 0.7em; transition: transform 0.2s; }
        .search-type-dropdown.open #search-type-btn .fa-chevron-down, .search-type-dropdown.open #modal-search-type-btn .fa-chevron-down { transform: rotate(180deg); }
        #search-type-menu, #modal-search-type-menu { display: none; position: absolute; top: 110%; left: 0; z-index: 12; background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px; min-width: 100%; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .search-type-dropdown.open #search-type-menu, .search-type-dropdown.open #modal-search-type-menu { display: block; }
        .search-type-option { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: pointer; }
        .search-type-option:hover { background: var(--bg-2); }
        .search-type-option i { width: 16px; color: var(--muted); }
        #universal-search, #modal-universal-search { width: 100%; padding: 1.25rem 1.5rem; font-size: 1.1rem; background: transparent; border: none; color: var(--text); outline: none; }
        #search-results, #modal-search-results { display: none; position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: var(--bg-1); border: 1px solid var(--border); border-radius: 16px; max-height: 350px; overflow-y: auto; z-index: 10; }
        #modal-search-results {
            position: static;
            margin-top: 0.5rem;
            background: transparent;
            border: none;
            max-height: 250px;
        }
        #modal-search-results .search-result-item {
            background: var(--bg-2);
            border-radius: 8px;
            margin-bottom: 4px;
            border: none;
        }
        #modal-search-results .search-result-item:hover {
            background: var(--bg-1);
        }
        .search-result-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; transition: background-color 0.2s; }
        .search-result-item:not(:last-child) { border-bottom: 1px solid var(--border); }
        .search-result-item:hover { background: var(--bg-2); }
        .search-result-icon, .search-result-avatar { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .search-result-avatar.is-mc-skin { border-radius: 4px; image-rendering: pixelated; border: 1px solid var(--border); background: var(--bg-2); }
        .search-result-info { text-align: left; }
        .search-result-name { font-weight: 600; color: var(--text); }
        .search-result-sub { font-size: 0.8rem; color: var(--muted); }
        .modal-suggestions {
            margin-top: 1.5rem;
            padding: 0 0.5rem;
        }
        .suggestions-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .suggestions-title i {
            color: var(--brand-1);
        }
        .modal-suggestions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .suggestion-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-2);
            padding: 0.75rem;
            border-radius: 12px;
            transition: background 0.2s;
        }
        .suggestion-card:hover {
            background: var(--bg-1);
        }
        .suggestion-card .pack-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
        }
        
        /* ====== FOOTER ====== */
        footer {
            margin-top: 4rem;
            padding: 3rem 2rem 2rem;
            background: var(--bg-1);
            border-top: 1px solid var(--border);
        }
        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: 3rem;
            padding-bottom: 2rem;
        }
        .footer-brand {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .footer-brand .brand {
            display: flex;
            margin-bottom: 0.5rem;
        }
        .footer-brand p {
            color: var(--muted);
            line-height: 1.6;
            font-size: 0.9rem;
        }
        .footer-socials { 
            display: flex; 
            gap: 0.75rem; 
            margin-top: 1rem; 
        }
        .footer-socials a {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--bg-2);
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 1rem;
            transition: all 0.2s;
        }
        .footer-socials a:hover { 
            color: var(--text); 
            border-color: var(--brand-1);
            background: rgba(222, 33, 42, 0.1);
        }
        .footer-column h4 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1.25rem;
            color: var(--text);
        }
        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .footer-links a {
            color: var(--muted);
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .footer-links a:hover {
            color: var(--text);
        }
        .footer-discord {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.25rem;
            background: var(--brand-1);
            color: white;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-top: 1rem;
            transition: all 0.2s;
            box-shadow: var(--shadow-brand);
            width: fit-content;
        }
        .footer-discord:hover {
            background: var(--brand-2);
            transform: translateY(-2px);
        }
        .footer-discord i {
            font-size: 1.1rem;
        }
        .footer-bottom {
            max-width: 1200px;
            margin: 0 auto;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--muted);
        }
        .footer-bottom-links { 
            display: flex; 
            gap: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .footer-bottom-links a {
            color: var(--muted);
            transition: color 0.2s;
            font-size: 0.85rem;
        }
        .footer-bottom-links a:hover {
            color: var(--text);
        }
        
        .mobile-filter-controls { display: none; } 
        #mobile-filters-panel {
            background: var(--bg-2);
            border-radius: 16px;
            margin-top: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding: 0 18px;
        }
        #mobile-filters-panel.show {
            max-height: 1000px;
            padding: 18px;
        }
        .modal-mode-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            background: var(--bg-0);
            border-radius: 12px;
            padding: 3px;
            border: 1px solid var(--border);
            position: relative;
        }
        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            position: relative;
            z-index: 2;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .mode-btn.active { color: var(--text); }
        .mode-switcher-indicator {
            position: absolute;
            height: calc(100% - 6px);
            top: 3px;
            left: 3px;
            width: calc(50% - 3px);
            background: var(--bg-2);
            border-radius: 10px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1;
        }
        .modal-mode-switcher[data-active="bulk"] .mode-switcher-indicator {
            transform: translateX(100%);
        }
        #single-mode-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            align-items: start;
        }
        #bulk-mode-fields { display: none; flex-direction: column; gap: 1rem; }
        
        #upload-progress-container {
            display: none;
            width: 100%;
            margin-top: 1rem;
            grid-column: 1 / -1;
        }
        #progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--bg-0);
            border: 1px solid var(--border);
            border-radius: 5px;
            overflow: hidden;
        }
        #progress-bar-fill {
            width: 0%;
            height: 100%;
            background: var(--gradient-brand);
            transition: width 0.3s ease;
        }
        #progress-text {
            margin-top: 0.5rem;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        @media (min-width: 1024px) {
            .mobile-nav-controls { display: none !important; }
            header { padding: 0 1.5rem; }
            .nav-left-desktop {
                display: flex;
                align-items: center;
                gap: 1.5rem;
            }
            .desktop-nav-links, .desktop-nav-right {
                display: flex;
                align-items: center;
            }
            .desktop-nav-links {
                gap: 0.5rem;
            }
            .nav-link {
                padding: 0.6rem 1rem;
                border-radius: 10px;
                font-weight: 700;
                color: var(--muted);
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: transparent;
                border: none;
                border-bottom: 3px solid transparent;
                font-family: inherit;
                font-size: inherit;
                cursor: pointer;
            }
            .nav-link:hover {
                background-color: rgba(255, 255, 255, 0.05);
                color: var(--text);
            }
            .nav-link.active {
                background-color: transparent;
                color: white;
                box-shadow: none;
                border-bottom-color: var(--brand-1);
            }
            .nav-link:active {
                background-color: var(--brand-2);
            }

            .desktop-nav-right { gap: 1rem; }
            .desktop-search-container { position: relative; }
            .desktop-search-container input {
                background: var(--bg-2);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 0.6rem 1rem 0.6rem 2.5rem;
                width: 180px;
                color: var(--text);
                transition: all 0.2s ease;
                cursor: pointer;
            }
            .desktop-search-container input:focus {
                outline: none;
                border-color: var(--brand-1);
            }
            .desktop-search-container i {
                position: absolute;
                left: 1rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--muted);
            }
            #desktop-auth-actions {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .login-btn, .signup-btn {
                font-weight: 700;
                padding: 0.6rem 1rem;
                transition: all 0.2s ease;
                border-radius: 10px;
            }
            .login-btn {
                 color: var(--muted);
            }
            .login-btn:hover {
                color: var(--text);
                background-color: rgba(255, 255, 255, 0.05);
            }
            .signup-btn {
                background: var(--brand-1);
                box-shadow: var(--shadow-brand);
                color: white;
            }
            .signup-btn:hover {
                filter: brightness(1.1);
            }
        }

        @media (max-width: 1024px) { 
            .layout { grid-template-columns: 1fr; } 
            .sidebar, .filter-bar { display: none !important; } 
            .mobile-filter-controls { display: block; }
            .footer-container {
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            } 
            
            .mobile-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            #mobile-filter-btn {
                grid-column: 1 / -1; 
            }
            .mobile-actions .sort-container {
                width: 100%;
            }
            .mobile-actions .sort-btn {
                width: 100%;
                justify-content: space-between;
                height: 100%;
            }
            .mobile-actions .sort-btn > div {
                 display: flex;
                 align-items: center;
                 gap: 0.5rem;
            }
            
            .packs { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); } 
        }
        @media (max-width: 768px) { 
            .nav-actions { display: none; }
            .mobile-nav-toggle { display: block; }
            .packs { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .modal { max-width: 95vw; max-height: 95vh; }
            #uploadForm > fieldset > div { grid-template-columns: 1fr; }
            .file-upload-area { grid-column: span 1; }
            #single-mode-fields { grid-template-columns: 1fr; }
            .footer-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }
        @media (max-width: 480px) {
            .packs { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <header>
        <div class="nav">
            <div class="nav-left-desktop">
                <!-- BRAND -->
                <a class="brand" href="/">
                    <div class="brand-badge">
                        <img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom">
                    </div>
                    <div>
                        <div class="brand-title">MCHUB</div>
                        <div class="tiny">Minecraft • Community Hub</div>
                    </div>
                </a>

                <!-- DESKTOP - MIDDLE -->
                <div class="desktop-nav-links" id="desktop-nav-links"></div>
            </div>

            <!-- DESKTOP - RIGHT -->
            <div class="desktop-nav-right">
                <div class="desktop-search-container">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search..." readonly>
                </div>
                <div id="desktop-auth-actions"></div>
            </div>
            
            <!-- This is populated by auth.js but will be hidden on desktop -->
            <div class="nav-actions" id="nav-actions"></div>
            
            <!-- MOBILE CONTROLS -->
            <div class="mobile-nav-controls">
                <button id="mobile-search-toggle" class="mobile-nav-btn"><i class="fa-solid fa-magnifying-glass"></i></button>
                <div id="mobile-auth-actions"></div> <!-- Placeholder for mobile notification icon -->
                <button class="mobile-nav-btn mobile-nav-toggle"><i class="fa-solid fa-bars"></i></button>
            </div>
        </div>
    </header>

    <!-- NOTIFICATION MODAL -->
    <div id="notification-backdrop" class="notification-backdrop">
        <div id="notification-panel" class="notification-panel">
            <div class="notification-header">
                <h3>Notifications</h3>
                <button id="close-notifications-btn">&times;</button>
            </div>
            <div id="notification-list" class="notification-list">
                <!-- Notifications will be rendered here by JS -->
            </div>
            <div class="notification-footer">
                <button id="mark-all-read-btn" class="notification-footer-btn">Mark all as read</button>
                <button id="clear-all-btn" class="notification-footer-btn">Clear All</button>
            </div>
        </div>
    </div>

    <!-- DESKTOP SEARCH MODAL -->
    <div id="desktop-search-modal" class="desktop-search-modal-backdrop">
        <div class="desktop-search-modal-content">
            <button id="close-search-modal-btn" class="close-search-modal-btn"><i class="fa-solid fa-xmark"></i></button>
            
            <div class="search-hub-container" style="margin: 0; max-width: 100%;">
                <div class="search-input-wrapper">
                    <div class="search-type-dropdown" id="modal-search-type-dropdown">
                        <button id="modal-search-type-btn">
                            <span id="modal-search-type-label">Packs</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div id="modal-search-type-menu">
                            <div class="search-type-option" data-type="packs"><i class="fa-solid fa-palette"></i> Packs</div>
                            <div class="search-type-option" data-type="users"><i class="fa-solid fa-user"></i> Users</div>
                            <div class="search-type-option" data-type="gamertags"><i class="fa-brands fa-xbox"></i> Gamertags</div>
                        </div>
                    </div>
                    <input type="text" id="modal-universal-search" placeholder="Search for packs..." autocomplete="off">
                </div>
                <div id="modal-search-results"></div>
            </div>

            <div class="modal-suggestions">
                <h3 class="suggestions-title"><i class="fa-solid fa-fire"></i> Latest Packs</h3>
                <div id="modal-pack-suggestions" class="modal-suggestions-grid">
                    <!-- Suggestions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <section class="container" id="main-content">
        <div class="layout">
            <aside class="sidebar card panel">
                <div id="admin-actions">
                    <h3>Actions</h3>
                    <div class="row"><button class="btn primary" onclick="openModal()" style="width: 100%;"><i class="fa-solid fa-cloud-upload-alt"></i> Upload Pack</button></div>
                    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                </div>
                <h3>Colors</h3>
                <div id="colorSwatches" class="swatches"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearColors()">Clear colors</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Resolutions</h3>
                <div id="resolutionBoxes" class="resolutions"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearResolutions()">Clear resolutions</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Version</h3>
                <div id="versionBoxes" class="resolutions"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearVersions()">Clear versions</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Tags</h3>
                <div id="tagCloud" class="tags"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearTags()">Clear tags</button></div>
            </aside>
            
            <div class="main-content-area">
                <div class="card panel filter-bar" style="display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:14px; flex-wrap: wrap;">
                    <div class="sort-container" id="sortContainer">
                        <button class="btn sm ghost sort-btn" onclick="toggleSortMenu()">
                            <span class="tiny">Sort by:</span>
                            <span id="currentSort">Latest Upload</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div class="sort-menu" id="sortMenu">
                            <a href="#" class="active" onclick="setSort('latest', this)">Latest Upload</a>
                            <a href="#" onclick="setSort('downloads', this)">Downloads</a>
                        </div>
                    </div>
                    <div class="search" style="flex-grow: 1;">
                        <input id="q" placeholder="Search by name..." oninput="applyFilters()" />
                        <button class="btn sm ghost" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="row"><button class="btn sm ghost" onclick="resetAll()">Reset filters</button></div>
                </div>
                
                <div class="mobile-filter-controls">
                     <div class="search" style="margin-bottom: 1rem;">
                        <input id="mobile-q" placeholder="Search by name..." oninput="applyMobileSearch()" />
                        <button class="btn sm ghost" onclick="clearMobileSearch()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="mobile-actions">
                         <div class="sort-container" id="mobileSortContainer">
                            <button class="btn ghost sort-btn" onclick="toggleSortMenu(true)">
                                <div><span class="tiny">Sort by:</span> <span id="mobileCurrentSort">Latest Upload</span></div>
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            <div class="sort-menu" id="mobileSortMenu">
                                <a href="#" class="active" onclick="setSort('latest', this, true)">Latest Upload</a>
                                <a href="#" onclick="setSort('downloads', this, true)">Downloads</a>
                            </div>
                        </div>
                        <button class="btn ghost" onclick="resetAll()"><i class="fa-solid fa-undo"></i> Reset</button>
                        <button id="mobile-filter-btn" class="btn primary"><i class="fa-solid fa-sliders"></i> Choose Filters</button>
                    </div>
                    <div id="mobile-filters-panel" class="card">
                    </div>
                </div>

                <div id="grid" class="packs"></div>
                <div id="pagination-controls" class="pagination"></div>
            </div>
        </div>
    </section>

    <!-- Upload Modal -->
    <div id="backdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Upload Texture Pack</strong>
                    <button class="btn sm ghost" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny" id="modal-subtitle">Select a .mcpack or .zip file, set a name, choose color & tags.</div>
            </div>
            <div class="panel" style="padding-top:0">
                
                <div class="modal-mode-switcher" id="upload-mode-switcher" data-active="single">
                    <div class="mode-switcher-indicator"></div>
                    <button type="button" class="mode-btn active" data-mode="single" onclick="setUploadMode('single')"><i class="fa-solid fa-cube"></i> Single Upload</button>
                    <button type="button" class="mode-btn" data-mode="bulk" onclick="setUploadMode('bulk')"><i class="fa-solid fa-boxes-stacked"></i> Bulk Upload (Max 10)</button>
                </div>

                <form id="uploadForm" onsubmit="handleUpload(event)">
                    <fieldset id="uploadFormFieldset">
                        <div id="single-mode-fields">
                            <div>
                                <label class="tiny label-with-icon"><span>Pack name</span></label>
                                <input id="packName" required placeholder="e.g. Crystal PvP" type="text">
                            </div>
                            <div>
                                <label class="tiny">Primary color</label>
                                <div id="modalSwatches" class="swatches"></div>
                            </div>
                            <div>
                               <label class="tiny">Description (optional)</label>
                               <textarea id="packDescription" placeholder="A short description of the pack..."></textarea>
                            </div>
                            <div>
                                <div>
                                    <label class="tiny">Resolution</label>
                                    <div id="modalResolutions" class="resolutions"></div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label class="tiny">Tags</label>
                                    <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openTagModal()">
                                        <span id="tagSelectorBtnText">Select Tags</span>
                                        <i class="fa-solid fa-chevron-down fa-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="bulk-mode-fields">
                             <p class="tiny" style="color: var(--danger); font-weight: 700;">Note: Packs uploaded in bulk mode will use default values for Color, Resolution, and Tags. Please edit them individually later.</p>
                             <div id="bulk-file-list" style="margin-top: 1rem; padding: 10px; background: var(--bg-1); border-radius: 10px; border: 1px solid var(--border);">
                             </div>
                        </div>
                        <div class="file-upload-area" id="pack-file-area" onclick="document.getElementById('fileInput').click()">
                            <i class="fa-solid fa-file-arrow-up"></i>
                            <div>Drag & drop or <span style="color:var(--brand-1)">browse files</span></div>
                            <div class="file-hint" id="fileHint">.mcpack or .zip files only</div>
                            <input id="fileInput" type="file" accept=".mcpack,.zip" style="display:none" onchange="hintFile()" />
                        </div>
                        
                        <div id="upload-progress-container">
                            <div id="progress-bar"><div id="progress-bar-fill"></div></div>
                            <p id="progress-text"></p>
                        </div>
                    </fieldset>
                    <div class="modal-footer center-actions">
                        <button type="button" class="btn sm ghost" onclick="closeModal()">Cancel</button>
                        <button id="submitBtn" class="btn primary" type="submit"><i class="fa-solid fa-upload"></i> Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="tag-select-backdrop" class="backdrop on-top">
        <div class="modal card" style="max-width: 500px;" id="tagSelectModal">
            <div class="panel">
                <strong>Select Tags</strong>
                <div style="margin-top: 12px;">
                    <input type="text" id="tagSearchInput" placeholder="Search tags...">
                </div>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer center-actions">
                <button type="button" class="btn sm ghost" onclick="closeTagModal(false)">Cancel</button>
                <button type="button" class="btn primary" onclick="closeTagModal(true)">Done</button>
            </div>
        </div>
    </div>

    <div id="editBackdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Edit Texture Pack</strong>
                    <button class="btn sm ghost" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny">Change name, tags, description or color.</div>
            </div>
            <div class="panel" style="padding-top:0">
                <form id="editForm" onsubmit="saveEdit(event)">
                    <input type="hidden" id="editId" />
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div>
                            <label class="tiny">Pack name</label>
                            <input id="editPackName" required placeholder="Pack name" type="text">
                        </div>
                        <div>
                            <label class="tiny">Primary color</label>
                            <div id="editModalSwatches" class="swatches"></div>
                        </div>
                        <div style="grid-column: span 1;">
                            <label class="tiny">Resolution</label>
                            <div id="editModalResolutions" class="resolutions"></div>
                        </div>
                         <div style="grid-column: span 1;">
                            <label class="tiny">Tags</label>
                            <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openEditTagModal()">
                                <span id="editTagSelectorBtnText">Select Tags</span>
                                <i class="fa-solid fa-chevron-down fa-xs"></i>
                            </button>
                        </div>
                        <div style="grid-column: span 2;"><label class="tiny">Description (optional)</label>
                            <textarea id="editPackDescription" placeholder="A short description of the pack..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div></div>
                        <div class="right-actions">
                            <button type="button" class="btn sm danger" onclick="promptDelete()">Delete</button>
                            <button class="btn primary" type="submit"><i class="fa-solid fa-save"></i> Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="confirmDeleteBackdrop" class="backdrop">
        <div class="modal card" style="max-width: 420px;">
            <div class="panel">
                <strong>Are you sure you want to delete it?</strong>
                <p class="tiny" style="margin: 4px 0 12px;">This will permanently delete the texture pack.</p>
                <div style="display:flex;justify-content:flex-end;gap:10px;">
                    <button class="btn sm ghost" onclick="cancelDelete()">No</button>
                    <button class="btn sm success" onclick="confirmDelete()">Yes</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <footer>
        <div class="footer-container">
            <div class="footer-brand">
                <a class="brand" href="/">
                    <div class="brand-badge">
                        <img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom">
                    </div>
                    <div>
                        <div class="brand-title">MCHUB</div>
                        <div class="tiny">Minecraft • Community Hub</div>
                    </div>
                </a>
                <p>Your ultimate destination for exploring the world of Minecraft. Discover new packs, follow your favorites, and never miss an update.</p>
                <div class="footer-socials">
                    <a href="#" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fa-brands fa-twitter"></i></a>
                    <a href="https://discord.gg/KtafawJZxM" target="_blank" aria-label="Discord"><i class="fa-brands fa-discord"></i></a>
                </div>
            </div>
            
            <div class="footer-column">
                <h4>Explore</h4>
                <div class="footer-links">
                    <a href="/">Home</a>
                    <a href="/texturepacks.html">Browse Packs</a>
                    <a href="/news.html">News</a>
                </div>
            </div>
            
            <div class="footer-column">
                <h4>Support</h4>
                <div class="footer-links">
                    <a href="#">Contact Us</a>
                    <a href="#">Report Issue</a>
                    <a href="#">FAQ</a>
                </div>
            </div>
            
            <div class="footer-column">
                <h4>Stay Updated</h4>
                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">Join our Discord server for the latest updates and news.</p>
                <a href="https://discord.gg/KtafawJZxM" target="_blank" class="footer-discord">
                    <i class="fa-brands fa-discord"></i>
                    <span>Join Server</span>
                </a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 MCHub. All rights reserved.</p>
            <div class="footer-bottom-links">
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
                <a href="#">DMCA</a>
            </div>
        </div>
    </footer>
    
    <script type="module" src="/theme.js"></script>
    <script type="module" src="/auth.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        /* ====== CONSTANTS & STATE ====== */
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const COLORS = [{key: 'none', hex: '#4b5563', icon: 'fa-solid fa-ban'}, {key: 'red',hex: '#ef4444'}, {key: 'blue',hex: '#3b82f6'}, {key: 'green',hex: '#22c55e'}, {key: 'yellow',hex: '#eab308'}, {key: 'purple',hex: '#a855f7'}, {key: 'pink',hex: '#ec4899'}, {key: 'orange',hex: '#f97316'}, {key: 'teal',hex: '#14b8a6'}, {key: 'gray',hex: '#6b7280'}, {key: 'black',hex: '#1f2937'}];
        const TAGS = ['pvp', 'bedwars', 'skywars', 'anime', 'crystal pvp', 'survival', 'visual'];
        const RESOLUTIONS = ['16x', '32x', '64x', '128x', '256x'];
        const VERSIONS = ['bedrock', 'java'];
        const packsPerPage = 9;
        let packs = [];
        const state = { 
            q: '', colors: new Set(), tags: new Set(), resolutions: new Set(), versions: new Set(), 
            currentPage: 1, 
            modalColor: null, modalTags: new Set(), modalResolution: null, 
            editColor: null, editTags: new Set(), editResolution: null, 
            sortBy: 'latest',
            uploadMode: 'single'
        };
        let currentEditId = null;
        let tempModalTags = new Set();
        let isEditingTags = false;
        let currentUserRole = null;

        /* ====== API & DATA FUNCTIONS ====== */
        async function loadPacksOnStartup() {
            let query = supabase
                .from('packs')
                .select('*')
                .not('tags', 'ilike', '%user-upload%');

            if (state.sortBy === 'downloads') {
                query = query.order('download_count', { ascending: false });
            } else {
                query = query.order('created_at', { ascending: false });
            }
            const { data, error } = await query;
            if (error) {
                console.error('Failed to load packs from Supabase', error);
                packs = [];
            } else {
                packs = data.map(pack => ({ ...pack, tags: pack.tags ? pack.tags.split(',') : [] }));
            }
            render();
        }
        
        async function extractAndUploadIcon(file, fileIndex, userId) {
            try {
                const zip = await JSZip.loadAsync(file);
                const filesInZip = zip.files;
                const prioritizedPaths = ['pack_icon.png', 'pack.png'];
                let iconPath = null;

                for (const path of prioritizedPaths) {
                    if (filesInZip[path]) {
                        iconPath = path;
                        break;
                    }
                }

                if (!iconPath) {
                    iconPath = Object.keys(filesInZip).find(path => 
                        path.toLowerCase().endsWith('pack_icon.png') || 
                        path.toLowerCase().endsWith('pack.png')
                    );
                }
                
                if (iconPath) {
                    const iconFile = filesInZip[iconPath];
                    const iconBlob = await iconFile.async("blob");
                    const iconStoragePath = `pack_icons/${userId}-${Date.now()}-${fileIndex}-icon.png`;
                    const { error: iconError } = await supabase.storage.from("packs").upload(iconStoragePath, iconBlob, { upsert: true });
                    
                    if (iconError) {
                        console.warn(`Icon upload failed for ${file.name}:`, iconError);
                        return null;
                    }
                    
                    return supabase.storage.from("packs").getPublicUrl(iconStoragePath).data.publicUrl;
                }
            } catch(e) {
                 console.warn(`Could not read or process zip file ${file.name}:`, e);
            }
            return null;
        }

        window.handleUpload = async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById("submitBtn");
            const formFieldset = document.getElementById("uploadFormFieldset");
            const fileInput = document.getElementById("fileInput");
            const progressContainer = document.getElementById('upload-progress-container');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const progressText = document.getElementById('progress-text');
            
            const filesToProcess = [...fileInput.files];

            if (state.uploadMode === 'single') {
                if (filesToProcess.length !== 1) return showToast("Please select one file for single upload.", "error");
                if (!state.modalColor) return showToast("You forgot to select a primary color.", "error");
                if (!state.modalResolution) return showToast("You forgot to select a resolution.", "error");
                if (!document.getElementById("packName").value.trim()) return showToast("Pack name is required.", "error");
            } else {
                if (filesToProcess.length === 0) return showToast("Please select files for bulk upload.", "error");
                if (filesToProcess.length > 10) return showToast("Maximum 10 packs allowed for bulk upload.", "error");
            }
            
            submitBtn.disabled = true;
            formFieldset.disabled = true;
            progressContainer.style.display = 'block';
            progressBarFill.style.width = '0%';
            progressText.textContent = 'Preparing upload...';

            try {
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !session) throw new Error("You must be logged in to upload packs.");
                
                const packsToUpload = [];
                const totalFiles = filesToProcess.length;
                let processedCount = 0;

                for (const file of filesToProcess) {
                    processedCount++;
                    progressText.textContent = `[${processedCount}/${totalFiles}] Processing: ${file.name}`;

                    if (!file.name.toLowerCase().match(/\.(mcpack|zip)$/)) {
                        showToast(`Skipping invalid file type: ${file.name}`, "warning");
                        continue;
                    }

                    const iconUrl = await extractAndUploadIcon(file, processedCount - 1, session.user.id);

                    const sanitizedName = file.name.replace(/[^a-zA-Z0-9-._]/g, "").replace(/\s+/g, "-");
                    const packStoragePath = `pack_files/${session.user.id}/${Date.now()}-${processedCount - 1}-${sanitizedName}`;
                    const { error: uploadError } = await supabase.storage.from("packs").upload(packStoragePath, file);
                    if (uploadError) {
                        showToast(`Upload failed for ${file.name}. Skipping.`, 'error');
                        continue;
                    }
                    
                    let packData;
                    if (state.uploadMode === 'single') {
                        packData = {
                            name: document.getElementById("packName").value.trim(),
                            color: state.modalColor,
                            tags: [...state.modalTags],
                            resolution: state.modalResolution,
                            description: document.getElementById("packDescription").value.trim(),
                            version: file.name.toLowerCase().endsWith(".mcpack") ? "bedrock" : "java",
                            filename: packStoragePath,
                            icon_url: iconUrl
                        };
                    } else {
                        packData = {
                            name: file.name.replace(/\.(mcpack|zip)$/i, ""),
                            color: 'none',
                            tags: [],
                            resolution: 'unknown',
                            version: file.name.toLowerCase().endsWith(".mcpack") ? "bedrock" : "java",
                            filename: packStoragePath,
                            icon_url: iconUrl,
                            description: null
                        };
                    }
                    packsToUpload.push(packData);
                    
                    const progress = (processedCount / totalFiles) * 100;
                    progressBarFill.style.width = `${progress}%`;
                }

                if (packsToUpload.length === 0) {
                    throw new Error("No valid packs were uploaded.");
                }

                progressText.textContent = 'Saving metadata to database...';
                const response = await fetch("/api/addpacks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${session.access_token}` },
                    body: JSON.stringify({ packs: packsToUpload, mode: state.uploadMode })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || "Failed to add pack metadata.");
                }

                const result = await response.json();
                await loadPacksOnStartup();
                closeModal();
                showToast(`Successfully uploaded ${result.packs.length} pack${result.packs.length > 1 ? 's' : ''}!`, "success");

            } catch (error) {
                showToast("Upload failed: " + error.message, "error");
            } finally {
                submitBtn.disabled = false;
                formFieldset.disabled = false;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBarFill.style.width = '0%';
                    progressText.textContent = '';
                }, 2000);
            }
        }
        
        window.saveEdit = async function(e) {
            e.preventDefault();
            if (!currentEditId) return;
            try {
                const updates = {
                    name: document.getElementById("editPackName").value.trim(),
                    description: document.getElementById("editPackDescription").value.trim(),
                    color: state.editColor, tags: [...state.editTags].join(","),
                    resolution: state.editResolution
                };
                const { error } = await supabase.from("packs").update(updates).eq("id", currentEditId);
                if (error) throw error;
                showToast("Pack saved successfully!", "success");
                await loadPacksOnStartup();
                closeEditModal();
            } catch (error) { showToast("Save failed: " + error.message, "error"); }
        }

        window.confirmDelete = async function() {
            if (!currentEditId) return;
            const pack = packs.find(p => p.id === currentEditId);
            if (!pack) return cancelDelete();
            try {
                const { data: { session } } = await supabase.auth.getSession();
                const response = await fetch('/api/delete-pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ packId: currentEditId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.details);
                
                showToast('Pack deleted successfully!', 'success');
                await loadPacksOnStartup();
            } catch (error) {
                showToast("Delete failed: " + error.message, "error");
            } finally {
                cancelDelete();
                closeEditModal();
            }
        }

        window.handleDownload = async function(event, packId, filename, packName) {
            event.preventDefault();
            event.stopPropagation();
            try {
                await fetch("/api/increment-download", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: packId })
                });
                const el = document.getElementById(`downloads-${packId}`);
                if (el) el.textContent = (parseInt(el.textContent.replace(/,/g, ''), 10) + 1).toLocaleString();
            } catch (error) { console.error("Failed to update download count:", error); }
            finally {
                const { data } = supabase.storage.from('packs').getPublicUrl(filename);
                fetch(data.publicUrl).then(res => res.blob()).then(blob => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = `${packName}.${filename.split('.').pop()}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
            }
        }

        /* ====== UI RENDERING ====== */
        function render() {
            const grid = document.getElementById('grid');
            const filtered = packs.filter(p => 
                (!state.q || p.name.toLowerCase().includes(state.q)) &&
                (state.colors.size === 0 || state.colors.has(p.color)) &&
                (state.tags.size === 0 || [...state.tags].every(t => (p.tags || []).includes(t))) &&
                (state.resolutions.size === 0 || state.resolutions.has(p.resolution)) &&
                (state.versions.size === 0 || state.versions.has(p.version))
            );

            const startIndex = (state.currentPage - 1) * packsPerPage;
            const packsForPage = filtered.slice(startIndex, startIndex + packsPerPage);

            grid.innerHTML = packsForPage.length === 0 
                ? '<div class="card panel tiny" style="grid-column: 1 / -1;">No packs match your filters.</div>' 
                : packsForPage.map(renderCard).join('');

            renderPagination(filtered.length);
        }

        function renderPagination(totalPacks) {
            const controls = document.getElementById("pagination-controls");
            controls.innerHTML = "";
            const totalPages = Math.ceil(totalPacks / packsPerPage);
            if (totalPages <= 1) return;

            if (state.currentPage > 1) {
                controls.innerHTML += `<button class="pagination-btn" onclick="prevPage()"><i class="fa-solid fa-arrow-left"></i></button>`;
            }
            controls.innerHTML += `<span class="tiny">Page ${state.currentPage} of ${totalPages}</span>`;
            if (state.currentPage < totalPages) {
                controls.innerHTML += `<button class="pagination-btn" onclick="nextPage()"><i class="fa-solid fa-arrow-right"></i></button>`;
            }
        }
        
        function scrollToContentTop() {
            const header = document.querySelector("header");
            const mainContent = document.getElementById("main-content");
            if (!header || !mainContent) return;
            const headerHeight = header.offsetHeight;
            const contentTop = mainContent.offsetTop;
            window.scrollTo({ top: contentTop - headerHeight - 14, behavior: "smooth" });
        }

        window.nextPage = () => { state.currentPage++; scrollToContentTop(); render(); }
        window.prevPage = () => { state.currentPage--; scrollToContentTop(); render(); }

        function renderCard(p) {
            const color = COLORS.find(c => c.key === p.color)?.hex || '#6b7280';
            const thumbContent = p.icon_url 
                ? `<div class="pack-icon-bg" style="background-image: url('${p.icon_url}');"></div><img class="pack-icon" src="${p.icon_url}" alt="${escapeHtml(p.name)} Icon">`
                : `<div class="glyph" style="background:${color}"><i class="fa-solid fa-cube"></i></div>`;
            const thumbBackgroundStyle = p.icon_url ? `background: linear-gradient(135deg,#1f2937,#0f172a);` : `background:linear-gradient(135deg, ${shade(color, -20)}, ${shade(color, 20)})`;
            
            const shareLink = `<a href="#" onclick="copyPackLink(event, ${p.id}, '${escapeHtml(p.name)}'); return false;"><i class="fa-solid fa-share-nodes"></i> Copy Link</a>`;
            const editLink = currentUserRole === 'admin' ? `<a href="#" onclick="openEditModal(${p.id}); event.preventDefault();"><i class="fa-regular fa-pen-to-square"></i> Edit</a>` : '';

            return `
                <div class="card pack" onclick="navigateToPack(event, ${p.id})">
                     <button class="pack-options-btn" onclick="toggleOptionsMenu(event, ${p.id})"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                     <div class="pack-options-menu" id="options-menu-${p.id}">${shareLink}${editLink}</div>
                    <div class="thumb" style="${thumbBackgroundStyle}">
                        ${thumbContent}
                    </div>
                    <div class="content">
                        <div class="pack-stats-top">
                            <div class="stat-item"><i class="fa-solid fa-download"></i><span id="downloads-${p.id}">${(p.download_count || 0).toLocaleString()}</span></div>
                            <div class="stat-item"><i class="fa-solid fa-calendar-day"></i><span>${formatDate(p.created_at)}</span></div>
                        </div>
                        <h4>${escapeHtml(p.name)}</h4>
                        <div class="meta">
                            ${(p.color && p.color !== 'none') ? `<span class="badge">${escapeHtml(p.color)}</span>` : ''}
                            ${(p.resolution && p.resolution !== 'unknown') ? `<span class="badge">${escapeHtml(p.resolution)}</span>` : ''}
                            ${p.version ? `<span class="badge">${escapeHtml(p.version)}</span>` : ''}
                            ${(p.tags||[]).map(t=>`<span class="badge">${escapeHtml(capitalizeFirst(t))}</span>`).join('')}
                        </div>
                    </div>
                </div>`;
        }


        function buildSwatches(container, onSelect, selected) {
            container.innerHTML = COLORS.map(c => `<button type="button" class="swatch${selected && selected.has(c.key) ? ' active' : ''}" style="background:${c.hex}" title="${c.key}" onclick="this.dispatchEvent(new CustomEvent('swatch-select', {bubbles: true, detail: {key: '${c.key}', el: this}}))">${c.icon ? `<i class="${c.icon}"></i>` : ''}</button>`).join('');
            container.addEventListener('swatch-select', e => onSelect(e.detail.key, e.detail.el));
        }
        function buildModalTags(container, selected, filter = '') {
            const filteredTags = TAGS.filter(tag => tag.toLowerCase().includes(filter.toLowerCase()));
            container.innerHTML = filteredTags.length === 0 ? '<div class="tiny" style="grid-column: 1 / -1; text-align: center;">No tags found.</div>'
                : filteredTags.map(tag => `<span class="tag-checkbox${selected.has(tag) ? ' selected' : ''}" onclick="this.dispatchEvent(new CustomEvent('tag-select', {bubbles: true, detail: {key: '${tag}', el: this}}))">${capitalizeFirst(tag)}</span>`).join('');
            container.addEventListener('tag-select', e => { toggleSet(tempModalTags, e.detail.key); e.detail.el.classList.toggle('selected'); });
        }
        function buildSidebarTags(container, onSelect, selected) {
            container.innerHTML = TAGS.map(tag => `<button type="button" class="tag${selected?.has(tag) ? ' active' : ''}" onclick="this.dispatchEvent(new CustomEvent('sidebar-tag-select', {bubbles: true, detail: {key: '${tag}', el: this}}))">${capitalizeFirst(tag)}</button>`).join('');
            container.addEventListener('sidebar-tag-select', e => { onSelect(e.detail.key, e.detail.el.classList.toggle('active')); render(); });
        }
        function buildSelectorBoxes(container, onSelect, selected, options) {
            container.innerHTML = options.map(opt => `<button type="button" class="res-box${(selected instanceof Set ? selected.has(opt) : selected === opt) ? ' active' : ''}" onclick="this.dispatchEvent(new CustomEvent('box-select', {bubbles: true, detail: {key: '${opt}', el: this}}))">${opt}</button>`).join('');
            container.addEventListener('box-select', e => onSelect(e.detail.key, e.detail.el));
        }

        window.openModal = function() {
            document.getElementById("backdrop").style.display = "flex";
            setUploadMode('single');
            document.getElementById("uploadForm").reset();
            document.getElementById("fileInput").removeAttribute('multiple');
            document.getElementById("fileHint").textContent = '.mcpack or .zip files only';
            
            state.modalColor = null; state.modalResolution = null; state.modalTags.clear();
            buildSwatches(document.getElementById("modalSwatches"), (key, el) => { state.modalColor = key; highlightOne(el.parentElement, el); }, null);
            buildSelectorBoxes(document.getElementById("modalResolutions"), (key, el) => { state.modalResolution = key; highlightOne(el.parentElement, el); }, null, RESOLUTIONS);
            updateTagButtonText();
        }
        window.closeModal = function() { 
            document.getElementById("backdrop").style.display = "none"; 
            document.getElementById("uploadForm").reset(); 
            document.getElementById("fileInput").removeAttribute('multiple');
            document.getElementById("pack-file-area").classList.remove('bulk-mode');
            document.getElementById("fileHint").textContent = '.mcpack or .zip files only';
            document.getElementById("bulk-file-list").innerHTML = '';
        }
        
        window.setUploadMode = function(mode) {
            state.uploadMode = mode;
            document.getElementById('upload-mode-switcher').setAttribute('data-active', mode);
            
            document.querySelectorAll('#upload-mode-switcher .mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#upload-mode-switcher button[data-mode="${mode}"]`).classList.add('active');
            
            const singleFields = document.getElementById('single-mode-fields');
            const bulkFields = document.getElementById('bulk-mode-fields');
            const fileInput = document.getElementById('fileInput');
            const fileArea = document.getElementById('pack-file-area');
            const subtitle = document.getElementById('modal-subtitle');
            
            fileInput.value = ''; // Clear file selection
            document.getElementById("fileHint").textContent = mode === 'single' ? '.mcpack or .zip files only' : 'Select up to 10 .mcpack or .zip files';
            document.getElementById("bulk-file-list").innerHTML = '';

            if (mode === 'single') {
                singleFields.style.display = 'grid';
                bulkFields.style.display = 'none';
                fileInput.removeAttribute('multiple');
                fileArea.classList.remove('bulk-mode');
                document.getElementById('packName').setAttribute('required', 'true');
                subtitle.textContent = 'Select a .mcpack or .zip file, set a name, choose color & tags.';
            } else {
                singleFields.style.display = 'none';
                bulkFields.style.display = 'flex';
                fileInput.setAttribute('multiple', 'multiple');
                fileArea.classList.add('bulk-mode');
                document.getElementById('packName').removeAttribute('required');
                subtitle.textContent = 'Upload up to 10 packs. Name, icon, and basic details will be auto-detected, ready for later editing.';
            }
        }

        window.openTagModal = () => openTagEditor(false);
        window.openEditTagModal = () => openTagEditor(true);
        function openTagEditor(isEditMode) {
            isEditingTags = isEditMode;
            tempModalTags = new Set(isEditMode ? state.editTags : state.modalTags);
            const searchInput = document.getElementById("tagSearchInput");
            searchInput.value = "";
            const body = document.querySelector("#tagSelectModal .modal-body");
            const update = () => buildModalTags(body, tempModalTags, searchInput.value);
            searchInput.oninput = update;
            update();
            document.getElementById("tag-select-backdrop").style.display = "flex";
        }
        window.closeTagModal = function(save) {
            if (save) {
                if (isEditingTags) { state.editTags = new Set(tempModalTags); updateEditTagButtonText(); } 
                else { state.modalTags = new Set(tempModalTags); updateTagButtonText(); }
            }
            document.getElementById("tag-select-backdrop").style.display = "none";
        };
        window.openEditModal = function(id) {
            const pack = packs.find(p => p.id == id); // Use loose equality here
            if (!pack) {
                showToast("Pack not found for editing.", "error");
                return;
            }
            currentEditId = id;
            document.getElementById("editId").value = id;
            document.getElementById("editPackName").value = pack.name || "";
            document.getElementById("editPackDescription").value = pack.description || "";
            state.editColor = pack.color || null;
            state.editTags = new Set(pack.tags || []);
            state.editResolution = pack.resolution || null;
            buildSwatches(document.getElementById("editModalSwatches"), (k, el) => { state.editColor = k; highlightOne(el.parentElement, el); }, new Set([state.editColor]));
            buildSelectorBoxes(document.getElementById("editModalResolutions"), (k, el) => { state.editResolution = k; highlightOne(el.parentElement, el); }, state.editResolution, RESOLUTIONS);
            updateEditTagButtonText();
            document.getElementById("editBackdrop").style.display = "flex";
        };
        window.closeEditModal = function() { currentEditId = null; document.getElementById("editBackdrop").style.display = "none"; };
        window.promptDelete = function() { if(currentEditId) document.getElementById("confirmDeleteBackdrop").style.display = "flex"; };
        window.cancelDelete = function() { document.getElementById("confirmDeleteBackdrop").style.display = "none"; };
        
        function applySearch(query) {
            state.currentPage = 1; 
            state.q = query.trim().toLowerCase(); 
            render();
        }
        window.applyFilters = () => applySearch(document.getElementById("q").value);
        window.applyMobileSearch = () => applySearch(document.getElementById("mobile-q").value);

        function clearSearchInput() {
            document.getElementById("q").value = "";
            document.getElementById("mobile-q").value = "";
        }
        window.clearSearch = () => { clearSearchInput(); applyFilters(); };
        window.clearMobileSearch = () => { clearSearchInput(); applyMobileSearch(); };

        window.clearColors = () => { state.colors.clear(); buildSwatches(document.getElementById("colorSwatches"), (k, el) => { toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors); render(); };
        window.clearTags = () => { state.tags.clear(); buildSidebarTags(document.getElementById("tagCloud"), (k, el) => { toggleSet(state.tags, k); el.classList.toggle('active'); render(); }, state.tags); render(); };
        window.clearResolutions = () => { state.resolutions.clear(); buildSelectorBoxes(document.getElementById("resolutionBoxes"), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions, RESOLUTIONS); render(); };
        window.clearVersions = () => { state.versions.clear(); buildSelectorBoxes(document.getElementById("versionBoxes"), (v, el) => { toggleSet(state.versions, v); el.classList.toggle('active'); render(); }, state.versions, VERSIONS); render(); };
        window.resetAll = () => { state.q = ''; state.currentPage = 1; clearSearchInput(); clearColors(); clearTags(); clearResolutions(); clearVersions(); };
        
        window.hintFile = () => {
            const fileInput = document.getElementById("fileInput");
            const files = [...fileInput.files];
            
            if (state.uploadMode === 'single') {
                const file = files[0];
                if (file) {
                    document.getElementById("fileHint").textContent = file.name;
                    document.getElementById("packName").value = file.name.replace(/\.(mcpack|zip)$/i, "");
                }
            } else {
                const bulkList = document.getElementById("bulk-file-list");
                if (files.length > 0) {
                    bulkList.innerHTML = `<ul class="tiny" style="list-style:disc; margin-left: 1.5rem; color: var(--text);">${files.slice(0, 10).map(f => `<li>${f.name}</li>`).join('')}</ul>`;
                    if (files.length > 10) {
                        showToast(`Warning: Only the first 10 files will be uploaded.`, "warning");
                    }
                    document.getElementById("fileHint").textContent = `${files.length} file${files.length > 1 ? 's' : ''} selected.`;
                } else {
                    document.getElementById("fileHint").textContent = 'Select up to 10 .mcpack or .zip files';
                    bulkList.innerHTML = '';
                }
            }
        };
        window.toggleOptionsMenu = (e, id) => {
            e.preventDefault();
            e.stopPropagation();
            const menu = document.getElementById(`options-menu-${id}`);
            const isVisible = menu.style.display === 'block';
            document.querySelectorAll(".pack-options-menu").forEach(m => m.style.display = 'none');
            document.querySelectorAll(".share-submenu").forEach(m => m.classList.remove('show'));
            if (!isVisible) menu.style.display = 'block';
        };
        
        window.toggleShareMenu = (e, id) => {
            e.preventDefault();
            e.stopPropagation();
            const shareMenu = document.getElementById(`share-menu-${id}`);
            document.querySelectorAll(".share-submenu").forEach(m => {
                if (m.id !== `share-menu-${id}`) m.classList.remove('show');
            });
            shareMenu.classList.toggle('show');
        };
        
        window.copyPackLink = async (e, id, name) => {
            e.preventDefault();
            e.stopPropagation();
            const link = `${window.location.origin}/packs.html?id=${id}`;
            try {
                await navigator.clipboard.writeText(link);
                showToast(`Link copied to clipboard!`, "success");
            } catch (err) {
                showToast("Failed to copy link", "error");
            }
        };
        
        window.navigateToPack = function(event, packId) {
            if (event.target.closest('.pack-options-btn') || event.target.closest('.pack-options-menu')) {
                return;
            }
            window.location.href = `/packs.html?id=${packId}`;
        }
        
        window.toggleSortMenu = (isMobile = false) => {
            const menu = document.getElementById(isMobile ? "mobileSortMenu" : "sortMenu");
            const container = document.getElementById(isMobile ? "mobileSortContainer" : "sortContainer");
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            container.classList.toggle('open');
        };
        
        window.setSort = (sortBy, el, isMobile = false) => {
            event.preventDefault();
            state.sortBy = sortBy; state.currentPage = 1;
            
            document.getElementById("currentSort").textContent = el.textContent;
            document.getElementById("mobileCurrentSort").textContent = el.textContent;
            
            document.querySelectorAll("#sortMenu a, #mobileSortMenu a").forEach(a => a.classList.remove('active'));
            document.querySelector(`#sortMenu a[onclick*="'${sortBy}'"]`).classList.add('active');
            document.querySelector(`#mobileSortMenu a[onclick*="'${sortBy}'"]`).classList.add('active');

            toggleSortMenu(isMobile);
            loadPacksOnStartup();
        };

        function updateTagButtonText() {
            const btnText = document.getElementById("tagSelectorBtnText");
            const count = state.modalTags.size;
            btnText.textContent = count === 0 ? "Select Tags" : `${count} Tag${count > 1 ? 's' : ''} Selected`;
        }
        function updateEditTagButtonText() {
            const btnText = document.getElementById("editTagSelectorBtnText");
            const count = state.editTags.size;
            btnText.textContent = count === 0 ? "Select Tags" : `${count} Tag${count > 1 ? 's' : ''} Selected`;
        }

        function capitalizeFirst(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : ""; }
        function showToast(message, type = "error") {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${escapeHtml(message)}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        function formatDate(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `${d.getDate()}/${d.getMonth() + 1}/${String(d.getFullYear()).slice(-2)}`;
        }
        function escapeHtml(str) { return String(str || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
        function shade(color, percent) {
            let f = parseInt(color.slice(1), 16), t = percent < 0 ? 0 : 255, p = percent < 0 ? percent * -1 : percent, R = f >> 16, G = f >> 8 & 0x00FF, B = f & 0x0000FF;
            return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1);
        }
        function highlightOne(parent, el) { [...parent.children].forEach(c => c.classList.remove('active')); el.classList.add('active'); }
        function toggleSet(set, item) { set.has(item) ? set.delete(item) : set.add(item); }

        /* ====== INITIALIZATION ====== */
        async function checkUserAndInitialize() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                if (profile) currentUserRole = profile.role;
            }
            if (currentUserRole === 'admin') { 
                document.getElementById('admin-actions').style.display = 'block'; 
                document.querySelector('#mobile-filters-panel #admin-actions').style.display = 'block';
            }
            await loadPacksOnStartup();
        }

        function init() {
            if (document.getElementById('grid')) {
                const mobileFilterPanel = document.getElementById('mobile-filters-panel');
                const desktopSidebar = document.querySelector('.sidebar');
                mobileFilterPanel.innerHTML = desktopSidebar.innerHTML;
                
                const filterAreas = [
                    { container: desktopSidebar, isMobile: false },
                    { container: mobileFilterPanel, isMobile: true }
                ];
                
                filterAreas.forEach(area => {
                    buildSwatches(area.container.querySelector('#colorSwatches'), (k, el) => { toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors);
                    buildSidebarTags(area.container.querySelector('#tagCloud'), (k, el) => { toggleSet(state.tags, k); render(); }, state.tags);
                    buildSelectorBoxes(area.container.querySelector('#resolutionBoxes'), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions, RESOLUTIONS);
                    buildSelectorBoxes(area.container.querySelector('#versionBoxes'), (v, el) => { toggleSet(state.versions, v); el.classList.toggle('active'); render(); }, state.versions, VERSIONS);
                });
                
                const mobileFilterBtn = document.getElementById('mobile-filter-btn');
                mobileFilterBtn.addEventListener('click', () => {
                    const panel = document.getElementById('mobile-filters-panel');
                    panel.classList.toggle('show');
                    const isShown = panel.classList.contains('show');
                    mobileFilterBtn.innerHTML = isShown ? '<i class="fa-solid fa-xmark"></i> Close Filters' : '<i class="fa-solid fa-sliders"></i> Choose Filters';
                });

                window.addEventListener('click', (e) => {
                    if (!e.target.closest('.pack-options-btn')) {
                        document.querySelectorAll('.pack-options-menu').forEach(menu => menu.style.display = 'none');
                    }
                    if (!e.target.closest('#sortContainer')) {
                        document.getElementById('sortMenu').style.display = 'none';
                        document.getElementById('sortContainer').classList.remove('open');
                    }
                     if (!e.target.closest('#mobileSortContainer')) {
                        document.getElementById('mobileSortMenu').style.display = 'none';
                        document.getElementById('mobileSortContainer').classList.remove('open');
                    }
                });
                
                checkUserAndInitialize();
            }
        }
        init();

        // ====== DESKTOP NAVBAR SCRIPT ======
        document.addEventListener('auth-ready', () => {
            const isDesktop = window.innerWidth >= 1024;
            if (!isDesktop) return;

            const navActions = document.getElementById('nav-actions');
            const desktopNavLinks = document.getElementById('desktop-nav-links');
            const desktopAuth = document.getElementById('desktop-auth-actions');

            navActions.querySelectorAll('.nav-link-item').forEach(linkOrContainer => {
                if (linkOrContainer.classList.contains('tools-dropdown-container')) {
                     desktopNavLinks.appendChild(linkOrContainer);
                } else if (linkOrContainer.tagName.toLowerCase() === 'a') {
                    desktopNavLinks.appendChild(linkOrContainer);
                }
            });

            desktopNavLinks.querySelectorAll('a, button.nav-link').forEach(link => {
                if(link.tagName.toLowerCase() === 'a') {
                    link.className = 'nav-link';
                    const linkPath = link.getAttribute('href');
                    const currentPath = window.location.pathname;
                    if (linkPath === currentPath || (currentPath === '/texturepacks.html' && linkPath === '/texturepacks.html')) {
                        link.classList.add('active');
                    }
                }
            });

            const loginBtn = navActions.querySelector('.login-btn-item');
            const signupBtn = navActions.querySelector('.signup-btn-item');
            const userDropdown = navActions.querySelector('.user-dropdown');
            const notificationBtn = navActions.querySelector('.notification-toggle-btn');
            
            if(notificationBtn) desktopAuth.appendChild(notificationBtn);

            if (userDropdown) {
                desktopAuth.appendChild(userDropdown);
            } else {
                if (loginBtn) {
                    loginBtn.className = 'login-btn';
                    desktopAuth.appendChild(loginBtn);
                }
                if (signupBtn) {
                    signupBtn.className = 'signup-btn';
                    desktopAuth.appendChild(signupBtn);
                }
            }
        });

        // ====== SEARCH MODAL SCRIPT (DESKTOP & MOBILE) ======
        let modalSearchType = 'packs';
        
        function initSearchModal() {
            const desktopSearchInput = document.querySelector('.desktop-search-container input');
            const mobileSearchToggle = document.getElementById('mobile-search-toggle');
            const searchModal = document.getElementById('desktop-search-modal');
            const closeModalBtn = document.getElementById('close-search-modal-btn');
            
            function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s])); }

        async function loadNewPackSuggestions() {
            const container = document.getElementById('modal-pack-suggestions');
            if (!container) return;
            container.innerHTML = '<div class="loading" style="grid-column: 1 / -1; padding: 1rem 0;"></div>';
            try {
                const { data, error } = await supabase.from('packs').select('id, name, icon_url').order('created_at', { ascending: false }).limit(4);
                if (error) throw error;
                if (data && data.length > 0) {
                    container.innerHTML = data.map(pack => {
                        const iconContent = pack.icon_url 
                            ? `<img class="pack-icon" src="${pack.icon_url}" alt="${escapeHtml(pack.name)} Icon">`
                            : `<div class="pack-icon" style="background:var(--bg-2); display:grid; place-items:center;"><i class="fa-solid fa-cube"></i></div>`;
                        return `<a href="/packs.html?id=${pack.id}" class="suggestion-card">${iconContent}<div><div class="search-result-name">${escapeHtml(pack.name)}</div></div></a>`;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="tiny">No new packs to suggest.</p>';
                }
            } catch (err) {
                container.innerHTML = '<p class="tiny">Could not load suggestions.</p>';
            }
        }

        function openSearchModal() {
            if (searchModal) {
                searchModal.classList.add('show');
                document.body.style.overflow = 'hidden';
                loadNewPackSuggestions();
                document.getElementById('modal-universal-search').focus();
            }
        }

        function closeSearchModal() {
            if (searchModal) {
                searchModal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

            if (desktopSearchInput) desktopSearchInput.addEventListener('click', (e) => { e.preventDefault(); openSearchModal(); });
            if (mobileSearchToggle) mobileSearchToggle.addEventListener('click', openSearchModal);
            if(closeModalBtn) closeModalBtn.addEventListener('click', closeSearchModal);
            if(searchModal) searchModal.addEventListener('click', (e) => { if (e.target === searchModal) closeSearchModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && searchModal.classList.contains('show')) closeSearchModal(); });

        async function performModalSearch() {
            const query = document.getElementById('modal-universal-search').value.trim();
            const resultsContainer = document.getElementById('modal-search-results');
            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            let results = [];
            if (modalSearchType === 'packs') {
                const { data } = await supabase.from('packs').select('id, name, icon_url').ilike('name', `%${query}%`).limit(5);
                results = (data || []).map(item => ({ type: 'pack', name: item.name, icon: item.icon_url, link: `/packs.html?id=${item.id}` }));
            } else if (modalSearchType === 'users') {
                const { data } = await supabase.from('profiles').select('username, avatar_url').ilike('username', `%${query}%`).limit(5);
                results = (data || []).map(item => ({ type: 'user', name: item.username, icon: item.avatar_url, link: `/profile.html?user=${item.username}` }));
            } else if (modalSearchType === 'gamertags') {
                const { data } = await supabase.from('profiles').select('username, bedrock_gamertag, xuid').ilike('bedrock_gamertag', `%${query}%`).limit(5);
                results = (data || []).map(item => ({ type: 'gamertag', name: item.bedrock_gamertag, sub: item.username, xuid: item.xuid, link: `/profile.html?user=${item.username}` }));
            }
            renderModalSearchResults(results);
        }

        function renderModalSearchResults(results) {
            const container = document.getElementById('modal-search-results');
            if (results.length === 0) {
                container.innerHTML = `<div class="search-result-item"><div class="search-result-info"><div class="search-result-name">No results found</div></div></div>`;
            } else {
                container.innerHTML = results.map(item => {
                    let iconHtml = '';
                    if (item.type === 'pack') {
                        iconHtml = item.icon 
                            ? `<img src="${item.icon}" class="search-result-icon">`
                            : `<div class="search-result-icon" style="background:var(--bg-2); display:grid; place-items:center;"><i class="fa-solid fa-cube"></i></div>`;
                    } else if (item.type === 'gamertag' && item.xuid) {
                        iconHtml = `<img src="/api/bedrock-skin?xuid=${item.xuid}&render_type=head" class="search-result-avatar is-mc-skin">`;
                    } else {
                        const initial = (item.name || '?').charAt(0).toUpperCase();
                        iconHtml = `<img src="${item.icon || `https://placehold.co/40x40/1c1c1c/de212a?text=${initial}`}" class="search-result-avatar">`;
                    }
                    return `<a href="${item.link}" class="search-result-item">${iconHtml}<div class="search-result-info"><div class="search-result-name">${escapeHtml(item.name)}</div>${item.sub ? `<div class="search-result-sub">MCHub User: ${escapeHtml(item.sub)}</div>` : ''}</div></a>`;
                }).join('');
            }
            container.style.display = 'block';
        }

        const modalDropdown = document.getElementById('modal-search-type-dropdown');
        const modalSearchTypeBtn = document.getElementById('modal-search-type-btn');
        const modalSearchTypeMenu = document.getElementById('modal-search-type-menu');
        const modalSearchTypeLabel = document.getElementById('modal-search-type-label');
        const modalSearchInput = document.getElementById('modal-universal-search');
        let modalDebounceTimer;

        if(modalSearchTypeBtn) {
            modalSearchTypeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                modalDropdown.classList.toggle('open');
            });
        }
        if(modalSearchTypeMenu) {
            modalSearchTypeMenu.querySelectorAll('.search-type-option').forEach(option => {
                option.addEventListener('click', () => {
                    modalSearchType = option.dataset.type;
                    modalSearchTypeLabel.textContent = option.textContent.trim();
                    modalSearchInput.placeholder = `Search for ${modalSearchType}...`;
                    modalDropdown.classList.remove('open');
                    performModalSearch();
                });
            });
        }

        if(modalSearchInput) {
            modalSearchInput.addEventListener('input', () => {
                clearTimeout(modalDebounceTimer);
                modalDebounceTimer = setTimeout(performModalSearch, 300);
            });
        }
            window.addEventListener('click', (e) => {
                if (modalDropdown && !e.target.closest('#modal-search-type-dropdown')) {
                    modalDropdown.classList.remove('open');
                }
            });
        }
        
        // Initialize search modal when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSearchModal);
        } else {
            initSearchModal();
        }

        // ====== NOTIFICATION SCRIPT ======
        let currentUserId = null;
        let notificationSubscription = null;

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000); let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago"; interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago"; return "just now";
        }

        async function fetchAndRenderNotifications() {
            if (!currentUserId) return;
            
            const { data, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUserId)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) {
                console.error("Error fetching notifications:", error);
                return;
            }

            const list = document.getElementById('notification-list');
            const badgeDesktop = document.getElementById('notification-badge');
            const badgeMobile = document.getElementById('notification-badge-mobile');
            let unreadCount = 0;

            if (data.length === 0) {
                list.innerHTML = '<div class="notification-list-empty"><div class="empty-icon"><i class="fa-solid fa-bell-slash"></i></div><p>All caught up!</p></div>';
            } else {
                list.innerHTML = data.map(n => {
                    if (!n.is_read) unreadCount++;
                    const iconMap = {
                        'new_news': 'fa-solid fa-newspaper',
                        'new_pack': 'fa-solid fa-box',
                        'comment_reply': 'fa-solid fa-comment-dots'
                    };
                    
                    let iconHtml = '';
                    if (n.type === 'new_pack' && n.content.pack_icon) {
                        iconHtml = `<img src="${n.content.pack_icon}" class="notification-icon" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;" alt="Pack icon">`;
                    } else {
                        iconHtml = `<i class="${iconMap[n.type] || 'fa-solid fa-bell'} notification-icon"></i>`;
                    }
                    
                    return `
                        <div class="notification-item ${n.is_read ? 'read' : ''}" id="notification-${n.id}">
                            ${iconHtml}
                            <a href="${n.content.link}" class="notification-content">
                                <p>${escapeHtml(n.content.text)}</p>
                                <span class="time">${timeAgo(n.created_at)}</span>
                            </a>
                            <button class="dismiss-notification-btn" data-id="${n.id}">&times;</button>
                        </div>`;
                }).join('');
            }
            
            const badges = [badgeDesktop, badgeMobile];
            badges.forEach(badge => {
                if (badge) {
                    badge.style.display = unreadCount > 0 ? 'block' : 'none';
                }
            });
        }

        async function markOneAsRead(notificationId) {
            const { error } = await supabase.from('notifications').update({ is_read: true }).eq('id', notificationId);
            if (!error) {
                const item = document.getElementById(`notification-${notificationId}`);
                if (item && !item.classList.contains('read')) {
                    item.classList.add('read');
                    const badges = document.querySelectorAll('.notification-badge');
                    let currentCount = parseInt(badges[0]?.textContent) || 0;
                    if (currentCount > 0) {
                        badges.forEach(b => {
                            if (currentCount - 1 <= 0) b.style.display = 'none';
                        });
                    }
                }
            }
        }

        function setupNotificationListeners() {
            const backdrop = document.getElementById('notification-backdrop');
            
            document.addEventListener('click', (e) => {
                if (e.target.closest('.notification-toggle-btn')) {
                    backdrop.classList.add('show');
                } 
                else if (e.target.id === 'close-notifications-btn' || e.target.id === 'notification-backdrop') {
                    backdrop.classList.remove('show');
                }
                else if (e.target.id === 'mark-all-read-btn') {
                    supabase.from('notifications').update({ is_read: true }).eq('user_id', currentUserId).then(fetchAndRenderNotifications);
                }
                else if (e.target.id === 'clear-all-btn') {
                    supabase.from('notifications').delete().eq('user_id', currentUserId).then(fetchAndRenderNotifications);
                }
                else if (e.target.classList.contains('dismiss-notification-btn')) {
                    markOneAsRead(e.target.dataset.id);
                }
                else if (e.target.closest('.notification-content a')) {
                    const notificationItem = e.target.closest('.notification-item');
                    const notificationId = notificationItem.id.split('-')[1];
                    if (!notificationItem.classList.contains('read')) {
                        markOneAsRead(notificationId);
                    }
                    backdrop.classList.remove('show');
                }
            });
        }

        function createNotificationSubscription() {
            if (notificationSubscription) supabase.removeChannel(notificationSubscription);

            notificationSubscription = supabase.channel(`public:notifications:user_id=eq.${currentUserId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, payload => {
                    fetchAndRenderNotifications();
                }).subscribe();
        }

        document.addEventListener('auth-ready', (event) => {
            const { user } = event.detail;
            if (user) {
                currentUserId = user.id;
                fetchAndRenderNotifications();
                createNotificationSubscription();
                setupNotificationListeners();
            } else {
                currentUserId = null;
                if (notificationSubscription) supabase.removeChannel(notificationSubscription);
            }
        });
    </script>
</body>

</html>
