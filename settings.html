<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - MCHub</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" defer></script>

    <!-- Styles -->
    <style>
        :root {
            --bg-0: #000; --bg-1: #1c1c1c; --bg-2: #2c2c2c;
            --muted: #a8b3cf; --text: #e8eefc; --border: rgba(255,255,255,.12);
            --brand-1: #de212a; --brand-2: #b21a22; --shadow-brand: 0 12px 30px rgba(222,33,42,.22);
            --border-strong: rgba(255,255,255,.2);
            --success: #10B981; --warning: #f59e0b; --error: #ef4444;
        }
        * { box-sizing: border-box; margin:0; padding:0; }
        body { 
            font-family: 'Inter', sans-serif; font-weight: 500; line-height:1.6; 
            background-color: var(--bg-0); color: var(--text); min-height:100vh;
        }
        body::before {
            content:""; position:fixed; top:0; left:0; width:100vw; height:100vh;
            background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg');
            background-size: cover; filter: blur(8px); opacity:0.2; z-index:-1;
        }
        a { color:inherit; text-decoration:none; }

        /* Header */
        header { position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(10px); background: rgba(12,12,12,0.75); border-bottom:1px solid var(--border); }
        .nav { max-width:1100px; margin:0 auto; padding:12px 18px; display:flex; justify-content:space-between; align-items:center; }
        .brand { display:flex; gap:.8rem; align-items:center; }
        .brand-badge { width:40px; height:40px; display:grid; place-items:center; border-radius:10px; background: linear-gradient(135deg,var(--brand-2),var(--brand-1)); box-shadow: var(--shadow-brand);}
        .brand-icon-custom { width:100%; height:100%; object-fit:contain; padding:4px; transform: translateY(-11px);}
        .brand-title { font-weight:800; font-size:15px; letter-spacing:.6px; }
        .tiny { font-size:11px; color: var(--muted);}
        .nav-actions { display:flex; align-items:center; gap:.6rem; }
    </style>
</head>
<body>

<header>
    <nav class="nav">
        <a class="brand" href="/">
            <div class="brand-badge">
                <img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" class="brand-icon-custom" alt="MCHub Icon">
            </div>
            <div>
                <div class="brand-title">MCHUB</div>
                <div class="tiny">Minecraft Bedrock â€¢ Community</div>
            </div>
        </a>
        <div class="nav-actions" id="nav-actions">
            <!-- User actions / login buttons will be injected here -->
        </div>
    </nav>
</header>
<main style="max-width:900px;margin:2rem auto;padding:0 1rem;">

    <!-- Account Info Section -->
    <section style="background:var(--bg-1); padding:1.5rem; border-radius:12px; margin-bottom:1.5rem;">
        <h2 style="margin-bottom:1rem;">Account Settings</h2>

        <!-- Username -->
        <div style="margin-bottom:1rem;">
            <label for="username" style="display:block; margin-bottom:.4rem;">Username</label>
            <input type="text" id="username" placeholder="Enter username" style="width:100%; padding:.6rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-2); color:var(--text);">
        </div>

        <!-- Email -->
        <div style="margin-bottom:1rem;">
            <label for="email" style="display:block; margin-bottom:.4rem;">Email</label>
            <input type="email" id="email" placeholder="Enter email" style="width:100%; padding:.6rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-2); color:var(--text);">
        </div>

        <!-- Password -->
        <div style="margin-bottom:1rem;">
            <label for="password" style="display:block; margin-bottom:.4rem;">Password</label>
            <input type="password" id="password" placeholder="New password" style="width:100%; padding:.6rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-2); color:var(--text);">
        </div>

        <!-- Save Button -->
        <button id="save-settings" style="padding:.6rem 1.2rem; background:var(--brand-1); color:#fff; border:none; border-radius:6px; cursor:pointer;">Save Changes</button>

        <!-- Feedback message -->
        <div id="settings-feedback" style="margin-top:.8rem; font-size:14px;"></div>
    </section>

    <!-- Security / API Validation Modal -->
    <div id="security-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); display:grid; place-items:center; z-index:100;">
        <div style="background:var(--bg-1); padding:1.5rem; border-radius:12px; max-width:400px; width:100%; text-align:center;">
            <h3 style="margin-bottom:1rem;">Security Validation Failed</h3>
            <p style="margin-bottom:1rem;">Your session is invalid, or the same account is already logged in elsewhere. Please re-login to continue.</p>
            <button id="modal-relogin" style="padding:.6rem 1.2rem; background:var(--brand-1); color:#fff; border:none; border-radius:6px; cursor:pointer;">Re-login</button>
        </div>
    </div>

</main>

<script>
    // Mock API call to check session / personal API validation
    async function validateSession() {
        try {
            // Simulate API request
            let response = await fetch('/api/validate-session');
            let data = await response.json();

            if (!data.valid) {
                // If session invalid or same account login
                document.getElementById('security-modal').style.display = 'grid';
            }
        } catch (err) {
            console.error("Validation error:", err);
            document.getElementById('settings-feedback').textContent = "Error validating session. Try again later.";
            document.getElementById('settings-feedback').style.color = "var(--error)";
        }
    }

    // Save settings handler
    document.getElementById('save-settings').addEventListener('click', async () => {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!username || !email) {
            document.getElementById('settings-feedback').textContent = "Username and email cannot be empty.";
            document.getElementById('settings-feedback').style.color = "var(--warning)";
            return;
        }

        try {
            let res = await fetch('/api/update-settings', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({username,email,password})
            });
            let result = await res.json();

            if (result.success) {
                document.getElementById('settings-feedback').textContent = "Settings saved successfully!";
                document.getElementById('settings-feedback').style.color = "var(--success)";
            } else {
                document.getElementById('settings-feedback').textContent = result.error || "Failed to save settings.";
                document.getElementById('settings-feedback').style.color = "var(--error)";
                if(result.errorCode === "SESSION_INVALID") {
                    document.getElementById('security-modal').style.display = 'grid';
                }
            }
        } catch (err) {
            console.error(err);
            document.getElementById('settings-feedback').textContent = "Server error. Try again later.";
            document.getElementById('settings-feedback').style.color = "var(--error)";
        }
    });

    // Modal re-login
    document.getElementById('modal-relogin').addEventListener('click', () => {
        window.location.href = '/login';
    });

    // Run validation on page load
    validateSession();
</script>
<section style="background:var(--bg-1); padding:1.5rem; border-radius:12px; margin-bottom:2rem;">
    <h2 style="margin-bottom:1rem;">Security Settings</h2>

    <!-- Two-factor toggle -->
    <div style="margin-bottom:1rem;">
        <label style="display:flex; align-items:center; justify-content:space-between;">
            <span>Enable Two-Factor Authentication (2FA)</span>
            <input type="checkbox" id="2fa-toggle">
        </label>
    </div>

    <!-- API Key Reset -->
    <div style="margin-bottom:1rem;">
        <label style="display:flex; align-items:center; justify-content:space-between;">
            <span>Reset API Key</span>
            <button id="reset-api" style="padding:.4rem .8rem; background:var(--brand-1); color:#fff; border:none; border-radius:4px; cursor:pointer;">Reset</button>
        </label>
    </div>

    <div id="security-feedback" style="margin-top:.8rem; font-size:14px;"></div>
</section>

<script>
    // Toggle 2FA
    document.getElementById('2fa-toggle').addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        try {
            const res = await fetch('/api/toggle-2fa', {
                method: 'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({enabled})
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById('security-feedback').textContent = enabled ? "2FA enabled" : "2FA disabled";
                document.getElementById('security-feedback').style.color = "var(--success)";
            } else {
                document.getElementById('security-feedback').textContent = data.error || "Failed to update 2FA";
                document.getElementById('security-feedback').style.color = "var(--error)";
                e.target.checked = !enabled; // revert
            }
        } catch(err) {
            console.error(err);
            document.getElementById('security-feedback').textContent = "Server error. Try again.";
            document.getElementById('security-feedback').style.color = "var(--error)";
            e.target.checked = !enabled; // revert
        }
    });

    // Reset API Key
    document.getElementById('reset-api').addEventListener('click', async () => {
        if(!confirm("Are you sure you want to reset your API key? This will invalidate old keys.")) return;
        try {
            const res = await fetch('/api/reset-api', {method:'POST'});
            const data = await res.json();
            if(data.success) {
                document.getElementById('security-feedback').textContent = "API key reset successfully!";
                document.getElementById('security-feedback').style.color = "var(--success)";
            } else {
                document.getElementById('security-feedback').textContent = data.error || "Failed to reset API key.";
                document.getElementById('security-feedback').style.color = "var(--error)";
            }
        } catch(err) {
            console.error(err);
            document.getElementById('security-feedback').textContent = "Server error. Try again.";
            document.getElementById('security-feedback').style.color = "var(--error)";
        }
    });
</script>
