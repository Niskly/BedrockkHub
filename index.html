<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BedrockHub — Texture Packs (IndexedDB + Edit)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg-0:#060910;--bg-1:#0a0f1a;--bg-2:#0e1524;--muted:#a8b3cf;--text:#e8eefc;--border:rgba(255,255,255,.08);
      --brand-1:#7c3aed;--brand-2:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(124,58,237,.18),transparent),radial-gradient(1200px 800px at 90% 10%,rgba(37,99,235,.18),transparent),linear-gradient(180deg,var(--bg-1),var(--bg-0) 40%,var(--bg-1));color:var(--text);font:500 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial}
    a{color:inherit;text-decoration:none}

    /* NAV */
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(10px);background:linear-gradient(90deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-bottom:1px solid var(--border)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:.8rem}
    .brand-badge{height:44px;width:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-2),var(--brand-1));box-shadow:0 12px 30px rgba(124,58,237,.22)}
    .brand-title{font-weight:800;letter-spacing:.6px}
    .nav-actions{display:flex;gap:.6rem}
    .ghost{border:1px solid var(--border);background:transparent;color:var(--text)}
    .btn{padding:.6rem 1rem;border-radius:12px;font-weight:700;display:inline-flex;align-items:center;gap:.55rem;cursor:pointer}
    .primary{background:linear-gradient(90deg,var(--brand-1),var(--brand-2));box-shadow:0 10px 30px rgba(124,58,237,.22)}

    /* CONTAINER */
    .container{max-width:1200px;margin:0 auto;padding:28px 18px}

    /* HERO */
    .hero{display:grid;grid-template-columns:1.05fr .95fr;gap:28px;align-items:center}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 70px rgba(0,0,0,.55)}
    .hero-card{padding:34px}
    .title{font-size:44px;line-height:1.05;font-weight:900;margin:0}
    .title .grad{background:linear-gradient(90deg,var(--brand-1),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .muted{color:var(--muted)}
    .hero-cta{display:flex;gap:.8rem;margin-top:18px}

    .preview{padding:16px}
    .grid-mini{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .mini{display:flex;gap:.7rem;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);padding:10px;border-radius:12px;transition:transform .2s}
    .mini:hover{transform:translateY(-3px)}

    /* LAYOUT / SIDEBAR */
    .layout{display:grid;grid-template-columns:280px 1fr;gap:20px}
    .sidebar{position:sticky;top:78px;height:fit-content}
    .panel{padding:18px}
    .panel h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.4px;color:#cbd5e1;text-transform:uppercase}
    .search{display:flex;gap:.6rem}
    .search input{flex:1;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text)}

    .swatches{display:flex;flex-wrap:wrap;gap:8px}
    .swatch{width:34px;height:34px;border-radius:999px;border:2px solid rgba(255,255,255,.12);cursor:pointer;position:relative}
    .swatch.active{outline:3px solid #eab308 !important}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{padding:.45rem .7rem;border-radius:999px;background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.22);cursor:pointer;color:white}
    .tag.active{background:rgba(124,58,237,.3)}
    .tiny{font-size:12px;color:var(--muted)}

    /* PACKS GRID */
    .packs{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .pack{overflow:hidden}
    .thumb{height:140px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,#1f2937,#0f172a);display:flex;align-items:center;justify-content:center}
    .thumb .glyph{height:68px;width:68px;border-radius:14px;display:grid;place-items:center;color:white}
    .content{padding:14px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .badge{font-size:12px;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:white}
    .actions{display:flex;gap:6px;align-items:center}

    /* SMALL BUTTONS: smaller padding & font so download isn't huge */
    .btn.sm{padding:.25rem .5rem;border-radius:8px;font-weight:700;border:1px solid var(--border);background:rgba(255,255,255,.02);color:white;font-size:13px;display:inline-flex;align-items:center;gap:.4rem;min-width:auto}
    .btn.sm i{font-size:13px}
    a.btn.sm{display:inline-flex;align-items:center}

    /* MODALS */
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width:100%;max-width:760px;background:var(--bg-2);border-radius:12px;overflow:hidden}
    .modal .panel{padding:20px}

    /* EDIT modal tweaks */
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 20px 20px}

    /* File upload styles */
    .file-upload-area{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;border:2px dashed var(--border);border-radius:12px;background:rgba(255,255,255,.02);text-align:center;cursor:pointer;grid-column:span 2}
    .file-upload-area:hover{border-color:var(--brand-1);background:rgba(124,58,237,.05)}
    .file-upload-area i{font-size:32px;margin-bottom:12px;color:var(--brand-1)}
    .file-hint{margin-top:6px;color:var(--muted)}

    /* responsive */
    @media (max-width:1024px){.layout{grid-template-columns:1fr}.sidebar{position:static}.packs{grid-template-columns:repeat(2,1fr)}.hero{grid-template-columns:1fr}.title{font-size:36px}}
    @media (max-width:768px){.packs{grid-template-columns:1fr}.nav-actions{display:none}.file-upload-area{padding:16px}}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="#" onclick="goto('home')">
        <div class="brand-badge"><i class="fa-solid fa-cube"></i></div>
        <div>
          <div class="brand-title">BEDROCKHUB</div>
          <div class="tiny">Minecraft Bedrock • community</div>
        </div>
      </a>
      <div class="nav-actions">
        <button class="btn ghost" onclick="goto('home')">Home</button>
        <button class="btn ghost" onclick="goto('packs')"><i class="fa-solid fa-paint-roller"></i> Texture Packs</button>
        <a class="btn primary" href="#"><i class="fa-brands fa-discord"></i> Join Discord</a>
      </div>
    </div>
  </header>

  <section id="page-home" class="container">
    <div class="hero">
      <div class="card hero-card">
        <h1 class="title">Discover & share elite <span class="grad">Bedrock texture packs</span></h1>
        <p class="muted">A billionaire-grade experience: razor-clean UI, smart filters, instant uploads. Click Texture Packs to browse, filter by color & tags, and upload your own .mcpack.</p>
        <div class="hero-cta">
          <button class="btn primary" onclick="goto('packs')"><i class="fa-solid fa-paint-roller"></i> Get started</button>
          <button class="btn ghost" onclick="goto('packs')">Browse gallery</button>
        </div>
      </div>
      <aside class="card preview">
        <div class="preview-head"><strong>Latest drops</strong><span class="tiny">just now</span></div>
        <div class="grid-mini">
          <div class="mini"><div class="icon"><i class="fa-solid fa-cubes"></i></div><div><div style="font-weight:800">Stellar HD</div><div class="tiny">HD • Realistic</div></div></div>
          <div class="mini"><div class="icon" style="background:linear-gradient(135deg,#a855f7,#ec4899)"><i class="fa-solid fa-crown"></i></div><div><div style="font-weight:800">Royal PvP</div><div class="tiny">PvP • Purple</div></div></div>
        </div>
      </aside>
    </div>
  </section>

  <section id="page-packs" class="container" style="display:none">
    <div class="layout">
      <aside class="sidebar card panel">
        <h3>Search</h3>
        <div class="search">
          <input id="q" placeholder="Search by name..." oninput="applyFilters()" />
          <button class="btn sm" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny" style="margin-top:6px">Results update instantly</div>

        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Colors</h3>
        <div id="colorSwatches" class="swatches"></div>
        <div class="row" style="margin-top:8px"><button class="btn sm" onclick="clearColors()">Clear colors</button></div>

        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Tags</h3>
        <div id="tagCloud" class="tags"></div>
        <div class="row" style="margin-top:8px"><button class="btn sm" onclick="clearTags()">Clear tags</button></div>

        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Upload</h3>
        <div class="row"><button class="btn primary" onclick="openModal()"><i class="fa-solid fa-cloud-upload-alt"></i> Upload pack</button></div>
      </aside>

      <div>
        <div class="card panel" style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:14px">
          <div class="tiny">Showing <span id="count">0</span> packs</div>
          <div class="row"><button class="btn sm ghost" onclick="resetAll()"><i class="fa-solid fa-rotate"></i> Reset filters</button></div>
        </div>
        <div id="grid" class="packs"></div>
      </div>
    </div>
  </section>

  <!-- UPLOAD MODAL -->
  <div id="backdrop" class="backdrop" aria-hidden="true">
    <div class="modal card" role="dialog" aria-modal="true">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Upload Texture Pack</strong>
          <button class="btn sm" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny">Select a .mcpack file, set a name, choose color & tags.</div>
      </div>
      <div class="panel" style="padding-top:0">
        <form id="uploadForm" onsubmit="handleUpload(event)">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div>
              <label class="tiny">Pack name</label>
              <input id="packName" required placeholder="e.g. Crystal PvP" style="width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text)">
            </div>
            <div>
              <label class="tiny">Primary color</label>
              <div id="modalSwatches" class="swatches"></div>
            </div>
            <div>
              <label class="tiny">Tags</label>
              <div id="modalTags" class="tags"></div>
            </div>
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
              <i class="fa-solid fa-file-arrow-up"></i>
              <div>Drag & drop or <span style="color:var(--brand-1)">browse files</span></div>
              <div class="file-hint" id="fileHint">.mcpack files only</div>
              <input id="fileInput" type="file" accept=".mcpack" style="display:none" onchange="hintFile()" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn sm" onclick="closeModal()">Cancel</button>
            <button id="submitBtn" class="btn primary" type="submit"><i class="fa-solid fa-upload"></i> Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editBackdrop" class="backdrop" aria-hidden="true" style="display:none">
    <div class="modal card" role="dialog" aria-modal="true">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Edit Texture Pack</strong>
          <button class="btn sm" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny">Change name, tags or color. You can also delete the pack.</div>
      </div>
      <div class="panel" style="padding-top:0">
        <form id="editForm" onsubmit="saveEdit(event)">
          <input type="hidden" id="editId" />
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div>
              <label class="tiny">Pack name</label>
              <input id="editPackName" required placeholder="Pack name" style="width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text)">
            </div>
            <div>
              <label class="tiny">Primary color</label>
              <div id="editModalSwatches" class="swatches"></div>
            </div>
            <div>
              <label class="tiny">Tags</label>
              <div id="editModalTags" class="tags"></div>
            </div>
            <div class="tiny" style="align-self:center">File stays the same — to replace file delete & re-upload.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn sm" onclick="deleteCurrentPack()"><i class="fa-solid fa-trash"></i> Delete</button>
            <div style="flex:1"></div>
            <button type="button" class="btn sm" onclick="closeEditModal()">Cancel</button>
            <button class="btn primary" type="submit"><i class="fa-solid fa-save"></i> Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
/* ====== DATA ====== */
const COLORS = [
  {key:'red',hex:'#ef4444'},{key:'blue',hex:'#3b82f6'},{key:'green',hex:'#22c55e'},{key:'yellow',hex:'#eab308'},
  {key:'purple',hex:'#a855f7'},{key:'pink',hex:'#ec4899'},{key:'orange',hex:'#f97316'},{key:'teal',hex:'#14b8a6'},{key:'gray',hex:'#6b7280'}
];
const TAGS = ['pvp','natural','realistic','cartoon','medieval','modern','rpg','hd','adventure'];

/* ====== PACKS (IndexedDB) ====== */
let packs = [];

/* ====== STATE ====== */
const state = { q:'', colors:new Set(), tags:new Set(), modalColor:null, modalTags:new Set(), editColor:null, editTags:new Set() };

/* ====== NAV ====== */
function goto(which){
  document.getElementById('page-home').style.display = which==='home' ? 'block' : 'none';
  document.getElementById('page-packs').style.display = which==='packs' ? 'block' : 'none';
  if(which==='packs') render();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ====== IDB HELPERS ====== */
const DB_NAME = 'bedrockhub-db';
const STORE_NAME = 'packs';
let dbPromise = null;
function openDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
  return dbPromise;
}
async function putPackToIDB(pack){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_NAME,'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const r = store.put(pack);
    r.onsuccess = ()=> res();
    r.onerror = ()=> rej(r.error);
  });
}
async function deletePackFromIDB(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_NAME,'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const r = store.delete(id);
    r.onsuccess = ()=> res();
    r.onerror = ()=> rej(r.error);
  });
}
async function getAllPacksFromIDB(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(STORE_NAME,'readonly');
    const store = tx.objectStore(STORE_NAME);
    const r = store.getAll();
    r.onsuccess = ()=> res(r.result || []);
    r.onerror = ()=> rej(r.error);
  });
}

/* ====== UI BUILD (swatches/tags) ====== */
const colorSwatches = document.getElementById('colorSwatches');
const tagCloud = document.getElementById('tagCloud');
const modalSwatches = document.getElementById('modalSwatches');
const modalTags = document.getElementById('modalTags');
const editModalSwatches = document.getElementById('editModalSwatches');
const editModalTags = document.getElementById('editModalTags');

function buildSwatches(container, clickHandler, activeSet){
  container.innerHTML = '';
  COLORS.forEach(c=>{
    const b = document.createElement('button');
    b.type='button';
    b.className='swatch'+(activeSet?.has?.(c.key)?' active':'');
    b.style.background = c.hex; b.title=c.key;
    b.onclick = ()=> clickHandler(c.key, b);
    container.appendChild(b);
  })
}
function buildTags(container, clickHandler, activeSet){
  container.innerHTML='';
  TAGS.forEach(t=>{
    const s = document.createElement('button');
    s.type='button';
    s.className='tag'+(activeSet?.has?.(t)?' active':'');
    s.textContent = t.toUpperCase();
    s.onclick = ()=> clickHandler(t, s);
    container.appendChild(s);
  })
}

/* initialize */
buildSwatches(colorSwatches, (key, el)=>{ toggleSet(state.colors, key); el.classList.toggle('active'); applyFilters(); }, state.colors);
buildTags(tagCloud, (key, el)=>{ toggleSet(state.tags, key); el.classList.toggle('active'); applyFilters(); }, state.tags);
buildSwatches(modalSwatches, (key, el)=>{ state.modalColor = key; highlightOne(modalSwatches, el); }, new Set());
buildTags(modalTags, (key, el)=>{ toggleSet(state.modalTags, key); el.classList.toggle('active'); }, state.modalTags);

/* edit modal swatches/tags init */
buildSwatches(editModalSwatches, (key, el)=>{ state.editColor = key; highlightOne(editModalSwatches, el); }, new Set());
buildTags(editModalTags, (key, el)=>{ toggleSet(state.editTags, key); el.classList.toggle('active'); }, state.editTags);

function highlightOne(container, el){
  [...container.children].forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
}
function toggleSet(set, key){ set.has(key)? set.delete(key): set.add(key); }

/* ====== RENDER ====== */
function escapeHtml(str){ return String(str||'').replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s])); }
function shade(hex, amt){
  let col = hex.replace('#',''); if(col.length===3) col = col.split('').map(c=>c+c).join('');
  let [r,g,b] = [0,0,0].map((_,i)=> parseInt(col.slice(i*2,i*2+2),16));
  [r,g,b] = [r+amt,g+amt,b+amt].map(v=> Math.max(0,Math.min(255,v)));
  return `#${[r,g,b].map(v=> v.toString(16).padStart(2,'0')).join('')}`;
}

function renderCard(p){
  const color = COLORS.find(c=>c.key===p.color)?.hex || '#64748b';
  const card = document.createElement('div');
  card.className = 'card pack';

  // create download button if blob available (objectURL)
  let downloadBtn = '';
  if(p.fileBlob){
    const url = URL.createObjectURL(p.fileBlob);
    // revoke after 60s to avoid memory leak
    setTimeout(()=> URL.revokeObjectURL(url), 60_000);
    const safeFileName = (p.fileName || p.name || 'pack').replace(/\s+/g,'_');
    downloadBtn = `<a class="btn sm" href="${url}" download="${safeFileName}"><i class="fa-solid fa-download"></i> Download</a>`;
  }

  card.innerHTML = `
    <div class="thumb" style="background:linear-gradient(135deg, ${shade(color, -20)}, ${shade(color, 20)})">
      <div class="glyph" style="background:${color}"><i class="fa-solid fa-cube"></i></div>
    </div>
    <div class="content">
      <h4>${escapeHtml(p.name)}</h4>
      <div class="meta">
        <span class="badge" style="border-color:${color}">${p.color?.toUpperCase()}</span>
        ${(p.tags||[]).map(t=>`<span class="badge">${t.toUpperCase()}</span>`).join('')}
      </div>
      <div class="actions">
        ${downloadBtn}
        <button class="btn sm" onclick="sharePack(${p.id})"><i class="fa-regular fa-share-from-square"></i> Share</button>
        <button class="btn sm" onclick="openEditModal(${p.id})"><i class="fa-regular fa-pen-to-square"></i> Edit</button>
      </div>
    </div>`;
  return card;
}

async function render(){
  const grid = document.getElementById('grid');
  const count = document.getElementById('count');
  const filtered = packs.filter(p=>{
    const qOk = !state.q || p.name.toLowerCase().includes(state.q);
    const cOk = state.colors.size===0 || state.colors.has(p.color);
    const tOk = state.tags.size===0 || [...state.tags].every(t=>p.tags.includes(t));
    return qOk && cOk && tOk;
  });
  count.textContent = filtered.length;
  grid.innerHTML = '';
  filtered.forEach(p=> grid.appendChild(renderCard(p)) );
  if(filtered.length===0){
    const empty = document.createElement('div');
    empty.className='card panel';
    empty.innerHTML = '<div class="tiny">No packs match your filters.</div>';
    grid.appendChild(empty);
  }
}

/* ====== SHARE & EDIT HELPERS ====== */
function sharePack(id){
  const p = packs.find(x=>x.id===id);
  if(!p) return alert('Pack not found');
  if(!p.fileBlob) return alert('No file stored for this pack.');

  // create an object URL and copy it to clipboard (valid in this browser session only)
  const url = URL.createObjectURL(p.fileBlob);
  navigator.clipboard?.writeText(url).then(()=>{
    alert('Temporary download link copied to clipboard. Works in this browser session until you reload.');
  }, ()=>{
    // fallback: show a prompt with the URL user can copy
    prompt('Copy this temporary link (works this session):', url);
  });
  // revoke after a while (we still need it active for the user to paste/use it)
  setTimeout(()=> URL.revokeObjectURL(url), 60_000);
}

/* EDIT modal */
let currentEditId = null;
function openEditModal(id){
  const p = packs.find(x=>x.id===id);
  if(!p) return alert('Pack not found');
  currentEditId = id;
  document.getElementById('editId').value = id;
  document.getElementById('editPackName').value = p.name || '';
  // set edit color & tags
  state.editColor = p.color || null;
  state.editTags = new Set(p.tags || []);
  // rebuild edit controls with active states
  buildSwatches(editModalSwatches, (key, el)=>{
    state.editColor = key; highlightOne(editModalSwatches, el);
  }, new Set([state.editColor]));
  // tags uses the state.editTags
  buildTags(editModalTags, (key, el)=>{ toggleSet(state.editTags, key); el.classList.toggle('active'); }, state.editTags);

  document.getElementById('editBackdrop').style.display = 'flex';
  document.getElementById('editBackdrop').setAttribute('aria-hidden','false');
}

function closeEditModal(){
  currentEditId = null;
  document.getElementById('editBackdrop').style.display = 'none';
  document.getElementById('editBackdrop').setAttribute('aria-hidden','true');
  resetEditModal();
}
function resetEditModal(){
  document.getElementById('editForm').reset();
  state.editColor = null;
  state.editTags = new Set();
  buildSwatches(editModalSwatches, (key, el)=>{ state.editColor = key; highlightOne(editModalSwatches, el); }, new Set());
  buildTags(editModalTags, (key, el)=>{ toggleSet(state.editTags, key); el.classList.toggle('active'); }, state.editTags);
}

/* save edits */
async function saveEdit(e){
  e.preventDefault();
  if(!currentEditId) return alert('No pack selected');
  const id = Number(document.getElementById('editId').value);
  const name = document.getElementById('editPackName').value.trim();
  const color = state.editColor;
  const tags = [...state.editTags];

  const pIndex = packs.findIndex(x=>x.id===id);
  if(pIndex === -1) return alert('Pack not found');

  // update in-memory pack and IDB (preserve fileBlob)
  const updated = Object.assign({}, packs[pIndex], { name, color, tags });
  packs[pIndex] = updated;
  try{
    await putPackToIDB(updated);
    await render();
    closeEditModal();
  }catch(err){
    console.error('Save edit failed', err);
    alert('Save failed: ' + (err?.message || err));
  }
}

/* delete current pack */
async function deleteCurrentPack(){
  if(!currentEditId) return;
  if(!confirm('Delete this pack? This cannot be undone.')) return;
  const id = currentEditId;
  try{
    await deletePackFromIDB(id);
    packs = packs.filter(p=>p.id !== id);
    await render();
    closeEditModal();
  }catch(err){
    console.error('Delete failed', err);
    alert('Delete failed: ' + (err?.message || err));
  }
}

/* ====== UPLOAD FLOW (store blob into IDB) ====== */
function openModal(){
  document.getElementById('backdrop').style.display = 'flex';
  document.getElementById('backdrop').setAttribute('aria-hidden','false');
  if(!state.modalColor){
    state.modalColor = 'blue';
    const first = modalSwatches.querySelector('.swatch');
    if(first) first.classList.add('active');
  }
}
function closeModal(){
  document.getElementById('backdrop').style.display = 'none';
  document.getElementById('backdrop').setAttribute('aria-hidden','true');
  resetModal();
}
function hintFile(){
  const f = document.getElementById('fileInput').files[0];
  if(f){
    document.getElementById('fileHint').textContent = f.name;
    const area = document.querySelector('.file-upload-area');
    if(area) area.style.borderColor = 'var(--brand-1)';
  }
}
function resetModal(){
  document.getElementById('uploadForm').reset();
  state.modalColor = null; state.modalTags = new Set();
  buildSwatches(modalSwatches,(k,el)=>{ state.modalColor=k; highlightOne(modalSwatches, el); }, new Set());
  buildTags(modalTags,(k,el)=>{ toggleSet(state.modalTags,k); el.classList.toggle('active'); }, state.modalTags);
  document.getElementById('fileHint').textContent = '.mcpack files only';
  const area = document.querySelector('.file-upload-area'); if(area) area.style.borderColor = 'var(--border)';
}

async function handleUpload(e){
  e.preventDefault();
  const name = document.getElementById('packName').value.trim();
  const file = document.getElementById('fileInput').files[0];
  if(!file || !file.name.endsWith('.mcpack')){ alert('Select a valid .mcpack'); return; }
  if(!state.modalColor){ alert('Pick a primary color'); return; }
  const tags = [...state.modalTags];

  const id = Date.now();
  const pack = {
    id,
    name: name || file.name.replace(/\.mcpack$/i,''),
    color: state.modalColor,
    tags: tags.length ? tags : ['hd'],
    fileName: file.name,
    fileBlob: file,
    created: new Date().toISOString()
  };

  try{
    await putPackToIDB(pack);
    packs.unshift(pack);
    closeModal();
    await render();
  }catch(err){
    console.error('Failed to save pack to IndexedDB:', err);
    alert('Saving failed: ' + (err?.message || err));
  }
}

/* ====== LOAD PACKS ON START ====== */
async function loadPacksOnStartup(){
  try{
    const arr = await getAllPacksFromIDB();
    packs = (arr || []).sort((a,b)=> b.id - a.id);
  }catch(err){
    console.error('Failed to load packs from IDB', err);
    packs = [];
  }
  render()
}

/* ====== FILTER HELPERS ====== */
function applyFilters(){ state.q = document.getElementById('q').value.trim().toLowerCase(); render(); }
function clearSearch(){ document.getElementById('q').value=''; applyFilters(); }
function clearColors(){ state.colors.clear(); buildSwatches(colorSwatches,(k,el)=>{toggleSet(state.colors,k); el.classList.toggle('active'); applyFilters();}, state.colors); render(); }
function clearTags(){ state.tags.clear(); buildTags(tagCloud,(k,el)=>{toggleSet(state.tags,k); el.classList.toggle('active'); applyFilters();}, state.tags); render(); }
function resetAll(){ clearSearch(); clearColors(); clearTags(); }

/* BOOT */
goto('home');
// initialize controls were already called above
loadPacksOnStartup();
</script>
</body>
</html>
