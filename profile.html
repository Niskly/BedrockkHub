<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - MCHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-0: #000000; --bg-1: #1c1c1c; --bg-2: #2c2c2c; --muted: #a8b3cf;
            --text: #e8eefc; --border: rgba(255, 255, 255, .12); --brand-1: #de212a;
            --brand-2: #b21a22; --shadow-brand: 0 12px 30px rgba(222, 33, 42, .22);
            --danger: #ef4444; --success: #22c55e; --border-strong: rgba(255, 255, 255, .2);
            --discord: #5865F2; --spotify: #1DB954; --youtube: #FF0000;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { margin: 0; background-color: var(--bg-0); color: var(--text); font: 500 15px/1.6 Inter, sans-serif; min-height: 100vh; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg'); background-size: cover; filter: blur(8px); opacity: 0.25; z-index: -1; }
        a { color: inherit; text-decoration: none; }
        header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(10px); background: rgba(12, 12, 12, 0.7); border-bottom: 1px solid var(--border); }
        .nav { max-width: 1200px; margin: 0 auto; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge { height: 44px; width: 44px; border-radius: 12px; display: grid; place-items: center; background: linear-gradient(135deg, var(--brand-2), var(--brand-1)); box-shadow: var(--shadow-brand); }
        .brand-icon-custom { width: 100%; height: 100%; object-fit: contain; padding: 4px; transform: translateY(-13px); }
        .brand-title { font-weight: 800; letter-spacing: .6px; }
        .nav-actions { display: flex; align-items: center; gap: .6rem; }
        .btn { padding: .6rem 1rem; border-radius: 12px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: .55rem; cursor: pointer; border: 1px solid transparent; background: none; color: inherit; font-family: inherit; font-size: inherit; }
        .primary { background: linear-gradient(135deg, var(--brand-1), var(--brand-2)); color: white; box-shadow: var(--shadow-brand); }
        .primary:disabled { opacity: 0.7; cursor: not-allowed; }
        .tiny { font-size: 12px; color: var(--muted); }
        .nav-actions .btn { border: none !important; }
        .user-dropdown { position: relative; display: inline-block; }
        .user-menu-btn { background: var(--bg-2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        .nav-avatar-img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .nav-avatar-default { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-0); display: flex; align-items: center; justify-content: center; }
        .user-menu-btn .fa-chevron-down { font-size: 0.8em; transition: transform 0.2s; }
        .user-menu-btn:hover { border-color: var(--border-strong); }
        .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px; min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10; overflow: hidden; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--muted); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .dropdown-content a:hover { background: var(--bg-2); color: var(--text); }
        .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; opacity: 0; transition: opacity 0.3s; }
        .container.loaded { opacity: 1; }
        .settings-layout { display: flex; gap: 2rem; align-items: flex-start; }
        .tabs { display: flex; flex-direction: column; gap: 0.5rem; flex-shrink: 0; width: 220px; }
        .tab-btn { padding: 0.75rem 1rem; border-radius: 10px; background: transparent; border: none; color: var(--muted); font: 600 15px/1.4 Inter, sans-serif; text-align: left; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s ease; }
        .tab-btn.active, .tab-btn:hover { background: var(--bg-2); color: var(--text); }
        .tab-content { display: none; flex-grow: 1; }
        .tab-content.active { display: block; }
        .card { background: var(--bg-1); border: 1px solid var(--border); border-radius: 18px; margin-bottom: 1.5rem; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .card-body { padding: 1.5rem; }
        .card-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; align-items: center; }
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group:last-child { margin-bottom: 0; }
        label { display: block; margin-bottom: .5rem; font-weight: 600; color: var(--muted); }
        input[type="text"], input[type="email"], input[type="password"], textarea { width: 100%; padding: .75rem 1rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); font-size: 1rem; font-family: inherit; }
        textarea { min-height: 100px; resize: vertical; }
        .input-hint { font-size: 0.85rem; color: var(--muted); margin-top: 0.5rem; }
        .btn.danger { background-color: var(--danger); color: white; }
        .danger-zone { border: 1px solid var(--danger); border-radius: 16px; }
        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .link-btn { background: var(--bg-2); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-align: center; position: relative; }
        .link-btn:hover { border-color: var(--border-strong); transform: translateY(-3px); }
        .link-btn i { font-size: 2rem; }
        .link-btn .fa-xbox { color: #107C10; }
        .link-btn .fa-discord { color: var(--discord); }
        .link-btn .fa-spotify { color: var(--spotify); }
        .link-btn .fa-youtube { color: var(--youtube); }
        .link-btn .fa-plus { color: var(--muted); }
        .link-btn.linked .fa-check-circle { position: absolute; top: 8px; right: 8px; color: var(--success); background: var(--bg-2); border-radius: 50%; font-size: 1rem;}
        .linked-gamertag { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }
        .remove-link-btn { position: absolute; top: 4px; right: 4px; background: var(--bg-0); color: var(--danger); border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem; display: grid; place-items: center; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        .remove-link-btn:hover { opacity: 1; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--bg-1); border: 1px solid var(--border); border-radius: 18px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.2rem; }
        .close-modal-btn { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.5rem; }
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 1001; }
        .toast { padding: 12px 18px; border-radius: 8px; color: white; font-weight: 700; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out forwards; margin-bottom: 10px; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .spinner-sm { width: 1.2em; height: 1.2em; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="nav">
            <a class="brand" href="/">
                <div class="brand-badge"><img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom"></div>
                <div><div class="brand-title">MCHUB</div><div class="tiny">Minecraft Bedrock â€¢ community</div></div>
            </a>
            <div id="nav-actions" class="nav-actions"></div>
        </div>
    </header>
    
    <main class="container" id="settings-container">
        <div class="settings-layout">
            <aside class="tabs">
                <button class="tab-btn active" data-tab="customization"><i class="fa-solid fa-palette"></i> Customization</button>
                <button class="tab-btn" data-tab="links"><i class="fa-solid fa-link"></i> Links</button>
                <button class="tab-btn" data-tab="account"><i class="fa-solid fa-user-gear"></i> Account</button>
            </aside>
            <div class="content-container">
                <section id="customization-tab" class="tab-content active">
                    <form id="customization-form">
                        <div class="card">
                            <div class="card-header"><h1>Profile Customization</h1><p class="tiny">This information will be displayed publicly.</p></div>
                            <div class="card-body">
                                <div class="form-group"><label for="pfp-url">Profile Picture URL</label><input type="text" id="pfp-url" placeholder="https://..."></div>
                                <div class="form-group"><label for="banner-url">Banner URL</label><input type="text" id="banner-url" placeholder="https://..."></div>
                                <div class="form-group"><label for="bio">Bio</label><textarea id="bio" placeholder="Tell us a little about yourself..." maxlength="500"></textarea><p class="input-hint">Max 500 characters.</p></div>
                                <div class="form-group"><label for="cursor-url">Cursor URL</label><input type="text" id="cursor-url" placeholder="https://..."></div>
                                <div class="form-group"><label for="effect-url">Effect URL</label><input type="text" id="effect-url" placeholder="e.g., 'snow'"></div>
                                <div class="form-group"><label for="music-url">Profile Music URL</label><input type="text" id="music-url" placeholder="https://..."></div>
                            </div>
                            <div class="card-footer"><button type="submit" class="btn primary">Save Changes</button></div>
                        </div>
                    </form>
                </section>
                <section id="links-tab" class="tab-content">
                    <div class="card">
                         <div class="card-header"><h1>Linked Accounts</h1><p class="tiny">Connect your other social accounts.</p></div>
                         <div class="card-body"><div id="links-container" class="links-grid"></div></div>
                    </div>
                </section>
                <section id="account-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header"><h1>Account Settings</h1><p class="tiny">Manage your account credentials.</p></div>
                        <div class="card-body">
                            <div class="form-group"><label for="email">Email Address</label><input type="email" id="email" readonly><p class="input-hint">To change email, contact support.</p></div>
                            <div class="form-group"><label for="password">New Password</label><input type="password" id="password" placeholder="Enter new password"><p class="input-hint">Only for email/password sign-ups.</p></div>
                        </div>
                        <div class="card-footer"><button type="button" class="btn primary" id="update-password-btn">Update Password</button></div>
                    </div>
                    <div class="card danger-zone">
                        <div class="card-header"><h1>Danger Zone</h1></div>
                        <div class="card-body"><p>Once you delete your account, there is no going back. Please be certain.</p></div>
                        <div class="card-footer"><button type="button" class="btn danger" id="delete-account-btn">Delete My Account</button></div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="link-modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title">Add New Link</h2><button class="close-modal-btn">&times;</button></div>
            <form id="link-modal-form">
                <div class="modal-body">
                    <div class="form-group"><label for="link-name">Link Name</label><input type="text" id="link-name" placeholder="e.g., My Website" required></div>
                    <div class="form-group"><label for="link-url">URL / Username</label><input type="text" id="link-url" placeholder="https://... or username#1234" required></div>
                </div>
                <div class="card-footer"><button type="submit" class="btn primary">Save Link</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null, userProfile = null;

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelector('.tab-btn.active').classList.remove('active');
                tab.classList.add('active');
                document.querySelector('.tab-content.active').classList.remove('active');
                document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
            });
        });

        const modalOverlay = document.getElementById('link-modal');
        function openModal(title, name = '', url = '') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('link-name').value = name;
            document.getElementById('link-url').value = url;
            modalOverlay.classList.add('show');
        }
        function closeModal() { modalOverlay.classList.remove('show'); }
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', closeModal));
        modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });

        async function loadProfileData() {
            if (!currentUser) return;
            const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) {
                showToast('Failed to load profile data', 'error');
                return console.error(error);
            }
            userProfile = data;
            if (!userProfile.social_links) userProfile.social_links = []; // Ensure it's an array

            document.getElementById('pfp-url').value = data.avatar_url || '';
            document.getElementById('banner-url').value = data.banner_url || '';
            document.getElementById('bio').value = data.bio || '';
            document.getElementById('email').value = currentUser.email;
            renderLinks();
        }

        function getIconForLink(name) {
            const lowerName = name.toLowerCase();
            if (lowerName.includes('discord')) return 'fa-brands fa-discord';
            if (lowerName.includes('spotify')) return 'fa-brands fa-spotify';
            if (lowerName.includes('youtube')) return 'fa-brands fa-youtube';
            if (lowerName.includes('xbox')) return 'fa-brands fa-xbox';
            return 'fa-solid fa-link';
        }

        function renderLinks() {
            const container = document.getElementById('links-container');
            container.innerHTML = ''; // Clear previous

            // Render Xbox (special case)
            const xboxBtn = document.createElement('button');
            xboxBtn.className = 'link-btn';
            if (userProfile.bedrock_gamertag) {
                xboxBtn.classList.add('linked');
                xboxBtn.innerHTML = `<i class="fa-solid fa-check-circle"></i><i class="fa-brands fa-xbox"></i><span>Xbox Linked</span><span class="linked-gamertag">${userProfile.bedrock_gamertag}</span>`;
            } else {
                xboxBtn.innerHTML = `<i class="fa-brands fa-xbox"></i><span>Link Xbox</span>`;
                xboxBtn.addEventListener('click', () => alert('Xbox linking logic here.'));
            }
            container.appendChild(xboxBtn);

            // Render saved social links
            userProfile.social_links.forEach((link, index) => {
                const linkEl = document.createElement('div');
                linkEl.className = 'link-btn';
                linkEl.innerHTML = `
                    <button class="remove-link-btn" data-index="${index}" title="Remove Link"><i class="fa-solid fa-trash"></i></button>
                    <i class="${getIconForLink(link.name)}"></i>
                    <span>${link.name}</span>
                    <span class="linked-gamertag">${link.url}</span>`;
                container.appendChild(linkEl);
            });

            // Add button for new links
            const addBtn = document.createElement('button');
            addBtn.className = 'link-btn';
            addBtn.innerHTML = `<i class="fa-solid fa-plus"></i><span>Add Social Link</span>`;
            addBtn.addEventListener('click', () => openModal('Add Social Link'));
            container.appendChild(addBtn);

            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-link-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const indexToRemove = parseInt(btn.dataset.index);
                    if (confirm('Are you sure you want to remove this link?')) {
                        userProfile.social_links.splice(indexToRemove, 1);
                        await saveSocialLinks();
                    }
                });
            });
        }
        
        async function saveSocialLinks() {
             const { error } = await supabase
                .from('profiles')
                .update({ social_links: userProfile.social_links })
                .eq('id', currentUser.id);

            if (error) {
                showToast('Failed to update links.', 'error');
                console.error(error);
            } else {
                showToast('Links updated successfully!');
                renderLinks(); // Re-render to show changes
            }
        }
        
        document.getElementById('link-modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('link-name').value;
            const url = document.getElementById('link-url').value;
            userProfile.social_links.push({ name, url });
            
            await saveSocialLinks();
            closeModal();
        });
        
        document.getElementById('customization-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (rest of customization save logic is unchanged)
        });

        document.addEventListener('auth-ready', (e) => {
            currentUser = e.detail.user;
            if (currentUser) {
                document.getElementById('settings-container').classList.add('loaded');
                loadProfileData();
            } else {
                window.location.href = '/login.html';
            }
        });
    </script>
    <script type="module" src="/auth.js"></script>
</body>
</html>
