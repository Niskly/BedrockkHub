<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BedrockHub — Texture Packs (Supabase)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    :root{
      --bg-0:#060910;--bg-1:#0a0f1a;--bg-2:#0e1524;--muted:#a8b3cf;--text:#e8eefc;--border:rgba(255,255,255,.08);
      --brand-1:#7c3aed;--brand-2:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(124,58,237,.18),transparent),radial-gradient(1200px 800px at 90% 10%,rgba(37,99,235,.18),transparent),linear-gradient(180deg,var(--bg-1),var(--bg-0) 40%,var(--bg-1));color:var(--text);font:500 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial}
    a{color:inherit;text-decoration:none}
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(10px);background:linear-gradient(90deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-bottom:1px solid var(--border)}
    .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:.8rem}
    .brand-badge{height:44px;width:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand-2),var(--brand-1));box-shadow:0 12px 30px rgba(124,58,237,.22)}
    .brand-title{font-weight:800;letter-spacing:.6px}
    .nav-actions{display:flex;gap:.6rem}
    .btn{padding:.6rem 1rem;border-radius:12px;font-weight:700;display:inline-flex;align-items:center;gap:.55rem;cursor:pointer;border:1px solid transparent}
    .ghost{border-color:var(--border);background:transparent;color:var(--text)}
    .primary{background:linear-gradient(90deg,var(--brand-1),var(--brand-2));box-shadow:0 10px 30px rgba(124,58,237,.22)}
    .btn.danger{background-color:#ef444420;border-color:#ef444490;color:#ef4444}
    .btn.success{background-color:#22c55e20;border-color:#22c55e90;color:#22c55e}
    .container{max-width:1200px;margin:0 auto;padding:28px 18px}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:20px}
    .sidebar{position:sticky;top:78px;height:fit-content}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:18px;box-shadow:0 24px 70px rgba(0,0,0,.55)}
    .panel{padding:18px}
    .panel h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.4px;color:#cbd5e1;text-transform:uppercase}
    .search{display:flex;align-items:center;position:relative;}
    .search input{flex:1;padding:.7rem 1rem;padding-right: 2.5rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text); min-width: 0;}
    .search .btn.sm.ghost{position:absolute;right:8px;top:50%;transform:translateY(-50%);padding:.5rem;line-height:1;height:32px;width:32px;display:grid;place-items:center;background:transparent;border:none;color:var(--muted);}
    .swatches, .resolutions{display:flex;flex-wrap:wrap;gap:8px}
    .swatch{width:34px;height:34px;border-radius:999px;border:2px solid rgba(255,255,255,.12);cursor:pointer;position:relative}
    .swatch.active, .res-box.active{outline:3px solid #eab308 !important}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{padding:.45rem .7rem;border-radius:999px;background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.22);cursor:pointer;color:white;font-weight:700;}
    .tag.active{background:rgba(124,58,237,.3)}
    .res-box{padding:.45rem .7rem;border-radius:8px;background:rgba(255,255,255,.02);border:1px solid var(--border);cursor:pointer;font-weight:700;color:white;}
    .tiny{font-size:12px;color:var(--muted)}
    .packs{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:18px}
    .pack{overflow:hidden}
    .pack.card{box-shadow: 0 24px 70px rgba(0,0,0,.55);transition: box-shadow .2s, transform .2s;}
    .pack.card:hover{transform: translateY(-4px);box-shadow: 0 28px 75px rgba(0,0,0,.65);}
    .thumb{height:140px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;position: relative;overflow: hidden;}
    .pack .thumb {border-bottom-color: var(--border) !important;}
    .thumb .pack-icon-bg {position: absolute;top: 0;left: 0;width: 100%;height: 100%;background-size: cover;background-position: center;filter: blur(8px) brightness(0.7);transform: scale(1.1);}
    .thumb .pack-icon {position: relative;width: 90px;height: 90px;border-radius: 8px;object-fit: cover;z-index: 1;box-shadow: 0 4px 12px rgba(0,0,0,0.4);}
    .thumb .glyph{height:68px;width:68px;border-radius:14px;display:grid;place-items:center;color:white}
    .content{padding:14px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .badge{font-size:12px;padding:.25rem .55rem;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:white;font-weight: 700;}
    .pack-options-btn {position: absolute;top: 8px;right: 8px;z-index: 2;background: rgba(0,0,0,0.4);color: white;border: 1px solid rgba(255,255,255,0.1);border-radius: 8px;width: 30px;height: 30px;display: grid;place-items: center;cursor: pointer;padding: 0;}
    .pack-options-menu {display: none;position: absolute;top: 42px;right: 8px;z-index: 3;background: var(--bg-2);border: 1px solid var(--border);border-radius: 8px;overflow: hidden;box-shadow: 0 8px 20px rgba(0,0,0,0.4);}
    .pack-options-menu a {display: flex;align-items: center;gap: 10px;padding: 8px 14px;font-size: 14px;}
    .pack-options-menu a:hover {background: var(--brand-1);}
    .pack-options-menu a i {width: 16px;text-align: center;}
    .btn.sm{padding:.25rem .5rem;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;gap:.4rem;min-width:auto}
    .btn.sm.btn-clear{padding: .2rem .6rem;font-size: 12px;font-weight: 800;background: linear-gradient(90deg, var(--brand-1), var(--brand-2));color: var(--bg-0);border: none;}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width:100%;max-width:760px;background:var(--bg-2);border-radius:12px;overflow:hidden}
    .modal .panel{padding:20px}
    .modal-footer{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 20px 20px}
    .modal-footer .right-actions { display: flex; gap: 10px; }
    .modal-footer.center-actions { justify-content: center; }
    .file-upload-area{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;border:2px dashed var(--border);border-radius:12px;background:rgba(255,255,255,.02);text-align:center;cursor:pointer;grid-column:span 2}
    .file-upload-area:hover{border-color:var(--brand-1);background:rgba(124,58,237,.05)}
    .file-upload-area i{font-size:32px;margin-bottom:12px;color:var(--brand-1)}
    .file-hint{margin-top:6px;color:var(--muted)}
    .label-with-icon { display: flex; align-items: center; gap: 6px; }
    @media (max-width:1024px){.layout{grid-template-columns:1fr}.sidebar{position:static}.packs{grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));}}
    @media (max-width:768px){.packs{grid-template-columns:1fr;}.nav-actions{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/">
        <div class="brand-badge"><i class="fa-solid fa-cube"></i></div>
        <div>
          <div class="brand-title">BEDROCKHUB</div>
          <div class="tiny">Minecraft Bedrock • community</div>
        </div>
      </a>
      <div class="nav-actions">
        <a class="btn ghost" href="/">Home</a>
        <a class="btn ghost" href="/texturepacks.html"><i class="fa-solid fa-paint-roller"></i> Texture Packs</a>
        <a class="btn primary" href="https://discord.gg/KtafawJZxM" target="_blank" rel="noopener noreferrer"><i class="fa-brands fa-discord"></i> Join Discord</a>
      </div>
    </div>
  </header>

  <section class="container">
    <div class="layout">
      <aside class="sidebar card panel">
        <h3>Search</h3>
        <div class="search">
          <input id="q" placeholder="Search by name..." oninput="applyFilters()" />
          <button class="btn sm ghost" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny" style="margin-top:6px">Results update instantly</div>
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Colors</h3>
        <div id="colorSwatches" class="swatches"></div>
        <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearColors()">Clear colors</button></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Resolutions</h3>
        <div id="resolutionBoxes" class="resolutions"></div>
        <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearResolutions()">Clear resolutions</button></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Tags</h3>
        <div id="tagCloud" class="tags"></div>
        <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearTags()">Clear tags</button></div>
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h3>Upload</h3>
        <div class="row"><button class="btn primary" onclick="openModal()"><i class="fa-solid fa-cloud-upload-alt"></i> Upload pack</button></div>
      </aside>
      <div>
        <div class="card panel" style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:14px">
          <div class="tiny">Showing <span id="count">0</span> packs</div>
          <div class="row"><button class="btn sm ghost" onclick="resetAll()"><i class="fa-solid fa-rotate"></i> Reset filters</button></div>
        </div>
        <div id="grid" class="packs"></div>
      </div>
    </div>
  </section>

  <div id="backdrop" class="backdrop">
    <div class="modal card">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Upload Texture Pack</strong>
          <button class="btn sm" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny">Select a .mcpack file, set a name, choose color & tags.</div>
      </div>
      <div class="panel" style="padding-top:0">
        <form id="uploadForm" onsubmit="handleUpload(event)">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div>
              <label class="tiny label-with-icon">
                <span>Pack name</span>
                <i class="fa-solid fa-pencil fa-xs"></i>
              </label>
              <input id="packName" required placeholder="e.g. Crystal PvP" style="width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text)">
            </div>
            <div>
              <label class="tiny">Primary color</label>
              <div id="modalSwatches" class="swatches"></div>
            </div>
            <div style="grid-column: span 2;">
              <label class="tiny">Resolution</label>
              <div id="modalResolutions" class="resolutions"></div>
            </div>
            <div style="grid-column: span 2;">
              <label class="tiny">Tags</label>
              <div id="modalTags" class="tags"></div>
            </div>
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="grid-column: span 2;">
              <i class="fa-solid fa-file-arrow-up"></i>
              <div>Drag & drop or <span style="color:var(--brand-1)">browse files</span></div>
              <div class="file-hint" id="fileHint">.mcpack files only</div>
              <input id="fileInput" type="file" accept=".mcpack" style="display:none" onchange="hintFile()" />
            </div>
          </div>
          <div class="modal-footer center-actions">
            <button type="button" class="btn sm ghost" onclick="closeModal()">Cancel</button>
            <button id="submitBtn" class="btn primary" type="submit"><i class="fa-solid fa-upload"></i> Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="editBackdrop" class="backdrop">
    <div class="modal card">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Edit Texture Pack</strong>
          <button class="btn sm" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="tiny">Change name, tags or color.</div>
      </div>
      <div class="panel" style="padding-top:0">
        <form id="editForm" onsubmit="saveEdit(event)">
          <input type="hidden" id="editId" />
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
            <div>
              <label class="tiny">Pack name</label>
              <input id="editPackName" required placeholder="Pack name" style="width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text)">
            </div>
            <div>
              <label class="tiny">Primary color</label>
              <div id="editModalSwatches" class="swatches"></div>
            </div>
            <div style="grid-column: span 2;">
                <label class="tiny">Resolution</label>
                <div id="editModalResolutions" class="resolutions"></div>
            </div>
            <div style="grid-column: span 2;">
              <label class="tiny">Tags</label>
              <div id="editModalTags" class="tags"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div></div>
            <div class="right-actions">
                <button type="button" class="btn sm danger" onclick="promptDelete()">Delete</button>
                <button class="btn primary" type="submit"><i class="fa-solid fa-save"></i> Save</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="confirmDeleteBackdrop" class="backdrop">
    <div class="modal card" style="max-width: 420px;">
        <div class="panel">
            <strong>Are you sure you want to delete it?</strong>
            <p class="tiny" style="margin: 4px 0 12px;">This will permanently delete the texture pack.</p>
            <div style="display:flex;justify-content:flex-end;gap:10px;">
                <button class="btn sm danger" onclick="cancelDelete()">No</button>
                <button class="btn sm success" onclick="confirmDelete()">Yes</button>
            </div>
        </div>
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ====== DATA & STATE ====== */
  const COLORS = [
    {key:'red',hex:'#ef4444'},{key:'blue',hex:'#3b82f6'},{key:'green',hex:'#22c55e'},{key:'yellow',hex:'#eab308'},
    {key:'purple',hex:'#a855f7'},{key:'pink',hex:'#ec4899'},{key:'orange',hex:'#f97316'},{key:'teal',hex:'#14b8a6'},{key:'gray',hex:'#6b7280'},
    {key:'black', hex:'#1f2937'}
  ];
  const TAGS = ['pvp','natural','realistic','cartoon','medieval','modern','rpg','hd','adventure'];
  const RESOLUTIONS = ['8x', '16x', '32x', '64x'];
  let packs = [];
  const state = { q:'', colors:new Set(), tags:new Set(), resolutions: new Set(), modalColor:null, modalTags:new Set(), modalResolution: null, editColor:null, editTags:new Set(), editResolution: null };
  let currentEditId = null;

  /* ====== GLOBAL FUNCTIONS for onclick ====== */
  // NOTE: The goto function is no longer needed as we are using standard <a> links
  // window.goto = function(which){ ... } 

  window.openModal = function(){
    document.getElementById('backdrop').style.display = 'flex';
    state.modalColor = null;
    state.modalResolution = null;
    state.modalTags = new Set();
    buildSwatches(document.getElementById('modalSwatches'), (k, el) => { state.modalColor = k; highlightOne(el.parentElement, el); }, null);
    buildTags(document.getElementById('modalTags'), (k, el) => { toggleSet(state.modalTags, k); el.classList.toggle('active'); }, new Set());
    buildResolutionBoxes(document.getElementById('modalResolutions'), (res, el) => { state.modalResolution = res; highlightOne(el.parentElement, el); }, null);
  }

  window.closeModal = function(){
    document.getElementById('backdrop').style.display = 'none';
    document.getElementById('uploadForm').reset();
    document.getElementById('fileHint').textContent = '.mcpack files only';
  }

  window.openEditModal = function(id){
    const p = packs.find(x=>x.id===id);
    if(!p) return alert('Pack not found');
    currentEditId = id;
    document.getElementById('editId').value = id;
    document.getElementById('editPackName').value = p.name || '';
    state.editColor = p.color || null;
    state.editTags = new Set(p.tags || []);
    state.editResolution = p.resolution || null;
    buildSwatches(document.getElementById('editModalSwatches'), (k, el)=>{ state.editColor = k; highlightOne(el.parentElement, el); }, new Set([state.editColor]));
    buildTags(document.getElementById('editModalTags'), (k, el)=>{ toggleSet(state.editTags, k); el.classList.toggle('active'); }, state.editTags);
    buildResolutionBoxes(document.getElementById('editModalResolutions'), (res, el) => { state.editResolution = res; highlightOne(el.parentElement, el); }, state.editResolution);
    document.getElementById('editBackdrop').style.display = 'flex';
  }

  window.closeEditModal = function(){
    currentEditId = null;
    document.getElementById('editBackdrop').style.display = 'none';
  }
  
  window.handleUpload = async function(e){
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
    
    const name = document.getElementById('packName').value.trim();
    const file = document.getElementById('fileInput').files[0];
    if(!file || !file.name.endsWith('.mcpack')){ alert('Select a valid .mcpack'); submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload'; return; }
    if(!state.modalColor){ alert('Pick a primary color'); submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload'; return; }
    if(!state.modalResolution){ alert('Pick a resolution'); submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload'; return; }

    try {
      let iconUrl = null;
      const zip = new JSZip();
      const contents = await zip.loadAsync(file);
      const iconFile = contents.file('pack_icon.png');

      if (iconFile) {
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading Icon...';
        const iconBlob = await iconFile.async('blob');
        const iconFileName = `icons/${Date.now()}-pack_icon.png`;
        const { error: iconError } = await supabase.storage.from('packs').upload(iconFileName, iconBlob);
        if (iconError) throw iconError;
        const { data } = supabase.storage.from('packs').getPublicUrl(iconFileName);
        iconUrl = data.publicUrl;
      }

      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading Pack...';
      const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
      await supabase.storage.from('packs').upload(fileName, file);

      const response = await fetch('/api/addpacks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
              name: name || file.name.replace(/\.mcpack$/i,''),
              color: state.modalColor,
              tags: [...state.modalTags],
              filename: fileName,
              resolution: state.modalResolution,
              icon_url: iconUrl 
          })
      });

      if (!response.ok) throw new Error((await response.json()).details || 'Failed to add pack metadata.');
      
      await loadPacksOnStartup();
      closeModal();
    } catch(err) {
      alert('Upload failed: ' + err.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-upload"></i> Upload';
    }
  }
  
  window.saveEdit = async function(e){
    e.preventDefault();
    if(!currentEditId) return;
    const { error } = await supabase
      .from('packs')
      .update({
        name: document.getElementById('editPackName').value.trim(),
        color: state.editColor,
        tags: [...state.editTags].join(','),
        resolution: state.editResolution
      })
      .eq('id', currentEditId);

    if (error) {
      alert('Save failed: ' + error.message);
    } else {
      await loadPacksOnStartup();
      closeEditModal();
    }
  }

  window.promptDelete = function() {
    if(!currentEditId) return;
    document.getElementById('confirmDeleteBackdrop').style.display = 'flex';
  }

  window.cancelDelete = function() {
    document.getElementById('confirmDeleteBackdrop').style.display = 'none';
  }

  window.confirmDelete = async function() {
    if (!currentEditId) return;
    const packToDelete = packs.find(p => p.id === currentEditId);
    if (!packToDelete) {
        cancelDelete();
        return;
    }
    try {
        await supabase.storage.from('packs').remove([packToDelete.filename]);
        if (packToDelete.icon_url) {
            const iconFileName = packToDelete.icon_url.split('/').pop();
            await supabase.storage.from('packs').remove([`icons/${iconFileName}`]);
        }
        const { error } = await supabase.from('packs').delete().eq('id', currentEditId);
        if (error) throw error;
        await loadPacksOnStartup();
    } catch (error) {
        alert('Delete failed: ' + error.message);
    } finally {
        cancelDelete();
        closeEditModal();
    }
  }
  
  window.applyFilters = function(){ state.q = document.getElementById('q').value.trim().toLowerCase(); render(); }
  window.clearSearch = function(){ document.getElementById('q').value=''; applyFilters(); }
  window.clearColors = function(){ state.colors.clear(); buildSwatches(document.getElementById('colorSwatches'),(k,el)=>{toggleSet(state.colors,k); el.classList.toggle('active'); render();}, state.colors); render(); }
  window.clearTags = function(){ state.tags.clear(); buildTags(document.getElementById('tagCloud'),(k,el)=>{toggleSet(state.tags,k); el.classList.toggle('active'); render();}, state.tags); render(); }
  window.clearResolutions = function(){ state.resolutions.clear(); buildResolutionBoxes(document.getElementById('resolutionBoxes'), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions); render(); }
  window.resetAll = function(){ clearSearch(); clearColors(); clearTags(); clearResolutions(); }
  window.hintFile = function(){
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if(file){ 
      document.getElementById('fileHint').textContent = file.name;
      const packNameInput = document.getElementById('packName');
      packNameInput.value = file.name.replace(/\.mcpack$/i, '');
    }
  }

  window.toggleOptionsMenu = function(event, id) {
    event.stopPropagation();
    const menu = document.getElementById(`options-menu-${id}`);
    const isVisible = menu.style.display === 'block';
    document.querySelectorAll('.pack-options-menu').forEach(m => m.style.display = 'none');
    menu.style.display = isVisible ? 'none' : 'block';
  }

  /* ====== INTERNAL FUNCTIONS ====== */
  function buildSwatches(container, clickHandler, activeSet){
    container.innerHTML = '';
    COLORS.forEach(c=>{
      const b = document.createElement('button');
      b.type='button';
      b.className='swatch'+( (activeSet && activeSet.has(c.key)) ?' active':'');
      b.style.background = c.hex; b.title=c.key;
      b.onclick = ()=> clickHandler(c.key, b);
      container.appendChild(b);
    })
  }
  function buildTags(container, clickHandler, activeSet){
    container.innerHTML='';
    TAGS.forEach(t=>{
      const s = document.createElement('button');
      s.type='button';
      s.className='tag'+(activeSet?.has(t)?' active':'');
      s.textContent = t.toUpperCase();
      s.onclick = ()=> clickHandler(t, s);
      container.appendChild(s);
    })
  }

  function buildResolutionBoxes(container, clickHandler, activeState) {
    container.innerHTML = '';
    const isMultiSelect = activeState instanceof Set;
    RESOLUTIONS.forEach(res => {
        const box = document.createElement('button');
        box.type = 'button';
        const isActive = isMultiSelect ? activeState.has(res) : (activeState === res);
        box.className = 'res-box' + (isActive ? ' active' : '');
        box.textContent = res;
        box.onclick = () => clickHandler(res, box);
        container.appendChild(box);
    });
  }

  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  function shade(hex, amt){
    let col = hex.replace('#',''); if(col.length===3) col=col.split('').map(c=>c+c).join('');
    let [r,g,b] = [0,0,0].map((_,i)=> parseInt(col.slice(i*2,i*2+2),16));
    [r,g,b] = [r+amt,g+amt,b+amt].map(v=> Math.max(0,Math.min(255,v)));
    return `#${[r,g,b].map(v=> v.toString(16).padStart(2,'0')).join('')}`;
  }

  function renderCard(p){
    const colorKey = p.color || 'gray';
    const color = COLORS.find(c=>c.key===colorKey)?.hex || '#6b7280';
    const card = document.createElement('div');
    card.className = 'card pack';
    const { data } = supabase.storage.from('packs').getPublicUrl(p.filename);

    let thumbContent;
    let thumbBackgroundStyle;

    if (p.icon_url) {
      thumbContent = `
        <div class="pack-icon-bg" style="background-image: url('${p.icon_url}');"></div>
        <img class="pack-icon" src="${p.icon_url}" alt="${escapeHtml(p.name)} Icon">
      `;
      thumbBackgroundStyle = `background: linear-gradient(135deg,#1f2937,#0f172a);`;
    } else {
      thumbContent = `<div class="glyph" style="background:${color}"><i class="fa-solid fa-cube"></i></div>`;
      thumbBackgroundStyle = `background:linear-gradient(135deg, ${shade(color, -20)}, ${shade(color, 20)})`;
    }

    card.innerHTML = `
      <div class="thumb" style="${thumbBackgroundStyle}">
        ${thumbContent}
        <button class="pack-options-btn" onclick="toggleOptionsMenu(event, ${p.id})">
          <i class="fa-solid fa-ellipsis-vertical"></i>
        </button>
        <div class="pack-options-menu" id="options-menu-${p.id}">
            <a href="${data.publicUrl}" download>
                <i class="fa-solid fa-download"></i> Download
            </a>
            <a href="#" onclick="openEditModal(${p.id}); event.preventDefault();">
                <i class="fa-regular fa-pen-to-square"></i> Edit
            </a>
        </div>
      </div>
      <div class="content">
        <h4>${escapeHtml(p.name)}</h4>
        <div class="meta">
          <span class="badge" style="border-color:${color}">${p.color?.toUpperCase()}</span>
          ${p.resolution ? `<span class="badge">${p.resolution}</span>` : ''}
          ${(p.tags||[]).map(t=>`<span class="badge">${t.toUpperCase()}</span>`).join('')}
        </div>
      </div>`;
    return card;
  }

  async function render(){
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const filtered = packs.filter(p=>{
      const qOk = !state.q || p.name.toLowerCase().includes(state.q);
      const cOk = state.colors.size === 0 || state.colors.has(p.color);
      const tOk = state.tags.size === 0 || [...state.tags].every(t => (p.tags || []).includes(t));
      const rOk = state.resolutions.size === 0 || state.resolutions.has(p.resolution);
      return qOk && cOk && tOk && rOk;
    });
    count.textContent = filtered.length;
    grid.innerHTML = '';
    filtered.forEach(p => grid.appendChild(renderCard(p)));
    if(filtered.length===0){
      grid.innerHTML = '<div class="card panel tiny">No packs match your filters.</div>';
    }
  }

  function highlightOne(container, el){
    [...container.children].forEach(c=>c.classList.remove('active'));
    el.classList.add('active');
  }

  function toggleSet(set, key){ set.has(key)? set.delete(key): set.add(key); }
  
  async function loadPacksOnStartup(){
    const { data, error } = await supabase.from('packs').select('*').order('created_at', { ascending: false });
    if (error) {
      console.error('Failed to load packs from Supabase', error);
      packs = [];
    } else {
      packs = data.map(pack => ({ ...pack, tags: pack.tags ? pack.tags.split(',') : [] }));
    }
    render();
  }

  function init() {
    window.applyFilters = applyFilters;
    window.clearSearch = clearSearch;
    window.clearColors = clearColors;
    window.clearTags = clearTags;
    window.clearResolutions = clearResolutions;
    window.resetAll = resetAll;
    window.promptDelete = promptDelete;
    window.cancelDelete = cancelDelete;
    window.confirmDelete = confirmDelete;
    window.hintFile = hintFile;
    window.toggleOptionsMenu = toggleOptionsMenu;

    // This code only runs on the texture packs page
    if (document.getElementById('grid')) {
        buildSwatches(document.getElementById('colorSwatches'), (k, el)=>{ toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors);
        buildTags(document.getElementById('tagCloud'), (k, el)=>{ toggleSet(state.tags, k); el.classList.toggle('active'); render(); }, state.tags);
        buildResolutionBoxes(document.getElementById('resolutionBoxes'), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions);
        
        window.addEventListener('click', () => {
            document.querySelectorAll('.pack-options-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        });

        loadPacksOnStartup();
    }
  }

  init();
</script>
</body>
</html>
