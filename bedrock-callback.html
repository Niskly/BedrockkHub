<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Linking Bedrock Account</title>
    <style>
        body { font-family: sans-serif; background: #1c1c1c; color: #e8eefc; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; padding: 2rem; background: rgba(44, 44, 44, 0.8); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.12); max-width: 400px; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #de212a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Processing...</h2>
        <p id="status">Please wait while we link your Bedrock account.</p>
    </div>
    <script>
        const statusEl = document.getElementById('status');
        const spinnerEl = document.querySelector('.spinner');
        
        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = type;
            if (type !== 'info') spinnerEl.style.display = 'none';
        }
        
        try {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            const errorDescription = params.get('error_description');

            if (error) {
                throw new Error(errorDescription || 'Authentication failed.');
            }

            if (!code) {
                throw new Error('Authentication code not found in response.');
            }

            updateStatus('Authentication successful! Sending code to main application...');
            
            if (window.opener) {
                // The main window now expects an 'auth_code' instead of a 'token'
                window.opener.postMessage({
                    type: 'BEDROCK_AUTH_SUCCESS',
                    auth_code: code 
                }, window.location.origin);
            }
            
            setTimeout(() => window.close(), 1500);

        } catch (e) {
            console.error('Callback error:', e);
            updateStatus(`Error: ${e.message}`, 'error');
            if (window.opener) {
                window.opener.postMessage({
                    type: 'BEDROCK_AUTH_ERROR',
                    message: e.message
                }, window.location.origin);
            }
            setTimeout(() => window.close(), 3000);
        }
    </script>
</body>
</html>

