<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCHub â€” Texture Packs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
    /* Prevents the "flash of the wrong theme" by keeping the body hidden until the theme is ready */
    body {
        opacity: 0;
        transition: opacity 0.2s ease-in;
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-0: #000000;
            --bg-1: #1c1c1c;
            --bg-2: #2c2c2c;
            --muted: #a8b3cf;
            --text: #e8eefc;
            --border: rgba(255, 255, 255, .12);
            --brand-1: #de212a;
            --brand-2: #b21a22;
            --shadow-brand: 0 12px 30px rgba(222, 33, 42, .22);
            --danger: #ef4444;
            --success: #22c55e;
            --border-strong: rgba(255, 255, 255, .2);
            --primary: var(--brand-1);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; scroll-behavior: smooth; }
        body {
            margin: 0;
            background-color: var(--bg-0);
            color: var(--text);
            font: 500 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-image: var(--bg-image, url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg'));
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(8px);
            opacity: 0.25;
            z-index: -1;
            transition: background-image 0.5s ease-in-out;
        }
        a { color: inherit; text-decoration: none; }
        header {
            position: sticky; top: 0; z-index: 50;
            backdrop-filter: saturate(1.2) blur(10px);
            background: rgba(12, 12, 12, 0.7);
            border-bottom: 1px solid var(--border);
        }
        .nav { max-width: 1200px; margin: 0 auto; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge {
            height: 44px; width: 44px; border-radius: 12px;
            display: grid; place-items: center;
            background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
            box-shadow: var(--shadow-brand);
        }
        .brand-title { font-weight: 800; letter-spacing: .6px; }
        .nav-actions { display: flex; gap: .6rem; }
        /* FIX: Standardize Nav action button size */
        .btn { padding: .5rem 0.9rem; border-radius: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .ghost { border-color: var(--border); background: transparent; color: var(--text); }
        .primary {
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            box-shadow: var(--shadow-brand);
            color: white;
        }
        .btn.danger { background-color: #ef444420; border-color: #ef444490; color: var(--danger); }
        .btn.success { background-color: #22c55e20; border-color: #22c55e90; color: var(--success); }
        .container { max-width: 1200px; margin: 0 auto; padding: 28px 18px; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { position: sticky; top: 78px; height: fit-content; }
        .card { background: var(--bg-1); border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 24px 70px rgba(0, 0, 0, .55); }
        .panel { padding: 18px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 14px; letter-spacing: .4px; color: #cbd5e1; text-transform: uppercase; }
        .search { display: flex; align-items: center; position: relative; }
        .search input { flex: 1; padding: .7rem 1rem; padding-right: 2.5rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); min-width: 0; }
        .search .btn.sm.ghost { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: .5rem; line-height: 1; height: 32px; width: 32px; display: grid; place-items: center; background: transparent; border: none; color: var(--muted); }
        .swatches, .resolutions { display: flex; flex-wrap: wrap; gap: 8px; }
        .swatch { width: 34px; height: 34px; border-radius: 999px; border: 2px solid rgba(255, 255, 255, .12); cursor: pointer; position: relative; display: grid; place-items: center; font-size: 16px; color: white; }
        .swatch.active, .res-box.active { outline: 3px solid var(--brand-1) !important; }
        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            padding: .45rem .7rem; border-radius: 999px;
            background: var(--bg-2);
            border: 1px solid var(--border);
            cursor: pointer; color: var(--muted); font-weight: 700;
            text-transform: capitalize; 
            transition: all 0.2s ease;
        }
        .tag:hover {
            border-color: var(--border-strong);
            color: var(--text);
        }
        .tag.active { 
            background: var(--brand-1);
            border-color: var(--brand-2);
            color: white;
        }
        .res-box { padding: .45rem .7rem; border-radius: 8px; background: var(--bg-2); border: 1px solid var(--border); cursor: pointer; font-weight: 700; color: white; text-transform: capitalize; }
        .tiny { font-size: 12px; color: var(--muted); }
        .packs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }
        /* START UPLOADER INFO AND BULK UPLOAD STYLES */
        .pack-name-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px;
        }
        .pack-name-row h4 { 
            margin: 0; 
            max-width: 65%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .uploader-info { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            flex-shrink: 0;
            text-decoration: none; 
            color: var(--muted); 
            transition: color 0.2s;
        }
        .uploader-info:hover { 
            color: var(--text); 
        }
        .uploader-avatar { 
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            object-fit: cover;
            border: 1px solid var(--border);
        }
        .uploader-name { 
            font-size: 11px; 
            font-weight: 600; 
            max-width: 70px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .upload-mode-switcher { 
            display: flex; 
            margin-bottom: 1.5rem; 
            border-radius: 10px; 
            background: var(--bg-0); 
            padding: 4px;
            grid-column: span 2;
        }
        .upload-mode-switcher button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-mode-switcher button.active {
            background: var(--bg-2);
            color: var(--text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Hides elements only in bulk mode, restores in single mode */
        .bulk-hidden {
             display: none !important;
        }
        /* END UPLOADER INFO AND BULK UPLOAD STYLES */
        .pack { overflow: hidden; }
        .pack.card { box-shadow: 0 24px 70px rgba(0, 0, 0, .55); transition: box-shadow .2s, transform .2s, border-color .2s; }
        .pack.card:hover { transform: translateY(-4px); box-shadow: 0 28px 75px rgba(0, 0, 0, .65); border-color: rgba(255,255,255,.2); }
        .thumb { height: 140px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .pack .thumb { border-bottom-color: var(--border) !important; }
        .thumb .pack-icon-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(8px) brightness(0.7); transform: scale(1.1); }
        .thumb .pack-icon { position: relative; width: 90px; height: 90px; border-radius: 8px; object-fit: cover; z-index: 1; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }
        .thumb .glyph { height: 68px; width: 68px; border-radius: 14px; display: grid; place-items: center; color: white; }
        .content { padding: 14px; }
        .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .badge { font-size: 12px; padding: .25rem .55rem; border-radius: 999px; border: 1px solid var(--border); background: var(--bg-2); color: white; font-weight: 700; text-transform: capitalize;}
        .pack-stats-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--muted); }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .pack-options-btn { position: absolute; top: 8px; right: 8px; z-index: 2; background: rgba(0, 0, 0, 0.4); color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; width: 30px; height: 30px; display: grid; place-items: center; cursor: pointer; padding: 0; }
        .pack-options-menu { display: none; position: absolute; top: 42px; right: 8px; z-index: 3; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); min-width: 160px; }
        .pack-options-menu a { display: flex; align-items: center; gap: 10px; padding: 8px 14px; font-size: 14px; }
        .pack-options-menu a:hover { background: var(--brand-1); }
        .pack-options-menu a i { width: 16px; text-align: center; }
        .btn.sm { padding: .25rem .5rem; border-radius: 8px; font-weight: 700; display: inline-flex; align-items: center; gap: .4rem; min-width: auto; }
        .btn.sm.btn-clear {
            padding: .2rem .6rem; font-size: 12px; font-weight: 800;
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            color: white; border: none;
        }
        .backdrop { position: fixed; inset: 0; background: rgba(2, 6, 23, .8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 60; }
        .backdrop.on-top { z-index: 70; }
        .modal { width: 100%; max-width: 760px; background: var(--bg-2); border-radius: 12px; overflow-y: auto; max-height: 90vh; }
        /* UPDATED: Modal layout for mobile */
        @media (max-width: 768px) {
            .nav-actions { display: none; }
            .mobile-nav-toggle { display: block; }
            .packs { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .modal { max-width: 95vw; max-height: 95vh; }
            .modal .panel { padding: 14px; }
            .modal-footer { padding: 10px 14px 14px; }
            .modal-footer button { font-size: 14px; }
            .upload-mode-switcher { margin-bottom: 1rem; }
            .upload-mode-switcher button { padding: 8px 8px; font-size: 13px; }
            
            /* Force upload form grid to stack on mobile */
            #upload-form-grid {
                grid-template-columns: 1fr !important;
            }
            #upload-form-grid > div {
                grid-column: span 1 !important;
            }
        }
        @media (max-width: 480px) {
            .packs { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <header>
        <div class="nav">
            <a class="brand" href="/">
                <div class="brand-badge">
                    <img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom">
                </div>
                <div>
                    <div class="brand-title">MCHUB</div>
                    <div class="tiny">Minecraft Bedrock â€¢ community</div>
                </div>
            </a>
            <div id="nav-actions" class="nav-actions">
                <!-- Auth.js will populate this -->
            </div>
        </div>
    </header>

    <section class="container" id="main-content">
        <div class="layout">
            <aside class="sidebar card panel">
                <div id="admin-actions">
                    <h3>Actions</h3>
                    <div class="row"><button class="btn primary" onclick="openModal()" style="width: 100%;"><i class="fa-solid fa-cloud-upload-alt"></i> Upload Pack</button></div>
                    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                </div>
                <h3>Colors</h3>
                <div id="colorSwatches" class="swatches"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearColors()">Clear colors</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Resolutions</h3>
                <div id="resolutionBoxes" class="resolutions"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearResolutions()">Clear resolutions</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Version</h3>
                <div id="versionBoxes" class="resolutions"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearVersions()">Clear versions</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Tags</h3>
                <div id="tagCloud" class="tags"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearTags()">Clear tags</button></div>
            </aside>
            
            <div class="main-content-area">
                <div class="card panel filter-bar" style="display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:14px; flex-wrap: wrap;">
                    <div class="sort-container" id="sortContainer">
                        <button class="btn sm ghost sort-btn" onclick="toggleSortMenu()">
                            <span class="tiny">Sort by:</span>
                            <span id="currentSort">Latest Upload</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div class="sort-menu" id="sortMenu">
                            <a href="#" class="active" onclick="setSort('latest', this)">Latest Upload</a>
                            <a href="#" onclick="setSort('downloads', this)">Downloads</a>
                        </div>
                    </div>
                    <div class="search" style="flex-grow: 1;">
                        <input id="q" placeholder="Search by name..." oninput="applyFilters()" />
                        <button class="btn sm ghost" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="row"><button class="btn sm ghost" onclick="resetAll()">Reset filters</button></div>
                </div>
                
                <div class="mobile-filter-controls">
                     <div class="search" style="margin-bottom: 1rem;">
                        <input id="mobile-q" placeholder="Search by name..." oninput="applyMobileSearch()" />
                        <button class="btn sm ghost" onclick="clearMobileSearch()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="mobile-actions">
                         <!-- P3 FIX: Upload button in mobile-actions -->
                         <button id="mobile-upload-btn" class="btn primary" onclick="openModal()" style="display:none;"><i class="fa-solid fa-cloud-upload-alt"></i> Upload</button>
                         <!-- /P3 FIX -->
                         <div class="sort-container" id="mobileSortContainer">
                            <button class="btn ghost sort-btn" onclick="toggleSortMenu(true)">
                                <div><span class="tiny">Sort by:</span> <span id="mobileCurrentSort">Latest Upload</span></div>
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            <div class="sort-menu" id="mobileSortMenu">
                                <a href="#" class="active" onclick="setSort('latest', this, true)">Latest Upload</a>
                                <a href="#" onclick="setSort('downloads', this, true)">Downloads</a>
                            </div>
                        </div>
                        <button class="btn ghost" onclick="resetAll()"><i class="fa-solid fa-undo"></i> Reset</button>
                        <button id="mobile-filter-btn" class="btn primary"><i class="fa-solid fa-sliders"></i> Choose Filters</button>
                    </div>
                    <div id="mobile-filters-panel" class="card">
                    </div>
                </div>

                <div id="grid" class="packs"></div>
                <div id="pagination-controls" class="pagination"></div>
            </div>
        </div>
    </section>

    <!-- All Modals (Upload, Edit, Confirm Delete, Tag Select) go here -->
    <div id="backdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong id="modal-title">Upload Texture Pack</strong>
                    <button class="btn sm ghost" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny" id="modal-hint">Select a .mcpack or .zip file, set a name, choose color & tags.</div>
            </div>
            <div class="panel" style="padding-top:0">
                <!-- NEW MODE SWITCHER -->
                <div class="upload-mode-switcher">
                    <button id="single-upload-btn" class="active" onclick="setUploadMode('single')"><i class="fa-solid fa-file-upload"></i> Single Pack Upload</button>
                    <button id="bulk-upload-btn" onclick="setUploadMode('bulk')"><i class="fa-solid fa-box"></i> Bulk Upload (Fast)</button>
                </div>
                <!-- END NEW MODE SWITCHER -->
                <form id="uploadForm" onsubmit="handleUpload(event)">
                    <fieldset id="uploadFormFieldset">
                        <div id="upload-form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px; align-items: start;">
                            <!-- Pack Name input is hidden in bulk mode -->
                            <div id="pack-name-group" class="bulk-hidden-field">
                                <label class="tiny label-with-icon"><span>Pack name</span></label>
                                <input id="packName" required placeholder="e.g. Crystal PvP" type="text">
                            </div>
                            
                            <!-- Color Swatches -->
                            <div id="color-group" class="bulk-hidden-field">
                                <label class="tiny">Primary color</label>
                                <div id="modalSwatches" class="swatches"></div>
                            </div>

                            <div id="description-group" class="bulk-hidden-field" style="grid-column: span 1;">
                               <label class="tiny">Description (optional)</label>
                               <textarea id="packDescription" placeholder="A short description of the pack..."></textarea>
                            </div>
                            
                            <!-- Resolution/Tags -->
                            <div id="res-tag-group" class="bulk-hidden-field" style="grid-column: span 1;">
                                <div>
                                    <label class="tiny">Resolution</label>
                                    <div id="modalResolutions" class="resolutions"></div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label class="tiny">Tags</label>
                                    <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openTagModal()">
                                        <span id="tagSelectorBtnText">Select Tags</span>
                                        <i class="fa-solid fa-chevron-down fa-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="grid-column: span 2;">
                                <i class="fa-solid fa-file-arrow-up"></i>
                                <div>Drag & drop or <span style="color:var(--brand-1)">browse files</span></div>
                                <div class="file-hint" id="fileHint">.mcpack or .zip files only</div>
                                <!-- FIX: Added 'multiple' attribute for bulk upload -->
                                <input id="fileInput" type="file" accept=".mcpack,.zip" style="display:none" onchange="hintFile()" multiple /> 
                            </div>
                        </div>
                    </fieldset>
                    <div class="modal-footer center-actions">
                        <button type="button" class="btn sm ghost" onclick="closeModal()">Cancel</button>
                        <button id="submitBtn" class="btn primary" type="submit"><i class="fa-solid fa-upload"></i> Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="tag-select-backdrop" class="backdrop on-top">
        <div class="modal card" style="max-width: 500px;" id="tagSelectModal">
            <div class="panel">
                <strong>Select Tags</strong>
                <div style="margin-top: 12px;">
                    <input type="text" id="tagSearchInput" placeholder="Search tags...">
                </div>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer center-actions">
                <button type="button" class="btn sm ghost" onclick="closeTagModal(false)">Cancel</button>
                <button type="button" class="btn primary" onclick="closeTagModal(true)">Done</button>
            </div>
        </div>
    </div>

    <div id="editBackdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Edit Texture Pack</strong>
                    <button class="btn sm ghost" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny">Change name, tags, description or color.</div>
            </div>
            <div class="panel" style="padding-top:0">
                <form id="editForm" onsubmit="saveEdit(event)">
                    <input type="hidden" id="editId" />
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div>
                            <label class="tiny">Pack name</label>
                            <input id="editPackName" required placeholder="Pack name" type="text">
                        </div>
                        <div>
                            <label class="tiny">Primary color</label>
                            <div id="editModalSwatches" class="swatches"></div>
                        </div>
                        <div style="grid-column: span 1;">
                            <label class="tiny">Resolution</label>
                            <div id="editModalResolutions" class="resolutions"></div>
                        </div>
                         <div style="grid-column: span 1;">
                            <label class="tiny">Tags</label>
                            <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openEditTagModal()">
                                <span id="editTagSelectorBtnText">Select Tags</span>
                                <i class="fa-solid fa-chevron-down fa-xs"></i>
                            </button>
                        </div>
                        <div style="grid-column: span 2;"><label class="tiny">Description (optional)</label>
                            <textarea id="editPackDescription" placeholder="A short description of the pack..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div></div>
                        <div class="right-actions">
                            <button type="button" class="btn sm danger" onclick="promptDelete()">Delete</button>
                            <button class="btn primary" type="submit"><i class="fa-solid fa-save"></i> Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="confirmDeleteBackdrop" class="backdrop">
        <div class="modal card" style="max-width: 420px;">
            <div class="panel">
                <strong>Are you sure you want to delete it?</strong>
                <p class="tiny" style="margin: 4px 0 12px;">This will permanently delete the texture pack.</p>
                <div style="display:flex;justify-content:flex-end;gap:10px;">
                    <button class="btn sm ghost" onclick="cancelDelete()">No</button>
                    <button class="btn sm success" onclick="confirmDelete()">Yes</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <script type="module" src="/theme.js"></script>
    <script type="module" src="/auth.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        /* ====== CONSTANTS & STATE ====== */
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const COLORS = [{key: 'none', hex: '#4b5563', icon: 'fa-solid fa-ban'}, {key: 'red',hex: '#ef4444'}, {key: 'blue',hex: '#3b82f6'}, {key: 'green',hex: '#22c55e'}, {key: 'yellow',hex: '#eab308'}, {key: 'purple',hex: '#a855f7'}, {key: 'pink',hex: '#ec4899'}, {key: 'orange',hex: '#f97316'}, {key: 'teal',hex: '#14b8a6'}, {key: 'gray',hex: '#6b7280'}, {key: 'black',hex: '#1f2937'}];
        const TAGS = ['pvp', 'bedwars', 'skywars', 'anime', 'crystal pvp', 'survival', 'visual'];
        const RESOLUTIONS = ['16x', '32x', '64x', '128x'];
        const VERSIONS = ['bedrock', 'java'];
        const packsPerPage = 9;
        let packs = [];
        const state = { q: '', colors: new Set(), tags: new Set(), resolutions: new Set(), versions: new Set(), currentPage: 1, modalColor: null, modalTags: new Set(), modalResolution: null, editColor: null, editTags: new Set(), editResolution: null, sortBy: 'latest' };
        let currentEditId = null;
        let tempModalTags = new Set();
        let isEditingTags = false;
        let currentUserRole = null;
        let uploadMode = 'single'; // 'single' or 'bulk' mode
        
        // Define element references for upload mode switching
        const colorGroup = document.getElementById('color-group');
        const descriptionGroup = document.getElementById('description-group');
        const resTagGroup = document.getElementById('res-tag-group');
        const packNameGroup = document.getElementById('pack-name-group');
        const packNameInput = document.getElementById('packName');
        const singleUploadBtn = document.getElementById('single-upload-btn');
        const bulkUploadBtn = document.getElementById('bulk-upload-btn');
        const fileInput = document.getElementById('fileInput');

        /* ====== API & DATA FUNCTIONS ====== */
        async function loadPacksOnStartup() {
            // UPDATED: Optimized query to fetch Uploader info using RLS-compliant join
            let query = supabase.from('packs').select('*, profiles(username, avatar_url)').not('tags', 'ilike', '%user-upload%');

            if (state.sortBy === 'downloads') {
                query = query.order('download_count', { ascending: false });
            } else {
                query = query.order('created_at', { ascending: false });
            }
            const { data, error } = await query;
            if (error) {
                console.error('Failed to load packs from Supabase', error);
                packs = [];
            } else {
                packs = data.map(pack => ({ ...pack, tags: pack.tags ? pack.tags.split(',') : [] }));
            }
            render();
        }
        
        // FIX: Function to switch between Single and Bulk upload modes (Restored visibility)
        window.setUploadMode = function(mode) {
            uploadMode = mode;
            const modalTitle = document.getElementById('modal-title');
            const modalHint = document.getElementById('modal-hint');

            if (mode === 'bulk') {
                // Hide all non-essential fields (Bulk Upload)
                if(colorGroup) colorGroup.classList.add('bulk-hidden');
                if(descriptionGroup) descriptionGroup.classList.add('bulk-hidden');
                if(resTagGroup) resTagGroup.classList.add('bulk-hidden');
                if(packNameGroup) packNameGroup.classList.add('bulk-hidden');
                
                if(packNameInput) packNameInput.required = false;

                singleUploadBtn.classList.remove('active');
                bulkUploadBtn.classList.add('active');
                modalTitle.textContent = 'Bulk Pack Upload (Fast)';
                modalHint.textContent = 'Select up to 10 files. Name, icon, and version are detected.';
            } else {
                // Restore visibility for Single Upload filters (Single Upload)
                if(colorGroup) colorGroup.classList.remove('bulk-hidden');
                if(descriptionGroup) descriptionGroup.classList.remove('bulk-hidden');
                if(resTagGroup) resTagGroup.classList.remove('bulk-hidden');
                if(packNameGroup) packNameGroup.classList.remove('bulk-hidden');
                
                if(packNameInput) packNameInput.required = true;

                singleUploadBtn.classList.add('active');
                bulkUploadBtn.classList.remove('active');
                modalTitle.textContent = 'Upload Texture Pack';
                modalHint.textContent = 'Select a .mcpack or .zip file, set a name, choose color & tags.';
            }
        }

        // FIX: Core function to handle the actual upload logic for a single file (used in the loop)
        async function uploadSingleFile(packFile, session) {
            const packName = packFile.name.replace(/\.(mcpack|zip)$/i, "").trim();
            
            // Assign values based on the current mode
            const uploadColor = uploadMode === 'bulk' ? 'gray' : state.modalColor;
            const uploadResolution = uploadMode === 'bulk' ? 'unknown' : state.modalResolution;
            const uploadTags = uploadMode === 'bulk' ? 'bulk-upload' : [...state.modalTags].join(",");
            const uploadDescription = uploadMode === 'bulk' ? `Bulk uploaded by ${session.user.email || 'user'}` : document.getElementById("packDescription").value.trim();

            let version = packFile.name.toLowerCase().endsWith(".mcpack") ? "bedrock" : "java";
            let iconUrl = null;

            // 1. Extract Icon from Zip
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(packFile);
                const iconPath = Object.keys(contents.files).find(path => /pack_icon\.png$/i.test(path) || /pack\.png$/i.test(path));

                if (iconPath) {
                    const iconFile = contents.files[iconPath];
                    const iconBlob = await iconFile.async("blob");
                    const iconStoragePath = `icons/${Date.now()}-${packName}-icon.png`;
                    await supabase.storage.from("packs").upload(iconStoragePath, iconBlob);
                    iconUrl = supabase.storage.from("packs").getPublicUrl(iconStoragePath).data.publicUrl;
                }
            } catch (e) {
                console.warn(`Could not extract icon for ${packName}:`, e);
            }

            // 2. Upload Pack File
            const sanitizedName = packFile.name.replace(/[^a-zA-Z0-9-._]/g, "").replace(/\s+/g, "-");
            const packStoragePath = `${Date.now()}-${sanitizedName}`;
            await supabase.storage.from("packs").upload(packStoragePath, packFile);

            // 3. Add Metadata
            const response = await fetch("/api/addpacks", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${session.access_token}` },
                body: JSON.stringify({
                    name: packName,
                    color: uploadColor, 
                    tags: uploadTags, 
                    filename: packStoragePath,
                    resolution: uploadResolution, 
                    version, 
                    description: uploadDescription, 
                    icon_url: iconUrl
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.details || errorData.error || `Failed to add metadata for ${packName}.`);
            }
            return packName;
        }

        // FIX: Refactored handleUpload to manage file list and looping
        window.handleUpload = async function(e) {
            e.preventDefault();
            const files = fileInput.files;
            const submitBtn = document.getElementById("submitBtn");
            const formFieldset = document.getElementById("uploadFormFieldset");
            const originalBtnContent = submitBtn.innerHTML;

            if (files.length === 0) {
                return showToast("Please select at least one file.", "error");
            }
            if (uploadMode === 'single' && files.length > 1) {
                return showToast("Please use Bulk Upload mode for multiple files.", "error");
            }
            if (files.length > 10) {
                return showToast("Please select a maximum of 10 files for bulk upload.", "error");
            }
            
            // Single Upload Validation (Restored)
            if (uploadMode === 'single') {
                if (!state.modalColor) { return showToast("You forgot to select a primary color.", "error"); }
                if (!state.modalResolution) { return showToast("You forgot to select a resolution.", "error"); }
            }

            submitBtn.disabled = true;
            formFieldset.disabled = true;

            try {
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !session) throw new Error("You must be logged in to upload packs.");
                
                const filesArray = Array.from(files);
                const successfulUploads = [];
                
                for (let i = 0; i < filesArray.length; i++) {
                    const file = filesArray[i];
                    submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Uploading ${i + 1}/${filesArray.length}...`;
                    
                    try {
                        const name = await uploadSingleFile(file, session);
                        successfulUploads.push(name);
                    } catch (error) {
                        console.error(`Upload failed for ${file.name}:`, error);
                        // Show toast for failed file but continue with others
                        showToast(`Failed to upload ${file.name}.`, "error");
                    }
                }
                
                if (successfulUploads.length > 0) {
                    showToast(`Successfully uploaded ${successfulUploads.length} pack(s)!`, "success");
                    await loadPacksOnStartup(); // Refresh the list
                }
                
                closeModal();

            } catch (error) {
                showToast(error.message || "An unknown error occurred.", "error");
            } finally {
                submitBtn.disabled = false;
                formFieldset.disabled = false;
                submitBtn.innerHTML = originalBtnContent;
                fileInput.value = null; // Clear the input
            }
        }
        
        window.saveEdit = async function(e) {
            e.preventDefault();
            if (!currentEditId) return;
            try {
                const updates = {
                    name: document.getElementById("editPackName").value.trim(),
                    description: document.getElementById("editPackDescription").value.trim(),
                    color: state.editColor, tags: [...state.editTags].join(","),
                    resolution: state.editResolution
                };
                const { error } = await supabase.from("packs").update(updates).eq("id", currentEditId);
                if (error) throw error;
                showToast("Pack saved successfully!", "success");
                await loadPacksOnStartup();
                closeEditModal();
            } catch (error) { showToast("Save failed: " + error.message, "error"); }
        }

        window.confirmDelete = async function() {
            if (!currentEditId) return;
            const pack = packs.find(p => p.id === currentEditId);
            if (!pack) return cancelDelete();
            try {
                // Find session for authorization token
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error("User must be logged in to delete packs.");

                const response = await fetch("/api/delete-pack", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${session.access_token}` },
                    body: JSON.stringify({ packId: currentEditId })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || "Failed to delete pack.");
                }
                
                await loadPacksOnStartup(); // Reload data after successful deletion
                showToast("Pack deleted successfully!", "success");
            } catch (error) {
                showToast("Delete failed: " + error.message, "error");
            } finally {
                cancelDelete();
                closeEditModal();
            }
        }

        window.handleDownload = async function(event, packId, filename, packName) {
            event.preventDefault();
            try {
                // Increment download count (assuming /api/increment-download is available)
                fetch("/api/increment-download", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: packId })
                }).then(res => res.json()).then(data => {
                    // Update UI count immediately
                    const el = document.getElementById(`downloads-${packId}`);
                    if (el) el.textContent = (parseInt(el.textContent.replace(/,/g, ''), 10) + 1).toLocaleString();
                }).catch(e => console.error("Failed to update download count:", e));


                // Trigger download
                const { data } = supabase.storage.from('packs').getPublicUrl(filename);
                fetch(data.publicUrl).then(res => res.blob()).then(blob => {
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    a.download = `${packName}.${filename.split('.').pop()}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                });
            } catch (error) { console.error("Download handling error:", error); }
        }

        /* ====== UI RENDERING ====== */
        function render() {
            const grid = document.getElementById('grid');
            const filtered = packs.filter(p => 
                (!state.q || p.name.toLowerCase().includes(state.q) || p.profiles?.username?.toLowerCase().includes(state.q)) &&
                (state.colors.size === 0 || state.colors.has(p.color)) &&
                (state.tags.size === 0 || [...state.tags].every(t => (p.tags || []).includes(t))) &&
                (state.resolutions.size === 0 || state.resolutions.has(p.resolution)) &&
                (state.versions.size === 0 || state.versions.has(p.version))
            );

            const startIndex = (state.currentPage - 1) * packsPerPage;
            const packsForPage = filtered.slice(startIndex, startIndex + packsPerPage);

            grid.innerHTML = packsForPage.length === 0 
                ? '<div class="card panel tiny" style="grid-column: 1 / -1;">No packs match your filters.</div>' 
                : packsForPage.map(renderCard).join('');

            renderPagination(filtered.length);
        }

        function renderPagination(totalPacks) {
            const controls = document.getElementById("pagination-controls");
            controls.innerHTML = "";
            const totalPages = Math.ceil(totalPacks / packsPerPage);
            if (totalPages <= 1) return;

            if (state.currentPage > 1) {
                controls.innerHTML += `<button class="pagination-btn" onclick="prevPage()"><i class="fa-solid fa-arrow-left"></i></button>`;
            }
            controls.innerHTML += `<span class="tiny">Page ${state.currentPage} of ${totalPages}</span>`;
            if (state.currentPage < totalPages) {
                controls.innerHTML += `<button class="pagination-btn" onclick="nextPage()"><i class="fa-solid fa-arrow-right"></i></button>`;
            }
        }
        
        function scrollToContentTop() {
            const header = document.querySelector("header");
            const mainContent = document.getElementById("main-content");
            if (!header || !mainContent) return;
            const headerHeight = header.offsetHeight;
            const contentTop = mainContent.offsetTop;
            window.scrollTo({ top: contentTop - headerHeight - 14, behavior: "smooth" });
        }

        window.nextPage = () => { state.currentPage++; scrollToContentTop(); render(); }
        window.prevPage = () => { state.currentPage--; scrollToContentTop(); render(); }

        function renderCard(p) {
            const color = COLORS.find(c => c.key === p.color)?.hex || '#6b7280';
            
            // Uploader info extraction
            const uploaderUsername = p.profiles?.username || 'Unknown';
            const uploaderAvatar = p.profiles?.avatar_url || `https://placehold.co/18x18/1c1c1c/de212a?text=${(uploaderUsername.charAt(0) || 'U').toUpperCase()}`;
            const uploaderProfileLink = `/profile.html?user=${encodeURIComponent(uploaderUsername)}`;
            
            // Added loading="lazy" to pack icon
            const thumbContent = p.icon_url 
                ? `<div class="pack-icon-bg" style="background-image: url('${p.icon_url}');"></div><img class="pack-icon" src="${p.icon_url}" alt="${escapeHtml(p.name)} Icon" loading="lazy">`
                : `<div class="glyph" style="background:${color}"><i class="fa-solid fa-cube"></i></div>`;
            const thumbBackgroundStyle = p.icon_url ? `background: linear-gradient(135deg,#1f2937,#0f172a);` : `background:linear-gradient(135deg, ${shade(color, -20)}, ${shade(color, 20)})`;
            
            const downloadLink = `<a href="#" onclick="handleDownload(event, ${p.id}, '${p.filename}', '${escapeHtml(p.name)}')"><i class="fa-solid fa-download"></i> Download</a>`;
            const editLink = currentUserRole === 'admin' ? `<a href="#" onclick="openEditModal(${p.id}); event.preventDefault();"><i class="fa-regular fa-pen-to-square"></i> Edit</a>` : '';

            return `
                <div class="card pack">
                    <div class="thumb" style="${thumbBackgroundStyle}">
                        ${thumbContent}
                        <button class="pack-options-btn" onclick="toggleOptionsMenu(event, ${p.id})"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        <div class="pack-options-menu" id="options-menu-${p.id}">${downloadLink}${editLink}</div>
                    </div>
                    <div class="content">
                        <div class="pack-stats-top">
                            <div class="stat-item"><i class="fa-solid fa-download"></i><span id="downloads-${p.id}">${(p.download_count || 0).toLocaleString()}</span></div>
                            <div class="stat-item"><i class="fa-solid fa-calendar-day"></i><span>${formatDate(p.created_at)}</span></div>
                        </div>
                        
                        <!-- Pack name and Uploader info -->
                        <div class="pack-name-row">
                            <h4>${escapeHtml(p.name)}</h4>
                            <a class="uploader-info" href="${uploaderProfileLink}">
                                <img class="uploader-avatar" src="${uploaderAvatar}" alt="${uploaderUsername}" loading="lazy">
                                <span class="uploader-name">${escapeHtml(uploaderUsername)}</span>
                            </a>
                        </div>
                        
                        <div class="meta">
                            ${(p.color && p.color !== 'none') ? `<span class="badge">${escapeHtml(p.color)}</span>` : ''}
                            ${p.resolution ? `<span class="badge">${escapeHtml(p.resolution)}</span>` : ''}
                            ${p.version ? `<span class="badge">${escapeHtml(p.version)}</span>` : ''}
                            ${(p.tags||[]).map(t=>`<span class="badge">${escapeHtml(capitalizeFirst(t))}</span>`).join('')}
                        </div>
                    </div>
                </div>`;
        }

        function buildSwatches(container, onSelect, selected) {
            container.innerHTML = COLORS.map(c => `<button type="button" class="swatch${selected && selected.has(c.key) ? ' active' : ''}" style="background:${c.hex}" title="${c.key}" onclick="this.dispatchEvent(new CustomEvent('swatch-select', {bubbles: true, detail: {key: '${c.key}', el: this}}))">${c.icon ? `<i class="${c.icon}"></i>` : ''}</button>`).join('');
            container.addEventListener('swatch-select', e => onSelect(e.detail.key, e.detail.el));
        }
        function buildModalTags(container, selected, filter = '') {
            const filteredTags = TAGS.filter(tag => tag.toLowerCase().includes(filter.toLowerCase()));
            container.innerHTML = filteredTags.length === 0 ? '<div class="tiny" style="grid-column: 1 / -1; text-align: center;">No tags found.</div>'
                : filteredTags.map(tag => `<span class="tag-checkbox${selected.has(tag) ? ' selected' : ''}" onclick="this.dispatchEvent(new CustomEvent('tag-select', {bubbles: true, detail: {key: '${tag}', el: this}}))">${capitalizeFirst(tag)}</span>`).join('');
            container.addEventListener('tag-select', e => { toggleSet(tempModalTags, e.detail.key); e.detail.el.classList.toggle('selected'); });
        }
        function buildSidebarTags(container, onSelect, selected) {
            container.innerHTML = TAGS.map(tag => `<button type="button" class="tag${selected?.has(tag) ? ' active' : ''}" onclick="this.dispatchEvent(new CustomEvent('sidebar-tag-select', {bubbles: true, detail: {key: '${tag}', el: this}}))">${capitalizeFirst(tag)}</button>`).join('');
            container.addEventListener('sidebar-tag-select', e => { toggleSet(state.tags, e.detail.key); render(); });
        }
        function buildSelectorBoxes(container, onSelect, selected, options) {
            container.innerHTML = options.map(opt => `<button type="button" class="res-box${(selected instanceof Set ? selected.has(opt) : selected === opt) ? ' active' : ''}" onclick="this.dispatchEvent(new CustomEvent('box-select', {bubbles: true, detail: {key: '${opt}', el: this}}))">${opt}</button>`).join('');
            container.addEventListener('box-select', e => onSelect(e.detail.key, e.detail.el));
        }

        window.openModal = function() {
            document.getElementById("backdrop").style.display = "flex";
            state.modalColor = null; state.modalResolution = null; state.modalTags.clear();
            buildSwatches(document.getElementById("modalSwatches"), (k, el) => { state.modalColor = k; highlightOne(el.parentElement, el); }, null);
            buildSelectorBoxes(document.getElementById("modalResolutions"), (k, el) => { state.modalResolution = k; highlightOne(el.parentElement, el); }, null, RESOLUTIONS);
            updateTagButtonText();
            // Set the default mode when opening modal
            setUploadMode('single'); 
        }
        window.closeModal = function() { 
            document.getElementById("backdrop").style.display = "none"; 
            document.getElementById("uploadForm").reset(); 
            // Reset to single mode after close
            uploadMode = 'single';
        }
        
        // P1 Fix: Updated hintFile to handle multiple files in bulk mode and restore features
        window.hintFile = () => {
            const files = fileInput.files;
            if (files.length === 1) {
                document.getElementById("fileHint").textContent = files[0].name;
                packNameInput.value = files[0].name.replace(/\.(mcpack|zip)$/i, "");
                setUploadMode('single'); // Revert to single mode if only one file selected
            } else if (files.length > 1) {
                document.getElementById("fileHint").textContent = `${files.length} files selected.`;
                setUploadMode('bulk'); // Automatically switch to bulk mode
            } else {
                 document.getElementById("fileHint").textContent = '.mcpack or .zip files only';
            }
        };

        window.openTagModal = () => openTagEditor(false);
        window.openEditTagModal = () => openTagEditor(true);
        function openTagEditor(isEditMode) {
            isEditingTags = isEditMode;
            tempModalTags = new Set(isEditMode ? state.editTags : state.modalTags);
            const searchInput = document.getElementById("tagSearchInput");
            searchInput.value = "";
            const body = document.querySelector("#tagSelectModal .modal-body");
            const update = () => buildModalTags(body, tempModalTags, searchInput.value);
            searchInput.oninput = update;
            update();
            document.getElementById("tag-select-backdrop").style.display = "flex";
        }
        window.closeTagModal = function(save) {
            if (save) {
                if (isEditingTags) { state.editTags = new Set(tempModalTags); updateEditTagButtonText(); } 
                else { state.modalTags = new Set(tempModalTags); updateTagButtonText(); }
            }
            document.getElementById("tag-select-backdrop").style.display = "none";
        };
        window.openEditModal = function(id) {
            const pack = packs.find(p => p.id === id);
            if (!pack) return alert("Pack not found");
            currentEditId = id;
            document.getElementById("editId").value = id;
            document.getElementById("editPackName").value = pack.name || "";
            document.getElementById("editPackDescription").value = pack.description || "";
            state.editColor = pack.color || null;
            state.editTags = new Set(pack.tags || []);
            state.editResolution = pack.resolution || null;
            buildSwatches(document.getElementById("editModalSwatches"), (k, el) => { state.editColor = k; highlightOne(el.parentElement, el); }, new Set([state.editColor]));
            buildSelectorBoxes(document.getElementById("editModalResolutions"), (k, el) => { state.editResolution = k; highlightOne(el.parentElement, el); }, state.editResolution, RESOLUTIONS);
            updateEditTagButtonText();
            document.getElementById("editBackdrop").style.display = "flex";
        };
        window.closeEditModal = function() { currentEditId = null; document.getElementById("editBackdrop").style.display = "none"; };
        window.promptDelete = function() { if(currentEditId) document.getElementById("confirmDeleteBackdrop").style.display = "flex"; };
        window.cancelDelete = function() { document.getElementById("confirmDeleteBackdrop").style.display = "none"; };
        
        function applySearch(query) {
            state.currentPage = 1; 
            state.q = query.trim().toLowerCase(); 
            render();
        }
        window.applyFilters = () => applySearch(document.getElementById("q").value);
        window.applyMobileSearch = () => applySearch(document.getElementById("mobile-q").value);

        function clearSearchInput() {
            document.getElementById("q").value = "";
            document.getElementById("mobile-q").value = "";
        }
        window.clearSearch = () => { clearSearchInput(); applyFilters(); };
        window.clearMobileSearch = () => { clearSearchInput(); applyMobileSearch(); };

        window.clearColors = () => { state.colors.clear(); buildSwatches(document.getElementById("colorSwatches"), (k, el) => { toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors); render(); };
        window.clearTags = () => { state.tags.clear(); buildSidebarTags(document.getElementById("tagCloud"), (k, el) => { toggleSet(state.tags, k); el.classList.toggle('active'); render(); }, state.tags); render(); };
        window.clearResolutions = () => { state.resolutions.clear(); buildSelectorBoxes(document.getElementById("resolutionBoxes"), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions, RESOLUTIONS); render(); };
        window.clearVersions = () => { state.versions.clear(); buildSelectorBoxes(document.getElementById("versionBoxes"), (v, el) => { toggleSet(state.versions, v); el.classList.toggle('active'); render(); }, state.versions, VERSIONS); render(); };
        window.resetAll = () => { state.q = ''; state.currentPage = 1; clearSearchInput(); clearColors(); clearTags(); clearResolutions(); clearVersions(); };
        
        window.toggleOptionsMenu = (e, id) => {
            e.stopPropagation();
            const menu = document.getElementById(`options-menu-${id}`);
            const isVisible = menu.style.display === 'block';
            document.querySelectorAll(".pack-options-menu").forEach(m => m.style.display = 'none');
            if (!isVisible) menu.style.display = 'block';
        };
        
        window.toggleSortMenu = (isMobile = false) => {
            const menu = document.getElementById(isMobile ? "mobileSortMenu" : "sortMenu");
            const container = document.getElementById(isMobile ? "mobileSortContainer" : "sortContainer");
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            container.classList.toggle('open');
        };
        
        window.setSort = (sortBy, el, isMobile = false) => {
            event.preventDefault();
            state.sortBy = sortBy; state.currentPage = 1;
            
            document.getElementById("currentSort").textContent = el.textContent;
            document.getElementById("mobileCurrentSort").textContent = el.textContent;
            
            document.querySelectorAll("#sortMenu a, #mobileSortMenu a").forEach(a => a.classList.remove('active'));
            document.querySelector(`#sortMenu a[onclick*="'${sortBy}'"]`).classList.add('active');
            document.querySelector(`#mobileSortMenu a[onclick*="'${sortBy}'"]`).classList.add('active');

            toggleSortMenu(isMobile);
            loadPacksOnStartup();
        };

        function updateTagButtonText() {
            const btnText = document.getElementById("tagSelectorBtnText");
            const count = state.modalTags.size;
            btnText.textContent = count === 0 ? "Select Tags" : `${count} Tag${count > 1 ? 's' : ''} Selected`;
        }
        function updateEditTagButtonText() {
            const btnText = document.getElementById("editTagSelectorBtnText");
            const count = state.editTags.size;
            btnText.textContent = count === 0 ? "Select Tags" : `${count} Tag${count > 1 ? 's' : ''} Selected`;
        }

        function capitalizeFirst(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : ""; }
        function showToast(message, type = "error") {
            const container = document.getElementById("toast-container");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${escapeHtml(message)}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        function formatDate(iso) {
            if (!iso) return "";
            const d = new Date(iso);
            return `${d.getDate()}/${d.getMonth() + 1}/${String(d.getFullYear()).slice(-2)}`;
        }
        function escapeHtml(str) { return String(str || "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])); }
        function shade(color, percent) {
            let f = parseInt(color.slice(1), 16), t = percent < 0 ? 0 : 255, p = percent < 0 ? percent * -1 : percent, R = f >> 16, G = f >> 8 & 0x00FF, B = f & 0x0000FF;
            return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1);
        }
        function highlightOne(parent, el) { [...parent.children].forEach(c => c.classList.remove('active')); el.classList.add('active'); }
        function toggleSet(set, item) { set.has(item) ? set.delete(item) : set.add(item); }

        /* ====== INITIALIZATION ====== */
        async function checkUserAndInitialize() {
            const { data: { user } } = await supabase.auth.getUser();
            const mobileUploadBtn = document.getElementById('mobile-upload-btn'); // P3 FIX

            if (user) {
                const { data: profile } = await supabase.from('profiles').select('role').eq('id', user.id).single();
                if (profile) currentUserRole = profile.role;
            }
            if (currentUserRole === 'admin') { 
                document.getElementById('admin-actions').style.display = 'block'; 
                // P3 FIX: Show mobile upload button for admins
                if (mobileUploadBtn) mobileUploadBtn.style.display = 'block'; 
            }
            await loadPacksOnStartup();
        }

        function init() {
            if (document.getElementById('grid')) {
                const mobileFilterPanel = document.getElementById('mobile-filters-panel');
                const desktopSidebar = document.querySelector('.sidebar');
                // Ensure mobile filter panel is populated with desktop sidebar content
                if (mobileFilterPanel && desktopSidebar) {
                    mobileFilterPanel.innerHTML = desktopSidebar.innerHTML;
                }
                
                // --- SETUP FOR BOTH DESKTOP AND MOBILE ---
                const filterAreas = [
                    { container: desktopSidebar, isMobile: false },
                    { container: mobileFilterPanel, isMobile: true }
                ];
                
                filterAreas.forEach(area => {
                    // Update: Click handler for sidebar tags/colors/res now calls render() to update pack list
                    const colorSwatches = area.container.querySelector('#colorSwatches');
                    if(colorSwatches) buildSwatches(colorSwatches, (k, el) => { toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors);
                    
                    const tagCloud = area.container.querySelector('#tagCloud');
                    if(tagCloud) buildSidebarTags(tagCloud, (k, el) => { toggleSet(state.tags, k); el.classList.toggle('active'); render(); }, state.tags);
                    
                    const resolutionBoxes = area.container.querySelector('#resolutionBoxes');
                    if(resolutionBoxes) buildSelectorBoxes(resolutionBoxes, (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions, RESOLUTIONS);
                    
                    const versionBoxes = area.container.querySelector('#versionBoxes');
                    if(versionBoxes) buildSelectorBoxes(versionBoxes, (v, el) => { toggleSet(state.versions, v); el.classList.toggle('active'); render(); }, state.versions, VERSIONS);

                    const adminActions = area.container.querySelector('#admin-actions');
                    if (adminActions && currentUserRole === 'admin') {
                        adminActions.style.display = 'block';
                    }
                });
                
                // --- EVENT LISTENERS ---
                const mobileFilterBtn = document.getElementById('mobile-filter-btn');
                mobileFilterBtn.addEventListener('click', () => {
                    const panel = document.getElementById('mobile-filters-panel');
                    panel.classList.toggle('show');
                    const isShown = panel.classList.contains('show');
                    mobileFilterBtn.innerHTML = isShown ? '<i class="fa-solid fa-xmark"></i> Close Filters' : '<i class="fa-solid fa-sliders"></i> Choose Filters';
                });

                window.addEventListener('click', (e) => {
                    if (!e.target.closest('.pack-options-btn')) document.querySelectorAll('.pack-options-menu').forEach(menu => menu.style.display = 'none');
                    if (!e.target.closest('#sortContainer')) {
                        document.getElementById('sortMenu').style.display = 'none';
                        document.getElementById('sortContainer').classList.remove('open');
                    }
                     if (!e.target.closest('#mobileSortContainer')) {
                        document.getElementById('mobileSortMenu').style.display = 'none';
                        document.getElementById('mobileSortContainer').classList.remove('open');
                    }
                });
                
                checkUserAndInitialize();
            }
        }
        init();
    </script>
</body>

</html>
