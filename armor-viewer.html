<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Armor Viewer - MCHub</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/bundles/skinview3d.bundle.js"></script>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
    .viewer-layout { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; padding: 1rem; }
    .card { background: #111; border-radius: 12px; padding: 1rem; }
    .armor-item { padding: .6rem 1rem; border-radius: 8px; margin-bottom: .4rem; cursor: pointer; background: #222; }
    .armor-item.active { background: #c62828; }
    #viewer-canvas { width: 100%; aspect-ratio: 4/5; border-radius: 12px; background: #111; }
  </style>
</head>
<body>
  <main class="viewer-layout">
    <div>
      <div class="card">
        <h3>Upload Pack</h3>
        <div id="upload-area" style="padding:1rem;border:2px dashed #555;cursor:pointer;text-align:center;">
          Click or drop a .zip/.mcpack
        </div>
        <input type="file" id="file-input" accept=".zip,.mcpack" style="display:none">
      </div>
      <div class="card" style="margin-top:1rem;">
        <h3>Found Armor</h3>
        <div id="armor-list"><p>No pack loaded</p></div>
      </div>
    </div>
    <div>
      <canvas id="viewer-canvas"></canvas>
    </div>
  </main>

<script>
  const ARMOR_PATHS_JAVA = [
    'assets/minecraft/textures/models/armor/netherite_layer_1.png', 'assets/minecraft/textures/models/armor/netherite_layer_2.png',
    'assets/minecraft/textures/models/armor/diamond_layer_1.png', 'assets/minecraft/textures/models/armor/diamond_layer_2.png',
    'assets/minecraft/textures/models/armor/iron_layer_1.png', 'assets/minecraft/textures/models/armor/iron_layer_2.png',
    'assets/minecraft/textures/models/armor/gold_layer_1.png', 'assets/minecraft/textures/models/armor/gold_layer_2.png',
    'assets/minecraft/textures/models/armor/chainmail_layer_1.png', 'assets/minecraft/textures/models/armor/chainmail_layer_2.png',
    'assets/minecraft/textures/models/armor/leather_layer_1.png', 'assets/minecraft/textures/models/armor/leather_layer_2.png',
    'assets/minecraft/textures/models/armor/turtle_layer_1.png'
  ];
  const ARMOR_PATHS_BEDROCK = [
    'textures/models/armor/netherite_1.png', 'textures/models/armor/netherite_2.png',
    'textures/models/armor/diamond_1.png', 'textures/models/armor/diamond_2.png',
    'textures/models/armor/iron_1.png', 'textures/models/armor/iron_2.png',
    'textures/models/armor/gold_1.png', 'textures/models/armor/gold_2.png',
    'textures/models/armor/chainmail_1.png', 'textures/models/armor/chainmail_2.png',
    'textures/models/armor/leather_1.png', 'textures/models/armor/leather_2.png',
    'textures/models/armor/turtle_1.png'
  ];

  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const armorList = document.getElementById('armor-list');
  const canvas = document.getElementById('viewer-canvas');

  let skinViewer;
  let foundArmor = {};

  function initSkinViewer() {
    skinViewer = new skinview3d.SkinViewer({
      canvas: canvas,
      width: canvas.clientWidth,
      height: canvas.clientHeight,
      skin: "https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/steve.png"
    });

    const control = skinview3d.createOrbitControls(skinViewer);
    control.enableRotate = true;
    control.enableZoom = true;
    control.enablePan = false;

    new ResizeObserver(() => {
      skinViewer.setSize(canvas.clientWidth, canvas.clientHeight);
    }).observe(canvas);
  }

  function handleFileSelect(file) {
    if (!file) return;
    armorList.innerHTML = `<p>Searching pack...</p>`;
    foundArmor = {};

    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        const zip = await JSZip.loadAsync(event.target.result);
        const allArmorPaths = [...ARMOR_PATHS_JAVA, ...ARMOR_PATHS_BEDROCK];
        
        for (const path of allArmorPaths) {
          const f = zip.file(path);
          if (f) {
            const blob = await f.async('blob');
            const url = URL.createObjectURL(blob);
            let armorName = path.split('/').pop().split('_')[0];
            if (armorName === 'chainmail') armorName = 'chain';
            const layer = path.includes('layer_2') || path.includes('_2.png') ? 'layer2' : 'layer1';
            if (!foundArmor[armorName]) foundArmor[armorName] = {};
            foundArmor[armorName][layer] = url;
          }
        }
        renderArmorList();
      } catch (error) {
        console.error("Error processing pack:", error);
        armorList.innerHTML = `<p>Could not read the pack file.</p>`;
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function renderArmorList() {
    const armorNames = Object.keys(foundArmor);
    if (armorNames.length === 0) {
      armorList.innerHTML = `<p>No standard armor found</p>`;
      return;
    }
    armorList.innerHTML = armorNames.map(name => 
      `<div class="armor-item" data-armor="${name}">${name}</div>`
    ).join('');
    armorList.querySelectorAll('.armor-item').forEach(item => {
      item.addEventListener('click', () => {
        armorList.querySelectorAll('.armor-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        applyArmor(item.dataset.armor);
      });
    });
    armorList.querySelector('.armor-item').click();
  }

  function applyArmor(armorName) {
    if (!skinViewer || !foundArmor[armorName]) return;
    const armorSet = foundArmor[armorName];
    const textureLoader = new THREE.TextureLoader();

    const applyTexture = (mesh, url) => {
      if (!mesh) return;
      if (url) {
        textureLoader.load(url, (texture) => {
          texture.magFilter = THREE.NearestFilter;
          texture.minFilter = THREE.NearestFilter;
          mesh.material.map = texture;
          mesh.material.needsUpdate = true;
          mesh.visible = true;
        });
      } else {
        mesh.visible = false;
      }
    };

    const player = skinViewer.playerObject;
    const skinMesh = player.skinMesh;

    // get parts by name (skinview3d v3 uses standard mesh children)
    const head = skinMesh.children.find(c => c.name === "head");
    const body = skinMesh.children.find(c => c.name === "body");
    const leftArm = skinMesh.children.find(c => c.name === "leftArm");
    const rightArm = skinMesh.children.find(c => c.name === "rightArm");
    const leftLeg = skinMesh.children.find(c => c.name === "leftLeg");
    const rightLeg = skinMesh.children.find(c => c.name === "rightLeg");

    // Layer1: helmet, chest, arms, boots
    applyTexture(head, armorSet.layer1);
    applyTexture(body, armorSet.layer1);
    applyTexture(leftArm, armorSet.layer1);
    applyTexture(rightArm, armorSet.layer1);

    // Boots â†’ reuse legs but hide leggings later
    applyTexture(leftLeg, armorSet.layer1);
    applyTexture(rightLeg, armorSet.layer1);

    // Layer2: leggings (override legs if found)
    if (armorSet.layer2) {
      applyTexture(leftLeg, armorSet.layer2);
      applyTexture(rightLeg, armorSet.layer2);
    }
  }

  uploadArea.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
  uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); });
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    if (e.dataTransfer.files.length > 0) {
      handleFileSelect(e.dataTransfer.files[0]);
    }
  });

  document.addEventListener('DOMContentLoaded', initSkinViewer);
</script>
</body>
</html>
