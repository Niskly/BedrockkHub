<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BedrockHub — Texture Packs</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; margin:0; padding:0; }
    header { background:#222; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    .packs { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:15px; padding:20px; }
    .pack { background:#1e1e1e; border-radius:10px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,.4); }
    .pack h3 { margin:0 0 10px; }
    .pack .tags span { background:#333; padding:2px 8px; margin-right:5px; border-radius:6px; font-size:12px; }
    .btn { background:#444; color:#fff; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#666; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; visibility:hidden; }
    .modal.active { visibility:visible; }
    .modal-content { background:#222; padding:20px; border-radius:10px; width:300px; }
    .color-option { display:inline-block; width:20px; height:20px; border-radius:50%; margin:5px; cursor:pointer; border:2px solid #444; }
    .color-option.selected { border:2px solid #fff; }
  </style>
</head>
<body>
  <header>
    <h1>BedrockHub</h1>
    <button class="btn" onclick="openModal()">Upload Pack</button>
  </header>

  <main>
    <div class="packs" id="packs"></div>
  </main>

  <!-- Upload Modal -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <h2>Upload Pack</h2>
      <form id="uploadForm">
        <label>Pack Name:</label>
        <input type="text" id="packName" required /><br/><br/>
        <label>Select File (.mcpack):</label>
        <input type="file" id="fileInput" accept=".mcpack" required /><br/><br/>
        <label>Color:</label><br/>
        <div id="colorOptions"></div><br/>
        <label>Tags:</label><br/>
        <input type="text" id="tagsInput" placeholder="Comma separated" /><br/><br/>
        <button type="submit" class="btn">Save</button>
        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const packsEl = document.getElementById('packs');
    const modal = document.getElementById('uploadModal');
    const form = document.getElementById('uploadForm');
    const colorOptionsEl = document.getElementById('colorOptions');
    const state = { modalColor:null, modalTags:[] };
    let packs = [];

    // IndexedDB Setup
    let db;
    const request = indexedDB.open("packsDB",1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      db.createObjectStore("packs",{ keyPath:"id" });
    };
    request.onsuccess = e => { db = e.target.result; loadPacks(); };

    function putPackToIDB(pack){
      return new Promise((resolve,reject)=>{
        const tx = db.transaction("packs","readwrite");
        tx.objectStore("packs").put(pack);
        tx.oncomplete=()=>resolve();
        tx.onerror=e=>reject(e);
      });
    }

    function loadPacks(){
      const tx = db.transaction("packs","readonly");
      const store = tx.objectStore("packs");
      const req = store.getAll();
      req.onsuccess = e => { packs = e.target.result; render(); };
    }

    function render(){
      packsEl.innerHTML = "";
      packs.forEach(p=>{
        const div = document.createElement("div");
        div.className="pack";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <div class="tags">${p.tags.map(t=>`<span>${t}</span>`).join("")}</div>
          <small style="color:${p.color}">Color: ${p.color}</small>
        `;
        packsEl.appendChild(div);
      });
    }

    // Modal Controls
    function openModal(){
      modal.classList.add("active");
      state.modalColor=null;
      state.modalTags=[];
    }
    function closeModal(){ modal.classList.remove("active"); }

    // Color Options
    const colors = ["#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6","#e67e22"];
    colors.forEach(c=>{
      const div=document.createElement("div");
      div.className="color-option";
      div.style.background=c;
      div.onclick=()=>{ 
        document.querySelectorAll(".color-option").forEach(el=>el.classList.remove("selected"));
        div.classList.add("selected"); 
        state.modalColor=c; 
      };
      colorOptionsEl.appendChild(div);
    });

    // Upload handler
    form.addEventListener("submit", handleUpload);

    async function handleUpload(e){
      e.preventDefault();

      const name = document.getElementById('packName').value.trim();
      const file = document.getElementById('fileInput').files[0];

      if(!file || !file.name.endsWith('.mcpack')){
        alert('Please select a valid .mcpack file');
        return;
      }
      if(!state.modalColor){
        alert('Pick a primary color');
        return;
      }

      const tags = document.getElementById("tagsInput").value.split(",").map(t=>t.trim()).filter(t=>t);

      // 1. Save locally
      const newPack = {
        id: Date.now(),
        name,
        color: state.modalColor,
        tags,
        fileName: file.name
      };
      packs.push(newPack);
      await putPackToIDB(newPack);
      await render();
      closeModal();

      // 2. Send to backend (Supabase)
      try {
        const res = await fetch('/api/addPack', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            name,
            color: state.modalColor,
            tags,
            filename: file.name
          })
        });
        const result = await res.json();
        if(result.status === "success"){
          console.log("✅ Saved to Supabase", result.data);
        } else {
          console.error("❌ Supabase error:", result.error);
          alert("Backend error: " + result.error);
        }
      } catch(err){
        console.error("Upload failed", err);
        alert("Could not connect to backend");
      }
    }
  </script>
</body>
</html>
