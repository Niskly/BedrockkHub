<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BedrockHub — Texture Packs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-0: #000000;
            --bg-1: #1c1c1c;
            --bg-2: #2c2c2c;
            --muted: #a8b3cf;
            --text: #e8eefc;
            --border: rgba(255, 255, 255, .12);
            --brand-1: #de212a;
            --brand-2: #b21a22;
            --danger: #ef4444;
            --success: #22c55e;
            --border-strong: rgba(255, 255, 255, .2);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; scroll-behavior: smooth; }
        body {
            margin: 0;
            background-color: var(--bg-0);
            color: var(--text);
            font: 500 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
            position: relative;
            z-index: 1;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(8px);
            opacity: 0.25;
            z-index: -1;
        }
        a { color: inherit; text-decoration: none; }
        header {
            position: sticky; top: 0; z-index: 50;
            backdrop-filter: saturate(1.2) blur(10px);
            background: rgba(12, 12, 12, 0.7);
            border-bottom: 1px solid var(--border);
        }
        .nav { max-width: 1200px; margin: 0 auto; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge {
            height: 44px; width: 44px; border-radius: 12px;
            display: grid; place-items: center;
            background: linear-gradient(135deg, var(--brand-2), var(--brand-1));
            box-shadow: 0 12px 30px rgba(222, 33, 42, .22);
        }
        .brand-title { font-weight: 800; letter-spacing: .6px; }
        .nav-actions { display: flex; gap: .6rem; }
        .btn { padding: .6rem 1rem; border-radius: 12px; font-weight: 700; display: inline-flex; align-items: center; gap: .55rem; cursor: pointer; border: 1px solid transparent; }
        .ghost { border-color: var(--border); background: transparent; color: var(--text); }
        .primary {
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            box-shadow: 0 10px 30px rgba(222, 33, 42, .22);
            color: white;
        }
        .btn.danger { background-color: #ef444420; border-color: #ef444490; color: var(--danger); }
        .btn.success { background-color: #22c55e20; border-color: #22c55e90; color: var(--success); }
        .container { max-width: 1200px; margin: 0 auto; padding: 28px 18px; }
        .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        .sidebar { position: sticky; top: 78px; height: fit-content; }
        .card { background: var(--bg-1); border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 24px 70px rgba(0, 0, 0, .55); }
        .panel { padding: 18px; }
        .panel h3 { margin: 0 0 10px 0; font-size: 14px; letter-spacing: .4px; color: #cbd5e1; text-transform: uppercase; }
        .search { display: flex; align-items: center; position: relative; }
        .search input { flex: 1; padding: .7rem 1rem; padding-right: 2.5rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); min-width: 0; }
        .search .btn.sm.ghost { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: .5rem; line-height: 1; height: 32px; width: 32px; display: grid; place-items: center; background: transparent; border: none; color: var(--muted); }
        .swatches, .resolutions { display: flex; flex-wrap: wrap; gap: 8px; }
        .swatch { width: 34px; height: 34px; border-radius: 999px; border: 2px solid rgba(255, 255, 255, .12); cursor: pointer; position: relative; display: grid; place-items: center; font-size: 16px; color: white; }
        .swatch.active, .res-box.active { outline: 3px solid white !important; }
        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            padding: .45rem .7rem; border-radius: 999px;
            background: rgba(222, 33, 42, .12);
            border: 1px solid rgba(222, 33, 42, .22);
            cursor: pointer; color: white; font-weight: 700;
            text-transform: capitalize; 
        }
        .tag.active { background: rgba(222, 33, 42, .3); }
        .res-box { padding: .45rem .7rem; border-radius: 8px; background: var(--bg-2); border: 1px solid var(--border); cursor: pointer; font-weight: 700; color: white; text-transform: capitalize; }
        .tiny { font-size: 12px; color: var(--muted); }
        .packs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
        }
        .pack { overflow: hidden; }
        .pack.card { box-shadow: 0 24px 70px rgba(0, 0, 0, .55); transition: box-shadow .2s, transform .2s, border-color .2s; }
        .pack.card:hover { transform: translateY(-4px); box-shadow: 0 28px 75px rgba(0, 0, 0, .65); border-color: rgba(255,255,255,.2); }
        .thumb { height: 140px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .pack .thumb { border-bottom-color: var(--border) !important; }
        .thumb .pack-icon-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(8px) brightness(0.7); transform: scale(1.1); }
        .thumb .pack-icon { position: relative; width: 90px; height: 90px; border-radius: 8px; object-fit: cover; z-index: 1; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }
        .thumb .glyph { height: 68px; width: 68px; border-radius: 14px; display: grid; place-items: center; color: white; }
        .content { padding: 14px; }
        .meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .badge { font-size: 12px; padding: .25rem .55rem; border-radius: 999px; border: 1px solid var(--border); background: var(--bg-2); color: white; font-weight: 700; text-transform: capitalize;}
        .pack-stats-top { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--muted); }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .pack-options-btn { position: absolute; top: 8px; right: 8px; z-index: 2; background: rgba(0, 0, 0, 0.4); color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; width: 30px; height: 30px; display: grid; place-items: center; cursor: pointer; padding: 0; }
        .pack-options-menu { display: none; position: absolute; top: 42px; right: 8px; z-index: 3; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); }
        .pack-options-menu a { display: flex; align-items: center; gap: 10px; padding: 8px 14px; font-size: 14px; }
        .pack-options-menu a:hover { background: var(--brand-1); }
        .pack-options-menu a i { width: 16px; text-align: center; }
        .btn.sm { padding: .25rem .5rem; border-radius: 8px; font-weight: 700; display: inline-flex; align-items: center; gap: .4rem; min-width: auto; }
        .btn.sm.btn-clear {
            padding: .2rem .6rem; font-size: 12px; font-weight: 800;
            background: linear-gradient(90deg, var(--brand-1), var(--brand-2));
            color: white; border: none;
        }
        .backdrop { position: fixed; inset: 0; background: rgba(2, 6, 23, .6); display: none; align-items: center; justify-content: center; z-index: 60; }
        .backdrop.on-top { z-index: 70; }
        .modal { width: 100%; max-width: 760px; background: var(--bg-2); border-radius: 12px; overflow-y: auto; max-height: 90vh; }
        .modal .panel { padding: 20px; }
        .modal-footer { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 12px 20px 20px; }
        .modal-footer .right-actions { display: flex; gap: 10px; }
        .modal-footer.center-actions { justify-content: center; }
        .file-upload-area { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; border: 2px dashed var(--border); border-radius: 12px; background: var(--bg-0); text-align: center; cursor: pointer; grid-column: span 2; }
        .file-upload-area:hover { border-color: var(--brand-1); background: rgba(222, 33, 42, .05); }
        .file-upload-area i { font-size: 32px; margin-bottom: 12px; color: var(--brand-1); }
        .file-hint { margin-top: 6px; color: var(--muted); }
        .label-with-icon { display: flex; align-items: center; gap: 6px; }
        input[type="text"], textarea { width:100%;padding:.7rem 1rem;border-radius:10px;border:1px solid var(--border);background:var(--bg-2);color:var(--text); font-family: inherit; font-size: inherit; }
        textarea { resize: vertical; height: 120px; }
        .sort-container { position: relative; }
        .sort-btn { padding: .25rem .5rem; gap: .5rem; }
        .sort-btn #currentSort { color: var(--text); }
        .sort-btn .fa-chevron-down { font-size: 10px; transition: transform .2s; }
        .sort-container.open .fa-chevron-down { transform: rotate(180deg); }
        .sort-menu { display: none; position: absolute; top: 100%; left: 0; margin-top: 6px; z-index: 10; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.4); min-width: 160px; }
        .sort-menu a { display: block; padding: 8px 14px; font-size: 14px; }
        .sort-menu a:hover { background: var(--brand-1); }
        .sort-menu a.active { font-weight: 800; color: var(--text); }
        .brand-icon-custom { width: 100%; height: 100%; object-fit: contain; padding: 4px; transform: translateY(-13px); }
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 18px; border-radius: 8px; color: white; font-weight: 700; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out forwards; }
        .toast.error { background: var(--danger); }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 20px; }
        .pagination-btn { background: var(--bg-2); border: 1px solid var(--border); color: var(--text); width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; }
        .pagination-btn:hover { border-color: white; }
        fieldset { border: none; padding: 0; margin: 0; }
        #uploadFormFieldset:disabled { opacity: 0.5; pointer-events: none; }
        
        #tagSearchInput { padding: .5rem .8rem; }
        
        #tagSelectModal .modal-body {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 20px;
            padding-top: 10px;
        }
        #tagSelectModal .tag-checkbox {
            font-size: 11px;
            padding: .2rem .4rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-0);
            color: white;
            font-weight: 700;
            text-transform: capitalize;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        #tagSelectModal .tag-checkbox:hover {
            border-color: var(--brand-1);
        }
        #tagSelectModal .tag-checkbox.selected {
            background-color: var(--brand-1);
            border-color: var(--brand-2);
            color: white;
        }
        /* Styles for Admin Controls */
        #admin-actions { display: none; /* Hidden by default */ }
        
        /* --- STYLES FOR THE USER DROPDOWN MENU --- */
        .user-dropdown { position: relative; display: inline-block; }
        .user-menu-btn {
            background: var(--bg-2); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 12px; display: flex; align-items: center;
            gap: 10px; cursor: pointer; font-weight: 600;
        }
        .nav-avatar-img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .nav-avatar-default {
            width: 28px; height: 28px; border-radius: 50%; background: var(--bg-0);
            display: flex; align-items: center; justify-content: center;
        }
        .user-menu-btn .fa-chevron-down { font-size: 0.8em; transition: transform 0.2s; }
        .user-menu-btn:hover { border-color: var(--border-strong); }
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 110%;
            background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px;
            min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10;
            overflow: hidden;
        }
        .dropdown-content.show { display: block; }
        .dropdown-content a {
            color: var(--muted); padding: 12px 16px; text-decoration: none;
            display: flex; align-items: center; gap: 10px; font-weight: 600;
        }
        .dropdown-content a:hover { background: var(--bg-2); color: var(--text); }
        /* --- END OF STYLES --- */

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        @media (max-width:1024px) { .layout { grid-template-columns: 1fr; } .sidebar { position: static; } .packs { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width:768px) { .packs { grid-template-columns: 1fr; } .nav-actions { display: none; } }
    </style>
</head>

<body>
    <header>
        <div class="nav">
            <a class="brand" href="/">
                <div class="brand-badge">
                    <img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="BedrockHub Icon" class="brand-icon-custom">
                </div>
                <div>
                    <div class="brand-title">BEDROCKHUB</div>
                    <div class="tiny">Minecraft Bedrock • community</div>
                </div>
            </a>
            <div id="nav-actions" class="nav-actions">
                <!-- Auth.js will populate this -->
            </div>
        </div>
    </header>

    <section class="container" id="main-content">
        <div class="layout">
            <aside class="sidebar card panel">
                <div id="admin-actions">
                    <h3>Actions</h3>
                    <div class="row"><button class="btn primary" onclick="openModal()" style="width: 100%;"><i class="fa-solid fa-cloud-upload-alt"></i> Upload Pack</button></div>
                    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                </div>
                <h3>Colors</h3>
                <div id="colorSwatches" class="swatches"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearColors()">Clear colors</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Resolutions</h3>
                <div id="resolutionBoxes" class="resolutions"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearResolutions()">Clear resolutions</button></div>
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h3>Tags</h3>
                <div id="tagCloud" class="tags"></div>
                <div class="row" style="margin-top:8px"><button class="btn sm btn-clear" onclick="clearTags()">Clear tags</button></div>
            </aside>
            <div>
                <div class="card panel" style="display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:14px">
                    <div class="sort-container" id="sortContainer">
                        <button class="btn sm ghost sort-btn" onclick="toggleSortMenu()">
                            <span class="tiny">Sort by:</span>
                            <span id="currentSort">Latest Upload</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <div class="sort-menu" id="sortMenu">
                            <a href="#" class="active" onclick="setSort('latest', this)">Latest Upload</a>
                            <a href="#" onclick="setSort('downloads', this)">Downloads</a>
                        </div>
                    </div>
                    <div class="search" style="flex-grow: 1;">
                        <input id="q" placeholder="Search by name..." oninput="applyFilters()" />
                        <button class="btn sm ghost" onclick="clearSearch()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="row"><button class="btn sm ghost" onclick="resetAll()">Reset filters</button></div>
                </div>
                <div id="grid" class="packs"></div>
                <div id="pagination-controls" class="pagination"></div>
            </div>
        </div>
    </section>

    <!-- All Modals (Upload, Edit, Confirm Delete, Tag Select) go here -->
    <div id="backdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Upload Texture Pack</strong>
                    <button class="btn sm" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny">Select a .mcpack or .zip file, set a name, choose color & tags.</div>
            </div>
            <div class="panel" style="padding-top:0">
                <form id="uploadForm" onsubmit="handleUpload(event)">
                    <fieldset id="uploadFormFieldset">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px; align-items: start;">
                            <div>
                                <label class="tiny label-with-icon"><span>Pack name</span></label>
                                <input id="packName" required placeholder="e.g. Crystal PvP" type="text">
                            </div>
                            <div>
                                <label class="tiny">Primary color</label>
                                <div id="modalSwatches" class="swatches"></div>
                            </div>
                            <div>
                               <label class="tiny">Description (optional)</label>
                               <textarea id="packDescription" placeholder="A short description of the pack..."></textarea>
                            </div>
                            <div>
                                <div>
                                    <label class="tiny">Resolution</label>
                                    <div id="modalResolutions" class="resolutions"></div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label class="tiny">Tags</label>
                                    <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openTagModal()">
                                        <span id="tagSelectorBtnText">Select Tags</span>
                                        <i class="fa-solid fa-chevron-down fa-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" style="grid-column: span 2;">
                                <i class="fa-solid fa-file-arrow-up"></i>
                                <div>Drag & drop or <span style="color:var(--brand-1)">browse files</span></div>
                                <div class="file-hint" id="fileHint">.mcpack or .zip files only</div>
                                <input id="fileInput" type="file" accept=".mcpack,.zip" style="display:none" onchange="hintFile()" />
                            </div>
                        </div>
                    </fieldset>
                    <div class="modal-footer center-actions">
                        <button type="button" class="btn sm ghost" onclick="closeModal()">Cancel</button>
                        <button id="submitBtn" class="btn primary" type="submit"><i class="fa-solid fa-upload"></i> Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="tag-select-backdrop" class="backdrop on-top">
        <div class="modal card" style="max-width: 500px;" id="tagSelectModal">
            <div class="panel">
                <strong>Select Tags</strong>
                <div style="margin-top: 12px;">
                    <input type="text" id="tagSearchInput" placeholder="Search tags...">
                </div>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer center-actions">
                <button type="button" class="btn sm ghost" onclick="closeTagModal(false)">Cancel</button>
                <button type="button" class="btn primary" onclick="closeTagModal(true)">Done</button>
            </div>
        </div>
    </div>

    <div id="editBackdrop" class="backdrop">
        <div class="modal card">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <strong>Edit Texture Pack</strong>
                    <button class="btn sm" onclick="closeEditModal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="tiny">Change name, tags, description or color.</div>
            </div>
            <div class="panel" style="padding-top:0">
                <form id="editForm" onsubmit="saveEdit(event)">
                    <input type="hidden" id="editId" />
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                        <div>
                            <label class="tiny">Pack name</label>
                            <input id="editPackName" required placeholder="Pack name" type="text">
                        </div>
                        <div>
                            <label class="tiny">Primary color</label>
                            <div id="editModalSwatches" class="swatches"></div>
                        </div>
                        <div style="grid-column: span 1;">
                            <label class="tiny">Resolution</label>
                            <div id="editModalResolutions" class="resolutions"></div>
                        </div>
                         <div style="grid-column: span 1;">
                            <label class="tiny">Tags</label>
                            <button type="button" class="btn ghost" style="width:100%; justify-content: space-between;" onclick="openEditTagModal()">
                                <span id="editTagSelectorBtnText">Select Tags</span>
                                <i class="fa-solid fa-chevron-down fa-xs"></i>
                            </button>
                        </div>
                        <div style="grid-column: span 2;"><label class="tiny">Description (optional)</label>
                            <textarea id="editPackDescription" placeholder="A short description of the pack..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div></div>
                        <div class="right-actions">
                            <button type="button" class="btn sm danger" onclick="promptDelete()">Delete</button>
                            <button class="btn primary" type="submit"><i class="fa-solid fa-save"></i> Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="confirmDeleteBackdrop" class="backdrop">
        <div class="modal card" style="max-width: 420px;">
            <div class="panel">
                <strong>Are you sure you want to delete it?</strong>
                <p class="tiny" style="margin: 4px 0 12px;">This will permanently delete the texture pack.</p>
                <div style="display:flex;justify-content:flex-end;gap:10px;">
                    <button class="btn sm danger" onclick="cancelDelete()">No</button>
                    <button class="btn sm success" onclick="confirmDelete()">Yes</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        /* ====== CONSTANTS & STATE ====== */
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const COLORS = [{key: 'none', hex: '#4b5563', icon: 'fa-solid fa-ban'}, {key: 'red',hex: '#ef4444'}, {key: 'blue',hex: '#3b82f6'}, {key: 'green',hex: '#22c55e'}, {key: 'yellow',hex: '#eab308'}, {key: 'purple',hex: '#a855f7'}, {key: 'pink',hex: '#ec4899'}, {key: 'orange',hex: '#f97316'}, {key: 'teal',hex: '#14b8a6'}, {key: 'gray',hex: '#6b7280'}, {key: 'black',hex: '#1f2937'}];
        const TAGS = ['pvp', 'bedwars', 'skywars', 'anime', 'crystal pvp', 'survival'];
        const RESOLUTIONS = ['8x', '16x', '32x', '64x'];
        const packsPerPage = 9;
        let packs = [];
        const state = { q: '', colors: new Set(), tags: new Set(), resolutions: new Set(), currentPage: 1, modalColor: null, modalTags: new Set(), modalResolution: null, editColor: null, editTags: new Set(), editResolution: null, sortBy: 'latest' };
        let currentEditId = null;
        let tempModalTags = new Set();
        let isEditingTags = false;
        let currentUserRole = null; // To store the user's role

        /* ====== API & DATA FUNCTIONS ====== */
        async function loadPacksOnStartup() {
            let query = supabase.from('packs').select('*');
            if (state.sortBy === 'downloads') {
                query = query.order('download_count', { ascending: false });
            } else {
                query = query.order('created_at', { ascending: false });
            }
            const { data, error } = await query;
            if (error) {
                console.error('Failed to load packs from Supabase', error);
                packs = [];
            } else {
                packs = data.map(pack => ({ ...pack, tags: pack.tags ? pack.tags.split(',') : [] }));
            }
            render();
        }
        
        // ... (handleUpload, saveEdit, confirmDelete, handleDownload functions remain the same) ...
        async function handleUpload(e){e.preventDefault();const t=document.getElementById("submitBtn"),o=document.getElementById("uploadFormFieldset"),a=document.getElementById("fileInput").files[0],n=document.getElementById("packName").value.trim(),i=document.getElementById("packDescription").value.trim();if(!a||!a.name.toLowerCase().endsWith(".mcpack")&&!a.name.toLowerCase().endsWith(".zip"))return void showToast("Please select a valid .mcpack or .zip file");if(!state.modalColor)return void showToast("You forgot to select a primary color.");if(!state.modalResolution)return void showToast("You forgot to select a resolution.");let l="";a.name.toLowerCase().endsWith(".mcpack")?l="bedrock":a.name.toLowerCase().endsWith(".zip")&&(l="java"),t.disabled=!0,o.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Processing...';try{let e=null;const r=new JSZip,d=await r.loadAsync(a);let s=null;if(d.forEach((e,t)=>{const o=e.toLowerCase();o.endsWith("pack_icon.png")&&(s=t)}),!s&&d.forEach((e,t)=>{const o=e.toLowerCase();o.endsWith("pack.png")&&(s=t)}),s){t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Uploading Icon...';const o=await s.async("blob"),a=`icons/${Date.now()}-icon.png`,{error:n}=await supabase.storage.from("packs").upload(a,o);if(n)throw n;const{data:i}=supabase.storage.from("packs").getPublicUrl(a);e=i.publicUrl}t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Uploading Pack...';const c=a.name.replace(/[^a-zA-Z0-9-._]/g,"").replace(/\s+/g,"-"),p=`${Date.now()}-${c}`;await supabase.storage.from("packs").upload(p,a);const m=await fetch("/api/addpacks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n||a.name.replace(/\.(mcpack|zip)$/i,""),color:state.modalColor,tags:[...state.modalTags],filename:p,resolution:state.modalResolution,version:l,description:i,icon_url:e})});if(!m.ok)throw new Error((await m.json()).details||"Failed to add pack metadata.");await loadPacksOnStartup(),closeModal()}catch(e){showToast("Upload failed: "+e.message)}finally{t.disabled=!1,o.disabled=!1,t.innerHTML='<i class="fa-solid fa-upload"></i> Upload'}}
        async function saveEdit(e){e.preventDefault();if(!currentEditId)return;const{error:t}=await supabase.from("packs").update({name:document.getElementById("editPackName").value.trim(),description:document.getElementById("editPackDescription").value.trim(),color:state.editColor,tags:[...state.editTags].join(","),resolution:state.editResolution}).eq("id",currentEditId);t?showToast("Save failed: "+t.message):(await loadPacksOnStartup(),closeEditModal())}
        async function confirmDelete(){if(!currentEditId)return;const e=packs.find(e=>e.id===currentEditId);if(!e)return void cancelDelete();try{await supabase.storage.from("packs").remove([e.filename]),e.icon_url&&await supabase.storage.from("packs").remove([`icons/${e.icon_url.split("/").pop()}`]);const{error:t}=await supabase.from("packs").delete().eq("id",currentEditId);if(t)throw t;await loadPacksOnStartup()}catch(e){showToast("Delete failed: "+e.message)}finally{cancelDelete(),closeEditModal()}}
        async function handleDownload(e,t,o,a){e.preventDefault();try{await fetch("/api/increment-download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t})});const e=document.getElementById(`downloads-${t}`);if(e){const t=parseInt(e.textContent.replace(/,/g,""),10);e.textContent=(t+1).toLocaleString()}}catch(e){console.error("Failed to update download count:",e)}finally{fetch(o).then(e=>e.blob()).then(e=>{const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=a,document.body.appendChild(t),t.click(),document.body.removeChild(t)})}}

        /* ====== UI RENDERING ====== */
        function render() {
            const grid = document.getElementById('grid');
            const filtered = packs.filter(p => {
                const qOk = !state.q || p.name.toLowerCase().includes(state.q);
                const cOk = state.colors.size === 0 || state.colors.has(p.color);
                const tOk = state.tags.size === 0 || [...state.tags].every(t => (p.tags || []).includes(t));
                const rOk = state.resolutions.size === 0 || state.resolutions.has(p.resolution);
                return qOk && cOk && tOk && rOk;
            });

            const startIndex = (state.currentPage - 1) * packsPerPage;
            const endIndex = startIndex + packsPerPage;
            const packsForPage = filtered.slice(startIndex, endIndex);

            grid.innerHTML = '';
            if (packsForPage.length === 0) {
                grid.innerHTML = '<div class="card panel tiny" style="grid-column: span 3;">No packs match your filters.</div>';
            } else {
                packsForPage.forEach(p => grid.appendChild(renderCard(p)));
            }

            renderPagination(filtered.length);
        }

        // ... (renderPagination, scrollToContentTop, nextPage, prevPage remain the same) ...
        function renderPagination(e){const t=document.getElementById("pagination-controls");t.innerHTML="";const o=Math.ceil(e/9);if(o<=1)return;if(state.currentPage>1){const e=document.createElement("button");e.className="pagination-btn",e.innerHTML='<i class="fa-solid fa-arrow-left"></i>',e.onclick=prevPage,t.appendChild(e)}const a=document.createElement("span");a.className="tiny",a.textContent=`Page ${state.currentPage} of ${o}`,t.appendChild(a),state.currentPage<o&&(()=>{const e=document.createElement("button");e.className="pagination-btn",e.innerHTML='<i class="fa-solid fa-arrow-right"></i>',e.onclick=nextPage,t.appendChild(e)})()}
        function scrollToContentTop(){const e=document.querySelector("header"),t=document.getElementById("main-content");if(!e||!t)return;const o=e.offsetHeight,a=t.offsetTop;window.scrollTo({top:a-o-14,behavior:"smooth"})}
        function nextPage(){state.currentPage++,scrollToContentTop(),render()}
        function prevPage(){state.currentPage--,scrollToContentTop(),render()}

        function renderCard(p) {
            const colorKey = p.color || 'gray';
            const color = COLORS.find(c => c.key === colorKey)?.hex || '#6b7280';
            const card = document.createElement('div');
            card.className = 'card pack';
            const { data } = supabase.storage.from('packs').getPublicUrl(p.filename);
            const extension = p.filename.split('.').pop();
            const downloadName = `${p.name}.${extension}`;

            let thumbContent;
            let thumbBackgroundStyle;
            if (p.icon_url) {
                thumbContent = `<div class="pack-icon-bg" style="background-image: url('${p.icon_url}');"></div><img class="pack-icon" src="${p.icon_url}" alt="${escapeHtml(p.name)} Icon">`;
                thumbBackgroundStyle = `background: linear-gradient(135deg,#1f2937,#0f172a);`;
            } else {
                thumbContent = `<div class="glyph" style="background:${color}"><i class="fa-solid fa-cube"></i></div>`;
                thumbBackgroundStyle = `background:linear-gradient(135deg, ${shade(color, -20)}, ${shade(color, 20)})`;
            }

            // CORRECTED LOGIC: Create the full menu content based on the user's role
            const downloadLink = `<a href="${data.publicUrl}" onclick="handleDownload(event, ${p.id}, '${data.publicUrl}', '${escapeHtml(downloadName)}')"><i class="fa-solid fa-download"></i> Download</a>`;
            const editLink = currentUserRole === 'admin' ? `<a href="#" onclick="openEditModal(${p.id}); event.preventDefault();"><i class="fa-regular fa-pen-to-square"></i> Edit</a>` : '';

            card.innerHTML = `
                <div class="thumb" style="${thumbBackgroundStyle}">
                    ${thumbContent}
                    <button class="pack-options-btn" style="display: grid;" onclick="toggleOptionsMenu(event, ${p.id})"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                    <div class="pack-options-menu" id="options-menu-${p.id}">
                        ${downloadLink}
                        ${editLink}
                    </div>
                </div>
                <div class="content">
                    <div class="pack-stats-top">
                        <div class="stat-item"><i class="fa-solid fa-download"></i><span id="downloads-${p.id}">${(p.download_count || 0).toLocaleString()}</span></div>
                        <div class="stat-item"><i class="fa-solid fa-calendar-day"></i><span>${formatDate(p.created_at)}</span></div>
                    </div>
                    <h4>${escapeHtml(p.name)}</h4>
                    <div class="meta">
                        ${(p.color && p.color !== 'none') ? `<span class="badge" style="text-transform: capitalize;">${escapeHtml(p.color)}</span>` : ''}
                        ${p.resolution ? `<span class="badge">${escapeHtml(p.resolution)}</span>` : ''}
                        ${p.version ? `<span class="badge" style="text-transform: capitalize;">${escapeHtml(p.version)}</span>` : ''}
                        ${(p.tags||[]).map(t=>`<span class="badge">${escapeHtml(capitalizeFirst(t))}</span>`).join('')}
                    </div>
                </div>`;
            return card;
        }

        // ... (All other UI, event handlers, and utility functions remain the same) ...
        function buildSwatches(e,t,o){e.innerHTML="",COLORS.forEach(a=>{const n=document.createElement("button");n.type="button",n.className="swatch"+(o&&o.has(a.key)?" active":""),n.style.background=a.hex,n.title=a.key,a.icon&&(n.innerHTML=`<i class="${a.icon}"></i>`),n.onclick=()=>t(a.key,n),e.appendChild(n)})}
        function buildModalTags(e,t,o=""){e.innerHTML="";const a=TAGS.filter(e=>e.toLowerCase().includes(o.toLowerCase()));0===a.length&&(e.innerHTML='<div class="tiny" style="grid-column: 1 / -1; text-align: center;">No tags found.</div>'),a.forEach(o=>{const a=document.createElement("span");a.className="tag-checkbox",t.has(o)&&a.classList.add("selected"),a.textContent=capitalizeFirst(o),a.onclick=()=>{toggleSet(tempModalTags,o),a.classList.toggle("selected")},e.appendChild(a)})}
        function buildSidebarTags(e,t,o){e.innerHTML="",TAGS.forEach(a=>{const n=document.createElement("button");n.type="button",n.className="tag"+(o?.has(a)?" active":""),n.textContent=capitalizeFirst(a),n.onclick=()=>{t(a,n),n.classList.toggle("active")},e.appendChild(n)})}
        function buildSelectorBoxes(e,t,o,a){e.innerHTML="";const n=o instanceof Set;a.forEach(a=>{const i=document.createElement("button");i.type="button";const l=n?o.has(a):o===a;i.className="res-box"+(l?" active":""),i.textContent=a,i.onclick=()=>t(a,i),e.appendChild(i)})}
        function openModal(){document.getElementById("backdrop").style.display="flex",state.modalColor=null,state.modalResolution=null,state.modalTags=new Set,buildSwatches(document.getElementById("modalSwatches"),(e,t)=>{state.modalColor=e,highlightOne(t.parentElement,t)},null),buildSelectorBoxes(document.getElementById("modalResolutions"),(e,t)=>{state.modalResolution=e,highlightOne(t.parentElement,t)},null,RESOLUTIONS),updateTagButtonText()}
        function closeModal(){document.getElementById("backdrop").style.display="none",document.getElementById("uploadForm").reset()}
        function openTagModal(){isEditingTags=!1,tempModalTags=new Set(state.modalTags);const e=document.getElementById("tagSearchInput");e.value="",buildModalTags(document.querySelector("#tagSelectModal .modal-body"),tempModalTags),e.oninput=()=>{buildModalTags(document.querySelector("#tagSelectModal .modal-body"),tempModalTags,e.value)},document.getElementById("tag-select-backdrop").style.display="flex"}
        function openEditTagModal(){isEditingTags=!0,tempModalTags=new Set(state.editTags);const e=document.getElementById("tagSearchInput");e.value="",buildModalTags(document.querySelector("#tagSelectModal .modal-body"),tempModalTags),e.oninput=()=>{buildModalTags(document.querySelector("#tagSelectModal .modal-body"),tempModalTags,e.value)},document.getElementById("tag-select-backdrop").style.display="flex"}
        function closeTagModal(e){if(e)if(isEditingTags){state.editTags=new Set(tempModalTags),updateEditTagButtonText()}else state.modalTags=new Set(tempModalTags),updateTagButtonText();const t=document.getElementById("tagSearchInput");t.value="",t.oninput=null,document.getElementById("tag-select-backdrop").style.display="none"}
        function openEditModal(e){const t=packs.find(t=>t.id===e);if(!t)return alert("Pack not found");currentEditId=e,document.getElementById("editId").value=e,document.getElementById("editPackName").value=t.name||"",document.getElementById("editPackDescription").value=t.description||"",state.editColor=t.color||null,state.editTags=new Set(t.tags||[]),state.editResolution=t.resolution||null,buildSwatches(document.getElementById("editModalSwatches"),(e,t)=>{state.editColor=e,highlightOne(t.parentElement,t)},new Set([state.editColor])),updateEditTagButtonText(),buildSelectorBoxes(document.getElementById("editModalResolutions"),(e,t)=>{state.editResolution=e,highlightOne(t.parentElement,t)},state.editResolution,RESOLUTIONS),document.getElementById("editBackdrop").style.display="flex"}
        function closeEditModal(){currentEditId=null,document.getElementById("editBackdrop").style.display="none"}
        function promptDelete(){if(currentEditId)document.getElementById("confirmDeleteBackdrop").style.display="flex"}
        function cancelDelete(){document.getElementById("confirmDeleteBackdrop").style.display="none"}
        function applyFilters(){state.currentPage=1,state.q=document.getElementById("q").value.trim().toLowerCase(),render()}
        function clearSearch(){state.currentPage=1,document.getElementById("q").value="",applyFilters()}
        function clearColors(){state.currentPage=1,state.colors.clear(),buildSwatches(document.getElementById("colorSwatches"),(e,t)=>{toggleSet(state.colors,e),t.classList.toggle("active"),render()},state.colors),render()}
        function clearTags(){state.currentPage=1,state.tags.clear(),buildSidebarTags(document.getElementById("tagCloud"),(e,t)=>{toggleSet(state.tags,e),t.classList.toggle("active"),render()},state.tags),render()}
        function clearResolutions(){state.currentPage=1,state.resolutions.clear(),buildSelectorBoxes(document.getElementById("resolutionBoxes"),(e,t)=>{toggleSet(state.resolutions,e),t.classList.toggle("active"),render()},state.resolutions,RESOLUTIONS),render()}
        function resetAll(){state.currentPage=1,clearSearch(),clearColors(),clearTags(),clearResolutions()}
        function hintFile(){const e=document.getElementById("fileInput"),t=e.files[0];if(t){document.getElementById("fileHint").textContent=t.name;const o=document.getElementById("packName");o.value=t.name.replace(/\.(mcpack|zip)$/i,"")}}
        function toggleOptionsMenu(e,t){e.stopPropagation();const o=document.getElementById(`options-menu-${t}`),a="block"===o.style.display;document.querySelectorAll(".pack-options-menu").forEach(e=>e.style.display="none"),a||(o.style.display="block")}
        function toggleSortMenu(){const e=document.getElementById("sortMenu"),t=document.getElementById("sortContainer"),o="block"===e.style.display;e.style.display=o?"none":"block",t.classList.toggle("open",!o)}
        function setSort(e,t){event.preventDefault(),state.sortBy=e,state.currentPage=1;const o=document.getElementById("currentSort");o.textContent=t.textContent,document.querySelectorAll("#sortMenu a").forEach(e=>e.classList.remove("active")),t.classList.add("active"),toggleSortMenu(),loadPacksOnStartup()}
        function updateTagButtonText(){const e=document.getElementById("tagSelectorBtnText");0===state.modalTags.size?e.textContent="Select Tags":1===state.modalTags.size?e.textContent="1 Tag Selected":e.textContent=`${state.modalTags.size} Tags Selected`}
        function updateEditTagButtonText(){const e=document.getElementById("editTagSelectorBtnText");0===state.editTags.size?e.textContent="Select Tags":1===state.editTags.size?e.textContent="1 Tag Selected":e.textContent=`${state.editTags.size} Tags Selected`}
        function capitalizeFirst(e){return e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():""}
        function showToast(e,t="error"){const o=document.getElementById("toast-container"),a=document.createElement("div");a.className=`toast ${t}`,a.innerHTML=`<i class="fa-solid fa-circle-exclamation"></i> ${escapeHtml(e)}`,o.appendChild(a),setTimeout(()=>{a.remove()},4e3)}
        function formatDate(e){if(!e)return"";const t=new Date(e),o=t.getDate(),a=t.getMonth()+1;return`${o}/${a}/${String(t.getFullYear()).slice(-2)}`}
        function escapeHtml(e){return String(e||"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}
        function shade(e,t){let o=e.replace("#","");3===o.length&&(o=o.split("").map(e=>e+e).join(""));let[a,n,i]=[0,0,0].map((e,t)=>parseInt(o.slice(2*t,2*t+2),16));return[a,n,i]=[a+t,n+t,i+t].map(e=>Math.max(0,Math.min(255,e))),`#${[a,n,i].map(e=>e.toString(16).padStart(2,"0")).join("")}`}
        function highlightOne(e,t){[...e.children].forEach(e=>e.classList.remove("active")),t.classList.add("active")}
        function toggleSet(e,t){e.has(t)?e.delete(t):e.add(t)}

        /* ====== INITIALIZATION ====== */
        async function checkUserAndInitialize() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', user.id)
                    .single();
                if (profile) currentUserRole = profile.role;
            }
            if (currentUserRole === 'admin') {
                document.getElementById('admin-actions').style.display = 'block';
            }
            await loadPacksOnStartup();
        }

        function init() {
            window.openModal = openModal; window.closeModal = closeModal; window.openTagModal = openTagModal; window.closeTagModal = closeTagModal; window.openEditModal = openEditModal; window.closeEditModal = closeEditModal; window.openEditTagModal = openEditTagModal; window.handleUpload = handleUpload; window.saveEdit = saveEdit; window.promptDelete = promptDelete; window.cancelDelete = cancelDelete; window.confirmDelete = confirmDelete; window.applyFilters = applyFilters; window.clearSearch = clearSearch; window.clearColors = clearColors; window.clearTags = clearTags; window.clearResolutions = clearResolutions; window.resetAll = resetAll; window.hintFile = hintFile; window.toggleOptionsMenu = toggleOptionsMenu; window.handleDownload = handleDownload; window.toggleSortMenu = toggleSortMenu; window.setSort = setSort; window.nextPage = nextPage; window.prevPage = prevPage;
            
            if (document.getElementById('grid')) {
                buildSwatches(document.getElementById('colorSwatches'), (k, el) => { toggleSet(state.colors, k); el.classList.toggle('active'); render(); }, state.colors);
                buildSidebarTags(document.getElementById('tagCloud'), (k, el) => { toggleSet(state.tags, k); el.classList.toggle('active'); render(); }, state.tags);
                buildSelectorBoxes(document.getElementById('resolutionBoxes'), (res, el) => { toggleSet(state.resolutions, res); el.classList.toggle('active'); render(); }, state.resolutions, RESOLUTIONS);
                
                window.addEventListener('click', (e) => {
                    if (!e.target.closest('.pack-options-btn')) { document.querySelectorAll('.pack-options-menu').forEach(menu => menu.style.display = 'none'); }
                    if (!e.target.closest('.sort-container')) { document.getElementById('sortMenu').style.display = 'none'; document.getElementById('sortContainer').classList.remove('open'); }
                });
                
                checkUserAndInitialize();
            }
        }
        init();
    </script>
    <script type="module" src="/auth.js"></script>
</body>

</html>
