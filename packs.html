<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCHub â€” Texture Pack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
    body { opacity: 0; transition: opacity 0.2s ease-in; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.0/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/bundles/skinview3d.bundle.js"></script>
    <style>
        :root {
            --bg-0: #000000; --bg-1: #1c1c1c; --bg-2: #2c2c2c; --muted: #a8b3cf;
            --text: #e8eefc; --border: rgba(255, 255, 255, .12); --brand-1: #de212a;
            --brand-2: #b21a22; --shadow-brand: 0 12px 30px rgba(222, 33, 42, .22);
            --border-strong: rgba(255, 255, 255, .2); --danger: #ef4444; --success: #22c55e;
            --gradient-brand: linear-gradient(135deg, var(--brand-1), var(--brand-2));
            --brand-1-rgb: 222, 33, 42;
            --star-color: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { margin: 0; background-color: var(--bg-0); color: var(--text); font: 500 15px/1.6 Inter, sans-serif; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: var(--bg-image, url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg')); background-size: cover; background-position: center; filter: blur(8px); opacity: 0.2; z-index: -1; transition: background-image 0.5s ease-in-out; }
        a { color: inherit; text-decoration: none; }
        .tiny { font-size: 12px; color: var(--muted); }
        .btn { padding: .7rem 1.2rem; border-radius: 12px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: .55rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn.primary { background: var(--gradient-brand); box-shadow: var(--shadow-brand); color: white; }
        .btn.ghost { border-color: var(--border); background: transparent; color: var(--text); }
        .btn.ghost:hover { background: rgba(255, 255, 255, 0.05); }
        .btn.danger { background: var(--danger); color: white; border-color: transparent; }
        .spinner { width: 48px; height: 48px; border: 5px solid var(--border); border-bottom-color: var(--brand-1); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(10px); background: rgba(12, 12, 12, 0.75); border-bottom: 1px solid var(--border); }
        .nav { max-width: 1100px; margin: 0 auto; padding: 12px 18px; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge { height: 40px; width: 40px; border-radius: 10px; display: grid; place-items: center; background: var(--gradient-brand); box-shadow: var(--shadow-brand); }
        .brand-icon-custom { width: 100%; height: 100%; object-fit: contain; padding: 4px; transform: translateY(-11px); }
        .brand-title { font-weight: 800; letter-spacing: .6px; font-size: 15px; }
        .nav-actions { display: flex; align-items: center; gap: 0.6rem; }
        .nav-actions .btn.ghost { background: transparent; }
        
        .user-dropdown { position: relative; display: inline-block; }
        .user-menu-btn { background: var(--bg-2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        .nav-avatar-img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .user-menu-btn:hover { border-color: var(--border-strong); }
        .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px; min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10; overflow: hidden; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--muted); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .dropdown-content a:hover { background: var(--bg-2); color: var(--text); }

        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .loading-container, .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; min-height: 60vh; color: var(--muted); text-align: center;}
        .error-container h2 { color: var(--text); }

        .pack-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        .card { border-radius: 16px; background: rgba(18, 18, 18, 0.9); backdrop-filter: saturate(1.2) blur(20px); border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .pack-header { display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
        .pack-header-icon { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; background-color: var(--bg-2); flex-shrink: 0; border: 1px solid var(--border); }
        .pack-title-area { flex-grow: 1; }
        .pack-title-area h1 { font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin: 0 0 4px 0; }
        .pack-reviews-and-meta { margin-top: 0.75rem; }
        .pack-meta-info { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; font-size: 0.9rem; color: var(--muted); margin-top: 0.5rem; }
        .pack-header-actions { flex-shrink: 0; display: flex; gap: 0.5rem; }
        .edit-pack-btn { background: var(--bg-2); border: 1px solid var(--border); color: white; }
        .edit-pack-btn:hover { background: var(--bg-1); border-color: var(--border-strong); }
        
        .youtube-video-container { margin-top: 1.5rem; border-radius: 12px; aspect-ratio: 16/9; overflow: hidden; background: var(--bg-2); border: 1px solid var(--border); }
        .youtube-video-container iframe { width: 100%; height: 100%; border: none; }
        
        .description-section, .tags-section { margin-top: 2.5rem; }
        .section-title { font-size: 1rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .pack-description { line-height: 1.7; color: var(--muted); }
        .tags-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { padding: .4rem .8rem; border-radius: 8px; background: var(--bg-2); border: 1px solid var(--border); font-weight: 600; font-size: 0.8rem; text-transform: capitalize; }
        
        .card-body { padding: 1.2rem; }
        
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 1000; }
        .toast { padding: 12px 18px; border-radius: 8px; font-weight: 700; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out forwards; background: var(--bg-1); border: 1px solid var(--border); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        .mobile-nav-toggle { display: none; background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; z-index: 1001; }
        
        .preview-tabs { display: flex; gap: 0.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem; }
        .preview-tab-btn { padding: 0.8rem 1rem; background: none; border: none; color: var(--muted); font-weight: 700; font-size: 0.9rem; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem; }
        .preview-tab-btn i { width: 1em; text-align: center; }
        .preview-tab-btn.active { color: var(--text); border-bottom-color: var(--brand-1); }
        .preview-panel { display: none; }
        .preview-panel.active { display: block; }
        .skin-viewer-wrapper { position: relative; }
        #skin-viewer-canvas { width: 100%; aspect-ratio: 4/5; border-radius: 12px; background-image: url(https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/skinbg2.jpg); background-size: cover; background-position: center; cursor: grab; }
        #skin-viewer-canvas.dragging { cursor: grabbing; }
        #viewer-refresh-btn { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); cursor: pointer; display: grid; place-items: center; transition: all .2s; }
        #viewer-refresh-btn:hover { color: var(--text); background: rgba(0,0,0,0.6); }
        .armor-selection-list { display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center; flex-wrap: wrap; }
        .armor-item { width: 48px; height: 48px; background: var(--bg-2); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: grid; place-items: center; padding: 4px; }
        .armor-item img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .armor-item:hover { border-color: var(--text); }
        .armor-item.active { border-color: var(--brand-1); background: rgba(var(--brand-1-rgb), 0.2); }
        
        #item-viewer-wrapper { position: relative; }
        #item-enchant-btn { position: absolute; top: 10px; right: 10px; z-index: 5; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: #fcc2ff; border-radius: 8px; padding: 0.4rem 0.6rem; font-size: 0.8rem; font-weight: 700; cursor: pointer; display: none; align-items: center; gap: 0.4rem; }
        #item-enchant-btn.active { background: #a855f7; color: white; border-color: #c084fc; }
        #item-viewer-container { border-radius: 12px; width: 100%; aspect-ratio: 1 / 1; background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/item_bg.png'); background-size: cover; background-position: center; display: grid; place-items: center; padding: 1rem; }
        #item-viewer-canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(56px, 1fr)); gap: 0.5rem; margin-top: 1rem; }
        .item-icon-card { position: relative; width: 100%; aspect-ratio: 1/1; background: var(--bg-2); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: grid; place-items: center; padding: 4px; }
        .item-icon-card:hover { border-color: var(--text); }
        .item-icon-card.active { border-color: var(--brand-1); background: rgba(var(--brand-1-rgb), 0.2); }
        .item-icon-card img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        
        #gui-viewer-container { border-radius: 12px; width: 100%; aspect-ratio: 1/1; background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/item_bg.png'); background-size: cover; background-position: center; display: grid; place-items: center; padding: 1rem; }
        #gui-viewer-canvas { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: pixelated; transform-origin: center; }
        
        .gui-selection-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; justify-content: center; }
        .gui-selection-item { width: 60px; height: 60px; background: var(--bg-2); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s ease; display: grid; place-items: center; padding: 4px; font-weight: 600; font-size: 0.8rem; text-transform: capitalize; text-align: center; line-height: 1.2; color: var(--muted); }
        .gui-selection-item i { font-size: 1.5rem; color: var(--muted); line-height: 1; }
        .gui-selection-item img { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: pixelated; }
        .gui-selection-item:hover { border-color: var(--text); color: var(--text); }
        .gui-selection-item.active { border-color: var(--brand-1); background: rgba(var(--brand-1-rgb), 0.2); color: white; }

        .preview-placeholder-text { text-align: center; color: var(--muted); padding: 1rem 0; font-size: 13px; }
        .preview-placeholder-text .spinner-sm { width: 1em; height: 1em; border-width: 2px; display: inline-block; animation: rotation 1s linear infinite; }

        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; animation: modal-fade-in 0.2s ease-out; }
        @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
        .modal-dialog { background: var(--bg-1); border: 1px solid var(--border); border-radius: 20px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5); transform: scale(0.95); opacity: 0; animation: modal-dialog-appear 0.3s ease-out forwards; }
        @keyframes modal-dialog-appear { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header-section { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header-section h2 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .modal-content-section { padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; }
        .form-input, .form-textarea { width: 100%; padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); font-size: 1rem; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .modal-footer-section { padding: 1rem 1.5rem; border-top: 1px solid var(--border); text-align: right; }
        .swatches, .tags-editor-container, .resolutions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0.5rem; }
        .swatch { width: 34px; height: 34px; border-radius: 999px; border: 2px solid var(--border); cursor: pointer; display: grid; place-items: center; }
        .swatch.active { border-color: var(--brand-1); outline: 3px solid rgba(var(--brand-1-rgb), 0.3); }
        .tag-checkbox { padding: .4rem .8rem; border-radius: 8px; background: var(--bg-2); border: 1px solid var(--border); cursor: pointer; font-weight: 600; font-size: 0.85rem; text-transform: capitalize; }
        .tag-checkbox.selected { background: var(--brand-1); border-color: var(--brand-2); color: white; }

        .mobile-nav-backdrop { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 998; opacity: 0; transition: opacity 0.3s ease; }
        .mobile-nav-backdrop.show { display: block; opacity: 1; }
        .mobile-nav-sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: var(--bg-1); z-index: 999; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .mobile-nav-sidebar.show { transform: translateX(0); }
        .mobile-nav-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
        .mobile-nav-header { padding: 1.5rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--border); }
        .mobile-nav-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .mobile-nav-user-info { display: flex; flex-direction: column; }
        .mobile-nav-username { font-weight: 700; color: var(--text); }
        .mobile-nav-email { font-size: 0.8rem; color: var(--muted); }
        .mobile-nav-main-links, .mobile-nav-footer-links { display: flex; flex-direction: column; padding: 1rem; }
        .mobile-nav-main-links { flex-grow: 1; }
        .mobile-nav-main-links a, .mobile-nav-footer-links a { padding: 1rem; border-radius: 10px; display: flex; align-items: center; gap: 1rem; font-weight: 600; color: var(--muted); transition: all 0.2s ease; }
        .mobile-nav-main-links a:hover, .mobile-nav-footer-links a:hover { background: var(--bg-2); color: var(--text); }
        .mobile-nav-main-links a i, .mobile-nav-footer-links a i { width: 24px; text-align: center; font-size: 1.1rem; }
        .primary-mobile-link { background: var(--gradient-brand); color: white !important; box-shadow: var(--shadow-brand); }
        
        .comments-section { margin-top: 3rem; }
        .comment-header-main { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        #comment-count-display { font-weight: 700; color: var(--muted); }
        
        /* UPDATED BLUR STYLES */
        .comments-wrapper { position: relative; }
        .comments-wrapper.blurred .comments-content-to-blur {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
        }
        .comments-login-overlay {
            position: absolute; inset: 0; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; z-index: 10; padding: 1rem;
            background: rgba(18, 18, 18, 0.5);
            border-radius: 16px;
        }
        .comments-wrapper.blurred .comments-login-overlay { display: flex; }
        .comments-login-overlay p { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; background: rgba(0,0,0,0.5); padding: 0.5rem 1rem; border-radius: 8px; }

        .comment-form-container { display: flex; gap: 1rem; margin-top: 1rem; margin-bottom: 2rem; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .comment-form { flex-grow: 1; }
        .comment-textarea { width: 100%; min-height: 80px; resize: vertical; padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); font-size: 1rem; font-family: inherit; }
        .comment-textarea:focus { outline: none; border-color: var(--brand-1); box-shadow: 0 0 0 3px rgba(var(--brand-1-rgb), 0.2); }
        .comment-textarea:disabled { background: var(--bg-1); cursor: not-allowed; }
        .comment-form-actions { display: flex; justify-content: flex-end; margin-top: 0.5rem; gap: 0.5rem; }
        .comments-list { display: flex; flex-direction: column; gap: 2rem; }
        .comment-thread { display: flex; flex-direction: column; gap: 2rem; }
        .comment { display: flex; gap: 1rem; position: relative; }
        .comment-content { flex-grow: 1; }
        .comment-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; flex-wrap: wrap; }
        .comment-author { font-weight: 700; color: var(--text); }
        .comment-author:hover { text-decoration: underline; }
        .comment-timestamp { font-size: 0.8rem; color: var(--muted); }
        .comment-body { line-height: 1.6; color: var(--muted); white-space: pre-wrap; word-break: break-word; }
        
        .comment-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; }
        .comment-actions { display: flex; align-items: center; gap: 1.25rem; }
        .comment-action-btn { background: none; border: none; color: var(--muted); font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; padding: 4px 0; }
        .comment-action-btn:hover { color: var(--text); }
        .comment-action-btn.liked { color: var(--brand-1); }
        .comment-action-btn.disliked { color: var(--danger); }
        
        .comment-options { position: relative; display: inline-flex; margin-left: auto; }
        .comment-options-btn { background: none; border: none; color: var(--muted); cursor: pointer; padding: 4px; border-radius: 6px; }
        .comment-options-btn:hover { color: var(--text); background: var(--bg-2); }
        .comment-options-menu { display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--bg-2); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10; overflow: hidden; }
        .comment-options-menu.show { display: block; }
        .comment-options-menu button { display: flex; align-items: center; gap: 0.5rem; padding: 8px 12px; background: none; border: none; color: var(--muted); font-family: inherit; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; width: 100%; text-align: left; }
        .comment-options-menu button:hover { background: var(--bg-1); color: var(--text); }
        .comment-options-menu button.delete-btn:hover { color: var(--danger); }
        .comment-options-menu button i { width: 14px; text-align: center; }

        .replies { margin-top: 1.5rem; margin-left: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; border-left: 2px solid var(--border); padding-left: 1.5rem; }
        .reply-form-container { margin-top: 1rem; }
        
        .confirmation-modal-dialog { max-width: 400px; padding: 2rem; text-align: center; }
        .confirmation-modal-dialog p { font-size: 1.1rem; margin: 1rem 0 1.5rem 0; }
        .confirmation-modal-dialog .btn-group { display: flex; justify-content: center; gap: 1rem; }

        .star-rating-display { display: flex; align-items: center; gap: 0.5rem; }
        .star-rating-display .stars { color: var(--star-color); font-size: 1.2rem; }
        .star-rating-display .stars.interactive .fa-star { cursor: pointer; }
        .star-rating-display .stars .fa-star:hover { transform: scale(1.2); }
        .star-rating-display .rating-text { font-size: 0.9rem; font-weight: 600; color: var(--muted); }

        @media (min-width: 993px) {
            .pack-layout {
                grid-template-columns: 1fr 320px;
                grid-template-areas:
                    "main sidebar"
                    "comments sidebar";
            }
            .pack-main-content { grid-area: main; }
            .sidebar-card { grid-area: sidebar; }
            .comments-section { grid-area: comments; }
            .pack-title-area { display: flex; flex-direction: column; }
            .pack-title-area h1 { order: 1; }
            .pack-reviews-and-meta { order: 2; }
        }
        @media (max-width: 768px) { .nav-actions { display: none; } .mobile-nav-toggle { display: block; } }
        @media (max-width: 480px) {
            .pack-header-actions { flex-basis: 100%; margin-top: 1rem; }
            .pack-header-actions .btn { width: 100%; }
            .replies { margin-left: 1rem; padding-left: 1rem; }
            .replies { border-left: 2px solid var(--border); padding-left: 1.5rem; margin-left: 1.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav">
            <a class="brand" href="/">
                <div class="brand-badge"><img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom"></div>
                <div><div class="brand-title">MCHUB</div><div class="tiny">Minecraft Bedrock â€¢ community</div></div>
            </a>
            <div id="nav-actions" class="nav-actions"></div>
            <button class="mobile-nav-toggle"><i class="fa-solid fa-bars"></i></button>
        </div>
    </header>

    <main class="container" id="page-container">
        <div class="loading-container"><div class="spinner"></div><p>Loading Pack...</p></div>
    </main>
    
    <div id="toast-container"></div>

    <div id="edit-pack-modal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header-section">
                <h2>Edit Pack</h2>
                <button class="btn ghost" onclick="closeEditPackModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-content-section">
                <form id="edit-pack-form">
                    <input type="hidden" id="edit-pack-id">
                    <div class="form-group">
                        <label for="edit-pack-name" class="form-label">Pack Name</label>
                        <input type="text" id="edit-pack-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-pack-description" class="form-label">Description</label>
                        <textarea id="edit-pack-description" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-youtube-url" class="form-label">YouTube Video URL</label>
                        <input type="url" id="edit-youtube-url" class="form-input" placeholder="e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Primary Color</label>
                        <div class="swatches" id="edit-pack-colors"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Resolution</label>
                        <div class="resolutions" id="edit-pack-resolutions"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <div class="tags-editor-container" id="edit-pack-tags"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer-section">
                <button type="button" class="btn ghost" onclick="closeEditPackModal()">Cancel</button>
                <button type="submit" form="edit-pack-form" class="btn primary"><i class="fa-solid fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal">
        <div class="modal-dialog confirmation-modal-dialog">
            <h2 id="confirmation-title">Are you sure?</h2>
            <p id="confirmation-message">This action cannot be undone.</p>
            <div class="btn-group">
                <button id="cancel-confirmation-btn" class="btn ghost">Cancel</button>
                <button id="confirm-action-btn" class="btn danger">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module" src="/theme.js"></script>
    <script type="module" src="/auth.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const pageContainer = document.getElementById('page-container');
        let skinViewer = null;
        let currentPackData = null;
        let currentUserRole = 'viewer';
        let loggedInUser = null;
        let loggedInProfile = null;
        
        let armorPreviewLoaded = false;
        let itemsPreviewLoaded = false;
        let guiPreviewLoaded = false;
        
        let foundArmorAssets = {};
        let foundAssets = { items: {}, gui: {} };
        let commentsCache = [];
        let confirmCallback = null;
        
        const ENCHANTABLE_ITEMS = ['diamond_sword', 'iron_sword', 'golden_sword', 'bow', 'crossbow_standby', 'golden_apple'];
        let currentItemPreview = { key: null, isEnchantActive: false };

        const ALL_TAGS = ['pvp', 'bedwars', 'skywars', 'anime', 'crystal pvp', 'survival', 'visual'];
        const ALL_COLORS = [{key: 'none', hex: '#4b5563', icon: 'fa-solid fa-ban'}, {key: 'red',hex: '#ef4444'}, {key: 'blue',hex: '#3b82f6'}, {key: 'green',hex: '#22c55e'}, {key: 'yellow',hex: '#eab308'}, {key: 'purple',hex: '#a855f7'}, {key: 'pink',hex: '#ec4899'}, {key: 'orange',hex: '#f97316'}, {key: 'teal',hex: '#14b8a6'}, {key: 'gray',hex: '#6b7280'}, {key: 'black',hex: '#1f2937'}];
        const ALL_RESOLUTIONS = ['16x', '32x', '64x', '128x', '256x'];

        const ARMOR_ICONS = {
            diamond: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/diamond.png',
            netherite: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/netherite.png',
            iron: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/iron.png',
            gold: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/gold.png',
            chain: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/chainmail.webp',
            leather: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/leather.png',
            turtle: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/turtle.png'
        };

        const ITEM_PATHS = {
             'diamond_sword': 'diamond_sword.png', 'iron_sword': 'iron_sword.png',
             'golden_sword': 'golden_sword.png', 'ender_pearl': 'ender_pearl.png',
             'golden_apple': 'apple_golden.png', 'apple': 'apple.png',
             'bow': 'bow.png', 'fishing_rod': 'fishing_rod.png',
             'totem_of_undying': 'totem.png', 'crossbow_standby': 'crossbow_standby.png'
        };

        const GUI_PATHS = { 
            'icons': 'icons.png', 
            'widgets': 'widgets.png',
            'panorama_overlay': 'panorama_overlay.png'
        };
        const GUI_COMPONENTS = { 
            'Full HUD': { type: 'hud' },
            'Crosshair': { type: 'crosshair' }
        };

        const GUI_PREVIEW_ICONS = {
            'Full HUD': '<i class="fa-solid fa-layer-group"></i>',
            'Crosshair': '<i class="fa-solid fa-crosshairs"></i>',
            'icons': '<i class="fa-solid fa-gem"></i>',
            'widgets': '<i class="fa-solid fa-sliders"></i>'
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--danger)';
            toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'circle-check' : 'circle-exclamation'}" style="color: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                if (toast) {
                    toast.style.transform = 'translateX(120%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function escapeHtml(str) { 
            return String(str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s])); 
        }

        function getYouTubeVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        async function handleDownload(packId, filename, packName) {
            showToast('Starting download...', 'success');
            try {
                const { error: rpcError } = await supabase.rpc('increment_download_count', { pack_id: packId });
                if (rpcError) {
                    console.error("Failed to update download count via RPC:", rpcError);
                } else {
                    const el = document.getElementById('download-count-val');
                    if (el) {
                        const currentCount = parseInt(el.dataset.count || '0', 10);
                        const newCount = currentCount + 1;
                        el.dataset.count = newCount;
                        el.innerHTML = `<i class="fa-solid fa-download fa-fw"></i> ${newCount.toLocaleString()} Downloads`;
                    }
                }

                const { data: urlData, error: urlError } = supabase.storage.from('packs').getPublicUrl(filename);
                if (urlError || !urlData) throw new Error('Could not get download URL.');

                const response = await fetch(urlData.publicUrl);
                if (!response.ok) throw new Error('Download link failed.');
                const blob = await response.blob();

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const extension = filename.split('.').pop();
                link.download = `${packName}.${extension}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error("Download Error:", error);
                showToast('Failed to start download.', 'error');
            }
        }
        
        function renderPackPage(pack) {
            currentPackData = pack; 
            document.title = `${pack.name} â€” MCHub`;
            const packIcon = pack.icon_url || `https://placehold.co/80x80/1c1c1c/e8eefc?text=ICON`;
            let tagsHtml = '';
            if (pack.resolution && pack.resolution !== 'unknown') tagsHtml += `<span class="tag">${escapeHtml(pack.resolution)}</span>`;
            if (pack.version) tagsHtml += `<span class="tag">${escapeHtml(pack.version)}</span>`;
            tagsHtml += (pack.tags || '').split(',').filter(t => t.trim() !== '' && t.trim() !== 'user-upload').map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('');
            const videoId = getYouTubeVideoId(pack.youtube_url);
            const videoHtml = videoId ? `<div class="youtube-video-container"><iframe src="https://www.youtube.com/embed/${videoId}" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>` : '';

            // UPDATED HTML structure for the comment section
            pageContainer.innerHTML = `
                <div class="pack-layout">
                    <div class="pack-main-content">
                        <div class="pack-header">
                            <img src="${packIcon}" alt="${escapeHtml(pack.name)} icon" class="pack-header-icon">
                            <div class="pack-title-area">
                                <h1>${escapeHtml(pack.name)}</h1>
                                <div class="pack-reviews-and-meta">
                                    <div id="star-rating-container"></div>
                                    <div class="pack-meta-info">
                                        <span class="tiny"><i class="fa-solid fa-calendar-day fa-fw"></i> ${formatDate(pack.created_at)}</span>
                                        <span class="tiny" id="download-count-val" data-count="${pack.download_count || 0}"><i class="fa-solid fa-download fa-fw"></i> ${(pack.download_count || 0).toLocaleString()} Downloads</span>
                                    </div>
                                </div>
                            </div>
                            <div class="pack-header-actions" id="header-action-container"></div>
                        </div>
                        ${videoHtml}
                        <div class="description-section"><h3 class="section-title">Description</h3><div class="pack-description">${pack.description ? escapeHtml(pack.description).replace(/\n/g, '<br>') : '<p>This pack has no description.</p>'}</div></div>
                        <div class="tags-section"><h3 class="section-title">Tags</h3><div class="tags-container">${tagsHtml || '<p class="tiny">No tags for this pack.</p>'}</div></div>
                    </div>
                    <aside class="sidebar-card">
                        <div class="card preview-card">
                            <div class="card-body">
                                <div class="preview-tabs">
                                    <button class="preview-tab-btn active" data-tab="armor"><i class="fa-solid fa-shield"></i> Armor</button>
                                    <button class="preview-tab-btn" data-tab="items"><i class="fa-solid fa-diamond"></i> Items</button>
                                    <button class="preview-tab-btn" data-tab="gui"><i class="fa-solid fa-desktop"></i> GUI</button>
                                </div>
                                <div id="armor-panel" class="preview-panel active">
                                    <div class="skin-viewer-wrapper">
                                        <canvas id="skin-viewer-canvas"></canvas>
                                        <button id="viewer-refresh-btn" title="Reset View"><i class="fa-solid fa-arrows-rotate"></i></button>
                                    </div>
                                    <div id="armor-list-container"><p class="preview-placeholder-text">Loading armor preview...</p></div>
                                </div>
                                <div id="items-panel" class="preview-panel">
                                    <div id="item-viewer-wrapper">
                                        <button id="item-enchant-btn"><i class="fa-solid fa-sparkles"></i> Enchant</button>
                                        <div id="item-viewer-container"><canvas id="item-viewer-canvas" width="256" height="256"></canvas></div>
                                    </div>
                                    <div id="item-grid-container">
                                        <div id="item-grid" class="item-grid"></div>
                                        <div id="items-loader"><p class="preview-placeholder-text">Click tab to load preview</p></div>
                                    </div>
                                </div>
                                <div id="gui-panel" class="preview-panel">
                                    <div id="gui-viewer-container"><img id="gui-viewer-canvas" /></div>
                                    <div id="gui-list-container">
                                        <div id="gui-list" class="gui-selection-list"></div>
                                        <div id="gui-loader"><p class="preview-placeholder-text">Click tab to load preview</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <div class="comments-section card">
                        <div class="card-body">
                            <div class="comments-wrapper" id="comments-wrapper">
                                <div class="comments-content-to-blur">
                                    <div class="comment-header-main">
                                        <h3 class="section-title" style="margin:0; border:none;" id="comment-count-display">Comments</h3>
                                    </div>
                                    <div id="comment-form-area"></div>
                                    <div id="comments-list-container">
                                        <div class="comments-placeholder" style="display:flex; flex-direction:column; gap:1rem;"><div class="spinner"></div><span>Loading comments...</span></div>
                                    </div>
                                </div>
                                <div class="comments-login-overlay">
                                    <p>Please login to view the comment section</p>
                                    <a href="/login.html" class="btn primary">Login</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            const actionContainer = document.getElementById('header-action-container');
            actionContainer.innerHTML = `<button class="btn primary" id="download-btn"><i class="fa-solid fa-download"></i> Download</button>`;
            if (currentUserRole === 'admin') {
                actionContainer.innerHTML += `<button class="btn edit-pack-btn" onclick="openEditPackModal()"><i class="fa-solid fa-pencil"></i> Edit</button>`;
            }
            document.getElementById('download-btn').onclick = () => handleDownload(pack.id, pack.filename, pack.name);
            
            setupPreviewer();
            initSkinViewer();
            loadAndProcessPackForArmor(pack);
            loadAndListenForComments(pack.id);
            renderStarRating();
        }

        function setupPreviewer() {
            document.querySelectorAll('.preview-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.preview-tab-btn, .preview-panel').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    const panel = document.getElementById(btn.dataset.tab + '-panel');
                    panel.classList.add('active');
                    if (btn.dataset.tab === 'armor' && !armorPreviewLoaded) loadAndProcessPackForArmor(currentPackData);
                    else if (btn.dataset.tab === 'items' && !itemsPreviewLoaded) loadAndProcessPackForItems(currentPackData);
                    else if (btn.dataset.tab === 'gui' && !guiPreviewLoaded) loadAndProcessPackForGui(currentPackData);
                });
            });
            document.getElementById('item-enchant-btn').addEventListener('click', () => {
                currentItemPreview.isEnchantActive = !currentItemPreview.isEnchantActive;
                document.getElementById('item-enchant-btn').classList.toggle('active', currentItemPreview.isEnchantActive);
                displayItemOnCanvas('item-viewer-canvas', foundAssets.items[currentItemPreview.key].url, currentItemPreview.isEnchantActive);
            });
        }
        
        function showError(title, message) {
            pageContainer.innerHTML = `<div class="error-container"><h2>${title}</h2><p>${message}</p></div>`;
        }
        
        const ARMOR_PATHS_JAVA = [ 'assets/minecraft/textures/models/armor/netherite_layer_1.png', 'assets/minecraft/textures/models/armor/netherite_layer_2.png', 'assets/minecraft/textures/models/armor/diamond_layer_1.png', 'assets/minecraft/textures/models/armor/diamond_layer_2.png', 'assets/minecraft/textures/models/armor/iron_layer_1.png', 'assets/minecraft/textures/models/armor/iron_layer_2.png', 'assets/minecraft/textures/models/armor/gold_layer_1.png', 'assets/minecraft/textures/models/armor/gold_layer_2.png', 'assets/minecraft/textures/models/armor/chainmail_layer_1.png', 'assets/minecraft/textures/models/armor/chainmail_layer_2.png', 'assets/minecraft/textures/models/armor/leather_layer_1.png', 'assets/minecraft/textures/models/armor/leather_layer_2.png', 'assets/minecraft/textures/models/armor/turtle_layer_1.png' ];
        const ARMOR_PATHS_BEDROCK = [ 'textures/models/armor/netherite_1.png', 'textures/models/armor/netherite_2.png', 'textures/models/armor/diamond_1.png', 'textures/models/armor/diamond_2.png', 'textures/models/armor/iron_1.png', 'textures/models/armor/iron_2.png', 'textures/models/armor/gold_1.png', 'textures/models/armor/gold_2.png', 'textures/models/armor/chainmail_1.png', 'textures/models/armor/chainmail_2.png', 'textures/models/armor/leather_1.png', 'textures/models/armor/leather_2.png', 'textures/models/armor/turtle_1.png' ];
        
        async function findBasePath(zip) {
            const manifestFiles = Object.keys(zip.files).filter(path => path.toLowerCase().endsWith('manifest.json'));
            if (manifestFiles.length > 0) return manifestFiles[0].replace(/manifest\.json$/i, '');
            const mcmetaFiles = Object.keys(zip.files).filter(path => path.toLowerCase().endsWith('pack.mcmeta'));
            if (mcmetaFiles.length > 0) return mcmetaFiles[0].replace(/pack\.mcmeta$/i, '');
            const assetsFolderMatches = Object.keys(zip.files).filter(path => path.toLowerCase().includes('/assets/minecraft/'));
            if (assetsFolderMatches.length > 0) {
                const firstMatch = assetsFolderMatches[0];
                const assetsIndex = firstMatch.toLowerCase().indexOf('assets/minecraft/');
                if (assetsIndex !== -1) return firstMatch.substring(0, assetsIndex);
            }
            return '';
        }

        async function findGenericAsset(zip, filename, type) {
            const basePath = await findBasePath(zip);
            const potentialPaths = new Set();
            if (type === 'item') {
                potentialPaths.add(`${basePath}assets/minecraft/textures/item/${filename}`);
                potentialPaths.add(`${basePath}assets/minecraft/textures/items/${filename}`);
                potentialPaths.add(`${basePath}textures/items/${filename}`);
            } else if (type === 'gui') {
                potentialPaths.add(`${basePath}assets/minecraft/textures/gui/${filename}`);
                potentialPaths.add(`${basePath}assets/minecraft/textures/gui/title/background/${filename}`);
                potentialPaths.add(`${basePath}textures/gui/${filename}`);
                potentialPaths.add(`${basePath}textures/ui/${filename}`);
            }
            potentialPaths.add(filename);
            const filenameRegex = new RegExp(`(^|/)${filename.replace(/\./g, '\\.')}$`, 'i');
            const wildcardMatches = Object.keys(zip.files).filter(path => filenameRegex.test(path));
            wildcardMatches.forEach(file => potentialPaths.add(file));
            for (const path of potentialPaths) {
                const normalizedPath = path.replace(/^\/|\/$/g, '');
                if (!normalizedPath) continue;
                const file = zip.file(normalizedPath);
                if (file && !file.dir) {
                    const blob = await file.async('blob');
                    return URL.createObjectURL(blob);
                }
            }
            return null;
        }

        async function loadAndProcessPackForItems(pack) {
            itemsPreviewLoaded = true;
            const loader = document.getElementById('items-loader');
            const grid = document.getElementById('item-grid');
            loader.style.display = 'block';
            grid.style.display = 'none';
            loader.innerHTML = `<p class="preview-placeholder-text"><span class="spinner-sm"></span> Loading Items...</p>`;
            try {
                const zip = await downloadAndUnzipPack(pack);
                foundAssets.items = {};
                const itemPromises = Object.entries(ITEM_PATHS).map(async ([key, filename]) => {
                    const url = await findGenericAsset(zip, filename, 'item');
                    if (url) foundAssets.items[key] = { url };
                });
                await Promise.all(itemPromises);
                loader.style.display = 'none';
                grid.style.display = 'grid';
                renderItemGrid();
            } catch (error) {
                console.error("Items preview error:", error);
                loader.innerHTML = `<p class="preview-placeholder-text" style="color:var(--danger)">Could not load items.</p>`;
            }
        }
        
        async function loadAndProcessPackForGui(pack) {
            guiPreviewLoaded = true;
            const loader = document.getElementById('gui-loader');
            const list = document.getElementById('gui-list');
            loader.style.display = 'block';
            list.style.display = 'none';
            loader.innerHTML = `<p class="preview-placeholder-text"><span class="spinner-sm"></span> Loading GUI...</p>`;
            try {
                const zip = await downloadAndUnzipPack(pack);
                foundAssets.gui = {};
                const guiPromises = Object.entries(GUI_PATHS).map(async ([key, filename]) => {
                    const url = await findGenericAsset(zip, filename, 'gui');
                    if (url) foundAssets.gui[key] = { url };
                });
                await Promise.all(guiPromises);
                loader.style.display = 'none';
                list.style.display = 'flex';
                renderGuiSelectionList();
            } catch (error) {
                console.error("GUI preview error:", error);
                loader.innerHTML = `<p class="preview-placeholder-text" style="color:var(--danger)">Could not load GUI assets.</p>`;
            }
        }
        
        async function downloadAndUnzipPack(pack) {
            const { data: urlData } = supabase.storage.from('packs').getPublicUrl(pack.filename);
            if (!urlData || !urlData.publicUrl) throw new Error('Failed to get pack URL.');
            const response = await fetch(urlData.publicUrl);
            if (!response.ok) throw new Error('Failed to download pack.');
            const fileBlob = await response.blob();
            return await JSZip.loadAsync(fileBlob);
        }

        function renderItemGrid() {
            const itemGrid = document.getElementById('item-grid');
            const itemKeys = Object.keys(foundAssets.items);
            if (itemKeys.length === 0) {
                itemGrid.innerHTML = `<p class="preview-placeholder-text" style="grid-column: 1 / -1;">No standard items found in this pack.</p>`;
                return;
            }
            itemGrid.innerHTML = itemKeys.map(key => `
                <div class="item-icon-card" data-key="${key}">
                    <img src="${foundAssets.items[key].url}" alt="${key.replace(/_/g, ' ')}">
                </div>`).join('');
            
            itemGrid.querySelectorAll('.item-icon-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.item-icon-card, .gui-selection-item').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    const key = card.dataset.key;
                    currentItemPreview.key = key;
                    currentItemPreview.isEnchantActive = false;
                    const isEnchantable = ENCHANTABLE_ITEMS.includes(key);
                    const enchantBtn = document.getElementById('item-enchant-btn');
                    enchantBtn.style.display = isEnchantable ? 'flex' : 'none';
                    enchantBtn.classList.remove('active');
                    displayItemOnCanvas('item-viewer-canvas', foundAssets.items[key].url, false);
                });
            });
            const diamondSwordCard = itemGrid.querySelector('.item-icon-card[data-key="diamond_sword"]');
            if (diamondSwordCard) {
                diamondSwordCard.click();
            } else if (itemGrid.firstChild) {
                itemGrid.firstChild.click();
            }
        }

        function renderGuiSelectionList() {
            const guiList = document.getElementById('gui-list');
            const componentKeys = Object.keys(GUI_COMPONENTS);
            const textureKeys = Object.keys(foundAssets.gui).filter(key => key !== 'panorama_overlay');
            const allDisplayKeys = [...componentKeys, ...textureKeys];
            if (allDisplayKeys.length === 0) {
                guiList.innerHTML = `<p class="preview-placeholder-text">No GUI textures found.</p>`;
                return;
            }
            guiList.innerHTML = allDisplayKeys.map(key => `
                <div class="gui-selection-item" data-key="${key}" title="${key.replace(/_/g, ' ')}">
                    ${GUI_PREVIEW_ICONS[key] || `<i class="fa-solid fa-image"></i>`}
                </div>`).join('');
            guiList.querySelectorAll('.gui-selection-item').forEach(item => {
                item.addEventListener('click', async () => {
                    document.querySelectorAll('.gui-selection-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    const key = item.dataset.key;
                    if (GUI_COMPONENTS[key]) displayGuiComponent(key);
                    else if (foundAssets.gui[key]) displayGuiImage(foundAssets.gui[key].url);
                });
            });
            const crosshairItem = guiList.querySelector('.gui-selection-item[data-key="Crosshair"]');
            if (crosshairItem) { crosshairItem.click(); } 
            else if (guiList.firstChild) { guiList.firstChild.click(); }
        }
        
        async function displayItemOnCanvas(canvasId, url, enchanted = false) {
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const finalUrl = enchanted ? await createEnchantedVersion(url) : url;
            const img = await loadImage(finalUrl);
            const paddingFactor = 0.7;
            const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * paddingFactor;
            const drawWidth = img.width * scale;
            const drawHeight = img.height * scale;
            const x = (canvas.width - drawWidth) / 2;
            const y = (canvas.height - drawHeight) / 2;
            ctx.drawImage(img, x, y, drawWidth, drawHeight);
        }

        function getEffectiveScale(resolutionString) {
            const res = parseInt(resolutionString?.replace('x', '') || '16', 10);
            if (res <= 16) return 1; if (res <= 64) return 2; if (res === 128) return 4; return 8; 
        }

        async function displayGuiComponent(name) {
            const imageViewer = document.getElementById('gui-viewer-canvas');
            if (GUI_COMPONENTS[name]?.type === 'hud') {
                const hudCanvas = await createHudPreview();
                imageViewer.src = hudCanvas.toDataURL();
                imageViewer.style.transform = 'scale(1.5)'; 
            } else if (GUI_COMPONENTS[name]?.type === 'crosshair') {
                if (foundAssets.gui.icons) {
                    const crosshairCanvas = await createCrosshairPreview(foundAssets.gui.icons.url);
                    imageViewer.src = crosshairCanvas.toDataURL();
                    imageViewer.style.transform = 'scale(5)'; 
                } else {
                    imageViewer.src = 'https://placehold.co/64x64/2c2c2c/e8eefc?text=X';
                    imageViewer.style.transform = 'scale(1)';
                }
            }
        }

        function displayGuiImage(url) {
            const imageViewer = document.getElementById('gui-viewer-canvas');
            imageViewer.src = url; imageViewer.style.transform = 'scale(1)';
        }
        
        const loadImage = (url) => new Promise((res, rej) => { const i = new Image(); i.crossOrigin = "Anonymous"; i.onload = () => res(i); i.onerror = rej; i.src = url; });

        async function createHudPreview() {
            const hudCanvas = document.createElement('canvas'); hudCanvas.width = 182; hudCanvas.height = 60;
            const ctx = hudCanvas.getContext('2d'); ctx.imageSmoothingEnabled = false;
            const iconsSheet = foundAssets.gui.icons ? await loadImage(foundAssets.gui.icons.url) : null;
            const widgetsSheet = foundAssets.gui.widgets ? await loadImage(foundAssets.gui.widgets.url) : null;
            const effectiveScaleFactor = getEffectiveScale(currentPackData?.resolution);
            const BASE_ICON_SIZE = 9, BASE_ICON_SPACING = 8, BASE_ICONS_SHEET_RES = 256, ACTIONBAR_H = 22;
            if (widgetsSheet) {
                const S_F_W = widgetsSheet.width / BASE_ICONS_SHEET_RES;
                ctx.drawImage(widgetsSheet, 0, 0, 182 * S_F_W, ACTIONBAR_H * S_F_W, 0, hudCanvas.height - ACTIONBAR_H, 182, ACTIONBAR_H);
            }
            if (iconsSheet) {
                const S_F = iconsSheet.width / BASE_ICONS_SHEET_RES, SRC_ICON_SIZE = BASE_ICON_SIZE * effectiveScaleFactor;
                const X_CENTER = hudCanvas.width / 2, X_START_LEFT = X_CENTER - 91, X_START_RIGHT = X_CENTER + 91 - BASE_ICON_SIZE;
                const HEALTH_Y = hudCanvas.height - ACTIONBAR_H - BASE_ICON_SIZE, ARMOR_Y = HEALTH_Y - BASE_ICON_SIZE, HUNGER_Y = HEALTH_Y;
                for (let i = 0; i < 10; i++) {
                    const X_POS = X_START_LEFT + (i * BASE_ICON_SPACING); 
                    ctx.drawImage(iconsSheet, 16 * S_F, 0, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, HEALTH_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                    if (i < 8) ctx.drawImage(iconsSheet, 52 * S_F, 0, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, HEALTH_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                }
                ctx.drawImage(iconsSheet, 61 * S_F, 0, SRC_ICON_SIZE, SRC_ICON_SIZE, X_START_LEFT + (8 * BASE_ICON_SPACING), HEALTH_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                for (let i = 0; i < 10; i++) {
                    const X_POS = X_START_LEFT + (i * BASE_ICON_SPACING);
                    ctx.drawImage(iconsSheet, 16 * S_F, 9 * S_F, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, ARMOR_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                    if (i < 8) ctx.drawImage(iconsSheet, 34 * S_F, 9 * S_F, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, ARMOR_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                }
                for (let i = 0; i < 10; i++) {
                    const X_POS = X_START_RIGHT - (i * BASE_ICON_SPACING); 
                    ctx.drawImage(iconsSheet, 16 * S_F, 27 * S_F, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, HUNGER_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                    if(i < 7) ctx.drawImage(iconsSheet, 52 * S_F, 27 * S_F, SRC_ICON_SIZE, SRC_ICON_SIZE, X_POS, HUNGER_Y, BASE_ICON_SIZE, BASE_ICON_SIZE);
                }
                const XP_Y = hudCanvas.height - ACTIONBAR_H, XP_SRC_W = 182 * S_F, XP_SRC_H = 5 * S_F;
                ctx.drawImage(iconsSheet, 0, 64 * S_F, XP_SRC_W, XP_SRC_H, 0, XP_Y - 5, hudCanvas.width, 5); 
                ctx.drawImage(iconsSheet, 0, 69 * S_F, 120 * S_F, XP_SRC_H, 0, XP_Y - 5, 120, 5); 
            }
            const FONT_SIZE = 10; 
            ctx.font = `bold ${FONT_SIZE}px Inter, sans-serif`; ctx.fillStyle = '#80FF20';
            ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowOffsetX = 1; ctx.shadowOffsetY = 1; ctx.shadowBlur = 1;
            const levelText = '17'; const textWidth = ctx.measureText(levelText).width;
            ctx.fillText(levelText, (hudCanvas.width / 2) - (textWidth / 2), hudCanvas.height - ACTIONBAR_H + 9); 
            ctx.shadowColor = "transparent"; return hudCanvas;
        }

        async function createCrosshairPreview(iconsSheetUrl) {
            if (!iconsSheetUrl) return null;
            const crosshairCanvas = document.createElement('canvas'); const CROSSHAIR_CANVAS_SIZE = 16;
            crosshairCanvas.width = CROSSHAIR_CANVAS_SIZE; crosshairCanvas.height = CROSSHAIR_CANVAS_SIZE;
            const ctx = crosshairCanvas.getContext('2d');
            ctx.imageSmoothingEnabled = false; ctx.clearRect(0, 0, CROSSHAIR_CANVAS_SIZE, CROSSHAIR_CANVAS_SIZE); 
            try {
                const iconsSheet = await loadImage(iconsSheetUrl);
                const effectiveScaleFactor = getEffectiveScale(currentPackData?.resolution);
                const S_F = iconsSheet.width / 256, sWidth = 16 * effectiveScaleFactor, sHeight = 16 * effectiveScaleFactor; 
                ctx.drawImage(iconsSheet, 0, 0, Math.round(sWidth), Math.round(sHeight), 0, 0, CROSSHAIR_CANVAS_SIZE, CROSSHAIR_CANVAS_SIZE);
                return crosshairCanvas;
            } catch (error) {
                console.error("Failed to create crosshair preview:", error);
                ctx.strokeStyle = 'var(--muted)'; ctx.lineWidth = 2; ctx.beginPath();
                ctx.moveTo(0,0); ctx.lineTo(CROSSHAIR_CANVAS_SIZE, CROSSHAIR_CANVAS_SIZE);
                ctx.moveTo(CROSSHAIR_CANVAS_SIZE,0); ctx.lineTo(0, CROSSHAIR_CANVAS_SIZE);
                ctx.stroke(); return crosshairCanvas;
            }
        }

        async function createEnchantedVersion(url) {
            const img = await loadImage(url);
            const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0);
            ctx.globalCompositeOperation = 'source-atop'; ctx.fillStyle = 'rgba(200, 80, 255, 0.4)';
            ctx.fillRect(0, 0, c.width, c.height); return c.toDataURL();
        }

        function initSkinViewer() {
            try {
                const canvas = document.getElementById('skin-viewer-canvas');
                if (!canvas || !window.skinview3d) return;
                skinViewer = new skinview3d.SkinViewer({ canvas: canvas, width: canvas.clientWidth, height: canvas.clientHeight, skin: 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/steve.png' });
                skinViewer.autoRotate = true; skinViewer.camera.position.set(0, 0, 40);
                const refreshBtn = document.getElementById('viewer-refresh-btn');
                if(refreshBtn) refreshBtn.addEventListener('click', () => { if (skinViewer) { skinViewer.camera.position.set(0, 0, 40); skinViewer.camera.rotation.set(0, 0, 0); skinViewer.autoRotate = true; } });
                new ResizeObserver(() => { if (skinViewer && canvas.clientWidth > 0 && canvas.clientHeight > 0) skinViewer.setSize(canvas.clientWidth, canvas.clientHeight); }).observe(canvas);
                let mouseDown = false;
                canvas.addEventListener('mousedown', () => { mouseDown = true; canvas.classList.add('dragging'); skinViewer.autoRotate = false; });
                canvas.addEventListener('mouseup', () => { mouseDown = false; canvas.classList.remove('dragging'); });
                canvas.addEventListener('mouseleave', () => { if (mouseDown) { mouseDown = false; canvas.classList.remove('dragging'); skinViewer.autoRotate = true; }});
            } catch (e) { console.error("Failed to init 3D viewer", e); }
        }

        async function loadAndProcessPackForArmor(pack) {
            armorPreviewLoaded = true;
            const armorContainer = document.getElementById('armor-list-container');
            armorContainer.innerHTML = `<p class="preview-placeholder-text"><span class="spinner-sm"></span> Loading Armor...</p>`;
            try {
                const zip = await downloadAndUnzipPack(pack);
                const allArmorPaths = [...ARMOR_PATHS_JAVA, ...ARMOR_PATHS_BEDROCK];
                foundArmorAssets = {};
                for (const path of allArmorPaths) {
                    const file = zip.file(path);
                    if (file) {
                        const blob = await file.async('blob'); const url = URL.createObjectURL(blob);
                        let name = path.split('/').pop().replace(/(_1|_2|_layer_1|_layer_2)\.png$/, '');
                        if (name === 'chainmail') name = 'chain';
                        const layer = path.includes('_2') || path.includes('layer_2') ? 'layer2' : 'layer1';
                        if (!foundArmorAssets[name]) foundArmorAssets[name] = {};
                        foundArmorAssets[name][layer] = url;
                    }
                }
                if (Object.keys(foundArmorAssets).length === 0) {
                    armorContainer.innerHTML = '<p class="preview-placeholder-text">No armor textures found in this pack.</p>';
                } else {
                    armorContainer.innerHTML = '<div class="armor-selection-list"></div>';
                    const list = armorContainer.querySelector('.armor-selection-list');
                    Object.keys(foundArmorAssets).sort().forEach(name => {
                        const item = document.createElement('div');
                        item.className = 'armor-item';
                        item.innerHTML = `<img src="${ARMOR_ICONS[name] || 'https://placehold.co/32x32/1c1c1c/e8eefc?text='+name.charAt(0).toUpperCase()}" alt="${name}" title="${name}">`;
                        item.onclick = async () => {
                            document.querySelectorAll('.armor-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            await applyArmor(foundArmorAssets[name]);
                        };
                        list.appendChild(item);
                    });
                    if (list.firstChild) list.firstChild.click();
                }
            } catch (error) {
                console.error("Armor preview error:", error);
                armorContainer.innerHTML = `<p class="preview-placeholder-text" style="color:var(--danger)">Could not load armor.</p>`;
            }
        }

        async function applyArmor(armorSet) {
            if (!skinViewer) return;
            let skinUrl = 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/steve.png';
            if (armorSet.layer1 && armorSet.layer2) skinUrl = await combineArmorLayers(armorSet.layer1, armorSet.layer2);
            else if (armorSet.layer1 || armorSet.layer2) skinUrl = armorSet.layer1 || armorSet.layer2;
            if (skinUrl) skinViewer.loadSkin(skinUrl);
        }

        async function combineArmorLayers(url1, url2) {
            const [img1, img2] = await Promise.all([loadImage(url1), loadImage(url2)]);
            const canvas = document.createElement('canvas');
            canvas.width = Math.max(img1.width, img2.width); canvas.height = Math.max(img1.height, img2.height);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img1, 0, 0); ctx.drawImage(img2, 0, 0);
            return new Promise(res => canvas.toBlob(b => res(URL.createObjectURL(b)), 'image/png'));
        }
        
        async function loadPack() {
            const urlParams = new URLSearchParams(window.location.search);
            const packId = urlParams.get('id');
            if (!packId) return showError("No Pack Found", "A pack ID was not provided in the URL.");
            try {
                const { data: pack, error } = await supabase.from('packs').select('*').eq('id', parseInt(packId, 10)).single();
                if (error || !pack) throw new Error("Pack data could not be found.");
                renderPackPage(pack);
            } catch (error) { showError("Could Not Load Pack", "The pack doesn't exist or there was an error loading it."); }
        }

        function setupMobileNav(profile, user) {
            const header = document.querySelector('header');
            if (!header) return;
            const navContainer = header.querySelector('.nav');
            if (!navContainer) return;
            navContainer.querySelector('.mobile-nav-toggle')?.remove();
            document.querySelector('.mobile-nav-sidebar')?.remove();
            document.querySelector('.mobile-nav-backdrop')?.remove();
            const hamburgerBtn = document.createElement('button');
            hamburgerBtn.className = 'mobile-nav-toggle'; hamburgerBtn.innerHTML = '<i class="fa-solid fa-bars"></i>';
            const sidebar = document.createElement('div'); sidebar.className = 'mobile-nav-sidebar';
            const backdrop = document.createElement('div'); backdrop.className = 'mobile-nav-backdrop';
            let userHeader, mainLinks, footerLinks;
            if (profile && user) {
                const avatarSrc = profile.avatar_url ? profile.avatar_url : `https://placehold.co/60x60/1c1c1c/de212a?text=${profile.username.charAt(0).toUpperCase()}`;
                userHeader = `<div class="mobile-nav-header"><img src="${avatarSrc}" alt="Avatar" class="mobile-nav-avatar"><div class="mobile-nav-user-info"><span class="mobile-nav-username">${profile.username}</span><span class="mobile-nav-email">${user.email}</span></div></div>`;
                mainLinks = `<a href="/"><i class="fa-solid fa-house"></i><span>Home</span></a><a href="/texturepacks.html"><i class="fa-solid fa-palette"></i><span>Texture Packs</span></a><a href="/profile.html?user=${profile.username}"><i class="fa-solid fa-user"></i><span>My Profile</span></a>`;
                footerLinks = `<a href="/settings.html"><i class="fa-solid fa-cog"></i><span>Settings</span></a><a href="#" id="mobile-logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Logout</span></a>`;
            } else {
                userHeader = `<div class="mobile-nav-header"><div class="mobile-nav-avatar" style="background: var(--brand-1); display: grid; place-items:center;"><i class="fa-solid fa-question"></i></div><div class="mobile-nav-user-info"><span class="mobile-nav-username">Guest</span><span class="mobile-nav-email">Not logged in</span></div></div>`;
                mainLinks = `<a href="/"><i class="fa-solid fa-house"></i><span>Home</span></a><a href="/texturepacks.html"><i class="fa-solid fa-palette"></i><span>Texture Packs</span></a>`;
                footerLinks = `<a href="/login.html"><i class="fa-solid fa-right-to-bracket"></i><span>Login</span></a><a href="/signup.html" class="primary-mobile-link"><i class="fa-solid fa-user-plus"></i><span>Sign Up</span></a>`;
            }
            sidebar.innerHTML = `<button class="mobile-nav-close"><i class="fa-solid fa-xmark"></i></button>${userHeader}<nav class="mobile-nav-main-links">${mainLinks}</nav><nav class="mobile-nav-footer-links">${footerLinks}</nav>`;
            navContainer.appendChild(hamburgerBtn); document.body.appendChild(sidebar); document.body.appendChild(backdrop);
            const openMenu = () => { sidebar.classList.add('show'); backdrop.classList.add('show'); };
            const closeMenu = () => { sidebar.classList.remove('show'); backdrop.classList.remove('show'); };
            hamburgerBtn.addEventListener('click', openMenu); sidebar.querySelector('.mobile-nav-close').addEventListener('click', closeMenu); backdrop.addEventListener('click', closeMenu);
            if (profile) sidebar.querySelector('#mobile-logout-btn')?.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); });
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000); let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago"; return "just now";
        }
        
        async function loadAndListenForComments(packId) {
             const { data, error } = await supabase.from('packs_comments').select('*').eq('pack_id', packId).order('created_at', { ascending: false });
            if (error) {
                console.error('Error fetching comments:', error);
                document.getElementById('comments-list-container').innerHTML = '<p class="tiny" style="text-align:center;">Could not load comments.</p>';
            } else {
                commentsCache = data;
                renderComments(commentsCache);
            }
            renderCommentForm();
            supabase.channel(`comments-for-pack-${packId}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'packs_comments', filter: `pack_id=eq.${packId}` }, (payload) => {
                    switch (payload.eventType) {
                        case 'INSERT': commentsCache.unshift(payload.new); break;
                        case 'UPDATE':
                            const indexToUpdate = commentsCache.findIndex(c => c.id === payload.new.id);
                            if (indexToUpdate > -1) commentsCache[indexToUpdate] = payload.new;
                            break;
                        case 'DELETE': handleRecursiveDeleteFromCache(payload.old.id); break;
                    }
                    commentsCache.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    renderComments(commentsCache);
                }).subscribe();
        }

        function renderComments(comments) {
            const wrapper = document.getElementById('comments-wrapper'); const container = document.getElementById('comments-list-container');
            const countDisplay = document.getElementById('comment-count-display');
            if (!container || !countDisplay || !wrapper) return;
            wrapper.classList.toggle('blurred', !loggedInUser);
            countDisplay.textContent = `${comments.length} Comment${comments.length !== 1 ? 's' : ''}`;
            if (comments.length === 0) {
                container.innerHTML = '<p class="tiny" style="text-align:center;">Be the first to comment!</p>';
                return;
            }
            const commentsByParent = comments.reduce((acc, comment) => {
                const parent = comment.parent_id || 'root'; if (!acc[parent]) acc[parent] = []; acc[parent].push(comment); return acc;
            }, {});
            const createCommentHtml = (comment) => {
                const avatar = comment.author_avatar_url || `https://placehold.co/40x40/1c1c1c/de212a?text=${(comment.author_username || '?').charAt(0).toUpperCase()}`;
                const replies = commentsByParent[comment.id] || [];
                const isLiked = loggedInUser && (comment.likes || []).includes(loggedInUser.id);
                const isDisliked = loggedInUser && (comment.dislikes || []).includes(loggedInUser.id);
                let optionsMenu = '';
                if(loggedInUser && (loggedInUser.id === comment.author_id || currentUserRole === 'admin')) {
                    optionsMenu = `<div class="comment-options"><button class="comment-options-btn"><i class="fa-solid fa-ellipsis-vertical"></i></button><div class="comment-options-menu"><button class="delete-btn" data-comment-id="${comment.id}" data-author-id="${comment.author_id}"><i class="fa-solid fa-trash-can"></i> Delete</button></div></div>`;
                }
                return `<div class="comment-thread" id="comment-thread-${comment.id}"><div class="comment"><a href="/profile.html?user=${escapeHtml(comment.author_username)}"><img src="${avatar}" alt="${escapeHtml(comment.author_username)}'s avatar" class="comment-avatar"></a><div class="comment-content"><div class="comment-header"><a href="/profile.html?user=${escapeHtml(comment.author_username)}" class="comment-author">${escapeHtml(comment.author_username)}</a><span class="comment-timestamp">${timeAgo(comment.created_at)}</span>${optionsMenu}</div><p class="comment-body">${escapeHtml(comment.content)}</p><div class="comment-footer"><div class="comment-actions"><button class="comment-action-btn like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}"><i class="fa-solid fa-thumbs-up"></i><span>${(comment.likes || []).length}</span></button><button class="comment-action-btn dislike-btn ${isDisliked ? 'disliked' : ''}" data-comment-id="${comment.id}"><i class="fa-solid fa-thumbs-down"></i><span>${(comment.dislikes || []).length}</span></button><button class="comment-action-btn reply-btn" data-comment-id="${comment.id}"><i class="fa-solid fa-reply"></i><span>Reply</span></button></div></div><div class="reply-form-container" id="reply-form-container-${comment.id}"></div></div></div>${replies.length > 0 ? `<div class="replies">${replies.map(createCommentHtml).join('')}</div>` : ''}</div>`;
            };
            const topLevelComments = commentsByParent['root'] || [];
            container.innerHTML = `<div class="comments-list">${topLevelComments.map(createCommentHtml).join('')}</div>`;
            addCommentEventListeners();
        }
        
        function renderCommentForm(parentId = null, containerEl = null) {
            const targetContainer = containerEl || document.getElementById('comment-form-area');
            if (!targetContainer) return;
            const placeholder = parentId ? "Write a reply..." : "Enjoyed the pack? Leave a review or ask a question!";
            if (loggedInProfile && loggedInUser) {
                 const avatar = loggedInProfile.avatar_url || `https://placehold.co/40x40/1c1c1c/de212a?text=${loggedInProfile.username.charAt(0).toUpperCase()}`;
                targetContainer.innerHTML = `<div class="comment-form-container"><img src="${avatar}" alt="Your avatar" class="comment-avatar"><form class="comment-form" data-parent-id="${parentId || ''}"><textarea class="comment-textarea" placeholder="${placeholder}" required></textarea><div class="comment-form-actions">${parentId ? `<button type="button" class="btn ghost cancel-reply-btn" style="padding: .5rem 1rem;">Cancel</button>`: ''}<button type="submit" class="btn primary" style="padding: .5rem 1rem;">Post</button></div></form></div>`;
                targetContainer.querySelector('form').addEventListener('submit', handleCommentSubmit);
                if(parentId) targetContainer.querySelector('.cancel-reply-btn').addEventListener('click', () => targetContainer.innerHTML = '');
            } else {
                 // UPDATED: No redundant button for logged-out users
                 targetContainer.innerHTML = `<div class="comment-form-container"><div class="comment-avatar" style="background:var(--bg-2); display:grid; place-items:center;"><i class="fa-solid fa-user"></i></div><div class="comment-form"><textarea class="comment-textarea" placeholder="Please log in to leave a review" disabled></textarea></div></div>`;
            }
        }
        
        async function handleCommentSubmit(event) {
            event.preventDefault();
            const form = event.target; const textarea = form.querySelector('textarea'); const submitBtn = form.querySelector('button[type="submit"]');
            const content = textarea.value.trim(); const parentIdStr = form.dataset.parentId; const parentId = parentIdStr ? parseInt(parentIdStr, 10) : null;
            if (!content || !loggedInUser || !loggedInProfile) return;
            submitBtn.disabled = true;
            const { error } = await supabase.from('packs_comments').insert({ pack_id: currentPackData.id, content: content, author_id: loggedInUser.id, author_username: loggedInProfile.username, author_avatar_url: loggedInProfile.avatar_url, parent_id: parentId });
            submitBtn.disabled = false;
            if (error) { showToast('Failed to post comment: ' + error.message, 'error'); } else { form.reset(); if(parentId) document.getElementById(`reply-form-container-${parentId}`).innerHTML = ''; }
        }
        
        function addCommentEventListeners() {
            document.querySelectorAll('.reply-btn').forEach(btn => btn.addEventListener('click', () => { if(!loggedInUser) return showToast('You must be logged in to reply.', 'error'); const commentId = btn.dataset.commentId; document.querySelectorAll('.reply-form-container').forEach(c => c.innerHTML = ''); renderCommentForm(commentId, document.getElementById(`reply-form-container-${commentId}`)); }));
            document.querySelectorAll('.like-btn').forEach(btn => btn.addEventListener('click', () => handleLikeDislike(btn.dataset.commentId, 'like')));
            document.querySelectorAll('.dislike-btn').forEach(btn => btn.addEventListener('click', () => handleLikeDislike(btn.dataset.commentId, 'dislike')));
            document.querySelectorAll('.comment-options-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); const menu = btn.nextElementSibling; const isVisible = menu.classList.contains('show'); document.querySelectorAll('.comment-options-menu').forEach(m => m.classList.remove('show')); if(!isVisible) menu.classList.add('show'); });
            });
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteComment(btn.dataset.commentId, btn.dataset.authorId)));
        }
        
        async function handleLikeDislike(commentId, action) {
            if (!loggedInUser) return showToast('You must be logged in to vote.', 'error');
            const comment = commentsCache.find(c => c.id == commentId); if (!comment) return;
            const likes = new Set(comment.likes || []); const dislikes = new Set(comment.dislikes || []); const userId = loggedInUser.id;
            if (action === 'like') { if (likes.has(userId)) likes.delete(userId); else likes.add(userId); dislikes.delete(userId); } 
            else if (action === 'dislike') { if (dislikes.has(userId)) dislikes.delete(userId); else dislikes.add(userId); likes.delete(userId); }
            const { error } = await supabase.from('packs_comments').update({ likes: [...likes], dislikes: [...dislikes] }).eq('id', commentId);
            if (error) showToast('Failed to update vote.', 'error');
        }

        function handleRecursiveDeleteFromCache(commentId) {
            const idsToDelete = new Set([parseInt(commentId, 10)]);
            const findChildren = (parentId) => {
                const children = commentsCache.filter(c => c.parent_id === parentId);
                for (const child of children) { idsToDelete.add(child.id); findChildren(child.id); }
            };
            findChildren(parseInt(commentId, 10));
            commentsCache = commentsCache.filter(c => !idsToDelete.has(c.id));
        }

        async function handleDeleteComment(commentId, authorId) {
            if (!loggedInUser || (loggedInUser.id !== authorId && currentUserRole !== 'admin')) return showToast('You can only delete your own comments.', 'error');
            showConfirmation('Are you sure you want to permanently delete this comment and all its replies?', async () => {
                const { error } = await supabase.from('packs_comments').delete().eq('id', commentId);
                if (error) { showToast('Failed to delete comment: ' + error.message, 'error'); } 
                else {
                    document.getElementById(`comment-thread-${commentId}`)?.remove();
                    handleRecursiveDeleteFromCache(commentId);
                    renderComments(commentsCache); showToast('Comment deleted.', 'success');
                }
            });
        }
        
        function showConfirmation(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            modal.querySelector('#confirmation-message').textContent = message;
            confirmCallback = onConfirm; modal.classList.add('show');
        }
        
        function renderStarRating() {
            const container = document.getElementById('star-rating-container');
            if (!container || !currentPackData) return;
            const ratings = currentPackData.ratings || {}; const ratingValues = Object.values(ratings);
            const average = ratingValues.length > 0 ? (ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length) : 0;
            const totalRatings = ratingValues.length; let starsHtml = '';
            for (let i = 1; i <= 5; i++) { const isFull = i <= Math.round(average); starsHtml += `<i class="fa-${isFull ? 'solid' : 'regular'} fa-star" data-value="${i}"></i>`; }
            container.innerHTML = `<div class="star-rating-display"><div class="stars ${loggedInUser ? 'interactive' : ''}">${starsHtml}</div><span class="rating-text">${average.toFixed(1)} (${totalRatings} reviews)</span></div>`;
            if(loggedInUser) {
                const stars = container.querySelectorAll('.fa-star');
                stars.forEach(star => {
                    star.addEventListener('click', () => submitRating(star.dataset.value));
                    star.addEventListener('mouseover', () => { for(let i = 0; i < stars.length; i++){ stars[i].classList.toggle('fa-solid', i < star.dataset.value); stars[i].classList.toggle('fa-regular', i >= star.dataset.value); } });
                });
                container.querySelector('.stars').addEventListener('mouseout', () => renderStarRating());
            }
        }

        async function submitRating(ratingValue) {
            if (!loggedInUser || !currentPackData) return;
            const currentRatings = currentPackData.ratings || {};
            currentRatings[loggedInUser.id] = parseInt(ratingValue, 10);
            const { data, error } = await supabase.from('packs').update({ ratings: currentRatings }).eq('id', currentPackData.id).select().single();
            if (error) { showToast('Failed to submit rating.', 'error'); } 
            else { currentPackData = data; renderStarRating(); showToast('Your rating has been submitted!', 'success'); }
        }

        document.addEventListener('auth-ready', async (event) => {
            const { user, profile } = event.detail;
            loggedInUser = user; loggedInProfile = profile;
            const navActions = document.getElementById('nav-actions');
            if (user && profile) {
                currentUserRole = profile.role;
                const avatarContent = profile.avatar_url ? `<img src="${profile.avatar_url}" alt="User Avatar" class="nav-avatar-img">` : `<img src="https://placehold.co/28x28/1c1c1c/de212a?text=${(profile.username || 'U').charAt(0).toUpperCase()}" class="nav-avatar-img">`;
                navActions.innerHTML = `<a class="btn ghost" href="/">Home</a><a class="btn ghost" href="/texturepacks.html">Texture Packs</a><div class="user-dropdown"><button class="user-menu-btn">${avatarContent}<span>${profile.username}</span><i class="fa-solid fa-chevron-down"></i></button><div class="dropdown-content"><a href="/profile.html?user=${profile.username}"><i class="fa-solid fa-user"></i> My Profile</a><a href="/settings.html"><i class="fa-solid fa-cog"></i> Settings</a><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></div></div>`;
                navActions.querySelector('#logout-btn').addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); });
                const btn = navActions.querySelector('.user-menu-btn');
                const content = navActions.querySelector('.dropdown-content');
                btn.addEventListener('click', (e) => { e.stopPropagation(); content.classList.toggle('show');});
            } else {
                currentUserRole = 'viewer';
                navActions.innerHTML = `<a class="btn ghost" href="/">Home</a><a class="btn ghost" href="/texturepacks.html">Texture Packs</a><a class="btn primary" href="/login.html">Login</a>`;
            }
            setupMobileNav(profile, user);
            await loadPack();
        });
        
        window.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.dropdown-content.show');
            if (dropdown && !e.target.closest('.user-dropdown')) dropdown.classList.remove('show');
            const optionsMenu = document.querySelector('.comment-options-menu.show');
            if (optionsMenu && !e.target.closest('.comment-options')) optionsMenu.classList.remove('show');
        });

        document.getElementById('cancel-confirmation-btn')?.addEventListener('click', () => { document.getElementById('confirmation-modal').classList.remove('show'); confirmCallback = null; });
        document.getElementById('confirm-action-btn')?.addEventListener('click', () => { if (confirmCallback) confirmCallback(); document.getElementById('confirmation-modal').classList.remove('show'); confirmCallback = null; });
        window.openEditPackModal = function() {
            const modal = document.getElementById('edit-pack-modal'); if (!currentPackData || !modal) return;
            document.getElementById('edit-pack-id').value = currentPackData.id;
            document.getElementById('edit-pack-name').value = currentPackData.name || '';
            document.getElementById('edit-pack-description').value = currentPackData.description || '';
            document.getElementById('edit-youtube-url').value = currentPackData.youtube_url || '';
            const colorsContainer = document.getElementById('edit-pack-colors');
            colorsContainer.innerHTML = ALL_COLORS.map(c => `<div class="swatch ${currentPackData.color === c.key ? 'active' : ''}" style="background-color: ${c.hex};" data-color="${c.key}">${c.icon ? `<i class="${c.icon}"></i>` : ''}</div>`).join('');
            colorsContainer.querySelectorAll('.swatch').forEach(sw => sw.onclick = () => { colorsContainer.querySelectorAll('.swatch').forEach(s => s.classList.remove('active')); sw.classList.add('active'); });
            const resolutionsContainer = document.getElementById('edit-pack-resolutions');
            resolutionsContainer.innerHTML = ALL_RESOLUTIONS.map(r => `<div class="tag-checkbox ${currentPackData.resolution === r ? 'selected' : ''}" data-res="${r}">${r}</div>`).join('');
            resolutionsContainer.querySelectorAll('.tag-checkbox').forEach(rc => rc.onclick = () => { resolutionsContainer.querySelectorAll('.tag-checkbox').forEach(r => r.classList.remove('selected')); rc.classList.add('selected'); });
            const tagsContainer = document.getElementById('edit-pack-tags');
            const currentTags = new Set(currentPackData.tags ? currentPackData.tags.split(',') : []);
            tagsContainer.innerHTML = ALL_TAGS.map(t => `<div class="tag-checkbox ${currentTags.has(t) ? 'selected' : ''}" data-tag="${t}">${t}</div>`).join('');
            tagsContainer.querySelectorAll('.tag-checkbox').forEach(tc => tc.onclick = () => tc.classList.toggle('selected'));
            modal.classList.add('show');
        }
        window.closeEditPackModal = function() { document.getElementById('edit-pack-modal').classList.remove('show'); }
        document.getElementById('edit-pack-form')?.addEventListener('submit', async (e) => {
            e.preventDefault(); const packId = document.getElementById('edit-pack-id').value;
            const updates = { name: document.getElementById('edit-pack-name').value.trim(), description: document.getElementById('edit-pack-description').value.trim(), youtube_url: document.getElementById('edit-youtube-url').value.trim() || null, color: document.querySelector('#edit-pack-colors .swatch.active')?.dataset.color || 'none', resolution: document.querySelector('#edit-pack-resolutions .tag-checkbox.selected')?.dataset.res || null, tags: Array.from(document.querySelectorAll('#edit-pack-tags .tag-checkbox.selected')).map(el => el.dataset.tag).join(',') };
            try { const { error } = await supabase.from('packs').update(updates).eq('id', packId); if (error) throw error; showToast('Pack updated successfully!', 'success'); closeEditPackModal(); await loadPack(); } catch (error) { showToast('Failed to update pack: ' + error.message, 'error'); }
        });
    </script>
</body>
</html>

