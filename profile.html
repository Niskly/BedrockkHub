<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - MCHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.1/bundles/skinview3d.bundle.js"></script>
    <style>
        :root {
            --bg-0: #000000; --bg-1: #1c1c1c; --bg-2: #2c2c2c; --muted: #a8b3cf;
            --text: #e8eefc; --border: rgba(255, 255, 255, .12); --brand-1: #de212a;
            --brand-2: #b21a22; --shadow-brand: 0 12px 30px rgba(222, 33, 42, .22);
            --border-strong: rgba(255, 255, 255, .2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { margin: 0; background-color: var(--bg-0); color: var(--text); font: 500 14px/1.6 Inter, sans-serif; min-height: 100vh; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bg2.jpeg'); background-size: cover; filter: blur(8px); opacity: 0.2; z-index: -1; }

        /* Bedrock skin viewer styles */
        .bedrock-display { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .bedrock-skin-viewer {
            border-radius: 12px; overflow: hidden;
            border: 1px solid var(--border); position: relative; width: 280px; height: 350px;
            background-image: url('https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/skinbg2.jpg');
            background-size: cover; background-position: center;
        }
        .bedrock-skin-viewer canvas { display: block; border-radius: 12px; cursor: grab; width: 100% !important; height: 100% !important; }
        .bedrock-skin-viewer canvas:active { cursor: grabbing; }
        .bedrock-gamertag { font-size: 1.2rem; font-weight: 700; text-align: center; color: var(--text); }
        .bedrock-xuid { opacity: 0.7; font-size: 11px; text-align: center; color: var(--muted); }
        .skin-loading, .skin-error { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; padding: 2rem; color: var(--muted); width: 100%; height: 100%; text-align: center; backdrop-filter: blur(4px); background: rgba(0,0,0,0.3); }
        .skin-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-bottom-color: var(--brand-1); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .skin-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; }
        .skin-retry-btn { background: var(--brand-1); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; }
        .skin-retry-btn:hover { background: var(--brand-2); transform: translateY(-1px); }
        
        /* Profile type switcher (Bedrock/Java) */
        .profile-type-switcher { display: flex; gap: 0.5rem; margin-bottom: 1rem; background: var(--bg-2); padding: 0.25rem; border-radius: 8px; border: 1px solid var(--border); }
        .profile-type-btn { flex: 1; padding: 0.5rem; border: none; background: transparent; color: var(--muted); font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .profile-type-btn.active { background: var(--bg-0); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        /* Navigation and layout styles */
        a { color: inherit; text-decoration: none; }
        header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.2) blur(10px); background: rgba(12, 12, 12, 0.75); border-bottom: 1px solid var(--border); }
        .nav { max-width: 1100px; margin: 0 auto; padding: 12px 18px; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: .8rem; }
        .brand-badge { height: 40px; width: 40px; border-radius: 10px; display: grid; place-items: center; background: linear-gradient(135deg, var(--brand-2), var(--brand-1)); box-shadow: var(--shadow-brand); }
        .brand-icon-custom { width: 100%; height: 100%; object-fit: contain; padding: 4px; transform: translateY(-11px); }
        .brand-title { font-weight: 800; letter-spacing: .6px; font-size: 15px; }
        .nav-actions { display: flex; align-items: center; gap: 0.6rem; }
        .btn { padding: .5rem 1rem; border-radius: 10px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: .55rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn.primary { background: linear-gradient(90deg, var(--brand-1), var(--brand-2)); box-shadow: 0 10px 30px rgba(222, 33, 42, .22); color: white; }
        .btn.ghost { border-color: var(--border); background: transparent; color: var(--text); }
        .tiny { font-size: 11px; color: var(--muted); }
        
        .user-dropdown { position: relative; display: inline-block; }
        .user-menu-btn { background: var(--bg-2); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        .nav-avatar-img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
        .nav-avatar-default { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-0); display: flex; align-items: center; justify-content: center; }
        .user-menu-btn .fa-chevron-down { font-size: 0.8em; }
        .user-menu-btn:hover { border-color: var(--border-strong); }
        .dropdown-content { display: none; position: absolute; right: 0; top: 110%; background: var(--bg-1); border: 1px solid var(--border); border-radius: 12px; min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); z-index: 10; overflow: hidden; }
        .dropdown-content.show { display: block; }
        .dropdown-content a { color: var(--muted); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .dropdown-content a:hover { background: var(--bg-2); color: var(--text); }

        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .glassy { background: rgba(18, 18, 18, 0.8); backdrop-filter: saturate(1.2) blur(15px); border: 1px solid var(--border); }
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; min-height: 60vh; color: var(--muted); }
        .spinner { width: 48px; height: 48px; border: 5px solid var(--border); border-bottom-color: var(--brand-1); border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        
        .profile-header { border-radius: 16px; margin-bottom: 2rem; overflow: hidden; position: relative; }
        .profile-banner { height: 220px; background-size: cover; background-position: center; }
        .profile-details { position: relative; padding: 1rem 1.5rem; display: flex; align-items: flex-end; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-top: -70px; z-index: 2; }
        .profile-meta { display: flex; align-items: center; gap: 1.5rem; }
        .profile-avatar { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 4px solid #161616; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .pfp-placeholder { width: 140px; height: 140px; border-radius: 50%; border: 4px solid #161616; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--brand-2), var(--brand-1)); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .pfp-placeholder span { font-size: 5rem; font-weight: 800; color: white; }
        .profile-main-info { padding-top: 70px; }
        .profile-main-info h1 { display: flex; align-items: baseline; gap: 0.75rem; flex-wrap: wrap; font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, var(--brand-1), #ff525a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .profile-bio { color: var(--muted); margin-top: 0.5rem; max-width: 500px; line-height: 1.5; font-size: 13px; }
        
        .profile-actions { position: absolute; top: 1.5rem; right: 1.5rem; }
        
        .social-links-container { position: absolute; bottom: 1.5rem; right: 1.5rem; display: flex; gap: 0.8rem; }
        .social-link { font-size: 1.2rem; color: var(--muted); transition: color .2s; cursor: pointer; }
        .social-link:hover { color: var(--text); }
        .social-link.discord { color: #5865F2; } .social-link.spotify { color: #1DB954; }
        .social-link.reddit { color: #FF4500; } .social-link.youtube { color: #FF0000; }
        .social-link.twitter { color: #1DA1F2; } .social-link.github { color: #333; }

        .profile-content-grid { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; align-items: flex-start; }
        .card { border-radius: 16px; }
        .card-body { padding: 1.2rem; }
        h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
        .packs-header { display: flex; justify-content: space-between; align-items: center; }
        .upload-btn { height: 36px; width: 36px; border-radius: 10px; display: grid; place-items: center; background: linear-gradient(135deg, var(--brand-2), var(--brand-1)); box-shadow: var(--shadow-brand); color: white; font-size: 1rem; cursor: pointer; }
        
        .packs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-top: 1.2rem; }
        .pack-card { background: var(--bg-1); border-radius: 16px; overflow: hidden; transition: all 0.2s; border: 1px solid transparent; }
        .pack-card:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0, 0, 0, .4); }
        .thumb { height: 120px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .thumb .pack-icon-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(8px) brightness(0.7); transform: scale(1.1); }
        .thumb .pack-icon { position: relative; width: 80px; height: 80px; border-radius: 8px; object-fit: cover; z-index: 1; }
        .content { padding: 14px; }

        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; min-height: 50vh; text-align: center; color: var(--muted); }
        .error-icon { font-size: 4rem; color: var(--brand-1); margin-bottom: 1rem; }
        .error-title { font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 0.5rem; }
        .error-message { font-size: 1.1rem; line-height: 1.5; max-width: 500px; }

        @media (max-width: 768px) {
            .profile-content-grid { grid-template-columns: 1fr; }
            .bedrock-skin-viewer { width: 240px; height: 300px; }
            .profile-actions { top: 1rem; right: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="nav">
            <a class="brand" href="/">
                <div class="brand-badge"><img src="https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/bh2.png" alt="MCHub Icon" class="brand-icon-custom"></div>
                <div><div class="brand-title">MCHUB</div><div class="tiny">Minecraft Bedrock • community</div></div>
            </a>
            <div id="nav-actions" class="nav-actions"></div>
        </div>
    </header>

    <main class="container" id="profile-container">
        <div class="loading-container"><div class="spinner"></div><p>Loading Profile...</p></div>
    </main>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const SUPABASE_URL = 'https://whxmfpdmnsungcwlffdx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeG1mcGRtbnN1bmdjd2xmZmR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDk3MzYsImV4cCI6MjA3MTg4NTczNn0.PED6DKwmfzUFLIvNbRGY2OQV5XXmc8WKS9E9Be6o8D8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const profileContainer = document.getElementById('profile-container');

        let loggedInUser = null;
        let skinViewer = null;

        function showError(title, message, showRetry = true) {
            profileContainer.innerHTML = `
                <div class="error-container">
                    <i class="fa-solid fa-exclamation-triangle error-icon"></i>
                    <h2 class="error-title">${title}</h2>
                    <p class="error-message">${message}</p>
                    ${showRetry ? `<button class="btn primary" onclick="window.location.reload()"><i class="fa-solid fa-refresh"></i> Try Again</button>` : ''}
                </div>`;
        }

        function renderPackCard(p) {
            const card = document.createElement('div');
            card.className = 'pack-card';
            const thumbContent = p.icon_url
                ? `<div class="pack-icon-bg" style="background-image: url('${p.icon_url}');"></div><img class="pack-icon" src="${p.icon_url}" alt="${p.name} Icon">`
                : `<div style="width:100%; height:100%; display:grid; place-items:center; background:#2c2c2c"><i class="fa-solid fa-cube fa-2x"></i></div>`;
            card.innerHTML = `<a href="#"><div class="thumb">${thumbContent}</div><div class="content"><h4 style="font-size:0.9rem; font-weight:600;">${p.name}</h4></div></a>`;
            return card;
        }

        function renderSocialLinks(socialLinks) {
            if (!socialLinks || typeof socialLinks !== 'object') return '';
            const platforms = [
                { key: 'discord', icon: 'fa-brands fa-discord', class: 'discord', getUrl: (val) => `#`, isUrl: false },
                { key: 'spotify', icon: 'fa-brands fa-spotify', class: 'spotify', getUrl: (val) => val, isUrl: true },
                { key: 'reddit', icon: 'fa-brands fa-reddit-alien', class: 'reddit', getUrl: (val) => val, isUrl: true },
                { key: 'youtube', icon: 'fa-brands fa-youtube', class: 'youtube', getUrl: (val) => val, isUrl: true },
                { key: 'twitter', icon: 'fa-brands fa-twitter', class: 'twitter', getUrl: (val) => val.startsWith('@') ? `https://twitter.com/${val.slice(1)}` : val, isUrl: true },
                { key: 'github', icon: 'fa-brands fa-github', class: 'github', getUrl: (val) => val, isUrl: true }
            ];
            return platforms.filter(p => socialLinks[p.key]).map(p => {
                const value = socialLinks[p.key];
                const url = p.getUrl(value);
                const target = p.isUrl ? 'target="_blank"' : '';
                const title = p.isUrl ? '' : value;
                const clickAction = p.isUrl ? '' : `onclick="copyToClipboard('${value}', this)"`;
                return `<a href="${url}" ${target} class="social-link ${p.class}" title="${title}" ${clickAction}><i class="${p.icon}"></i></a>`;
            }).join('');
        }
        
        window.copyToClipboard = function(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = element.innerHTML;
                element.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => {
                    element.innerHTML = originalIcon;
                }, 1500);
            });
        }

        function renderDashboard(profile, packs, currentUser) {
            const pfpHtml = profile.avatar_url
                ? `<img src="${profile.avatar_url}" alt="${profile.username}'s avatar" class="profile-avatar">`
                : `<div class="pfp-placeholder"><span>${(profile.username || '?').charAt(0).toUpperCase()}</span></div>`;

            let bedrockHtml;
            if (profile.bedrock_gamertag && profile.xuid) {
                bedrockHtml = `
                    <div class="profile-type-switcher">
                        <button class="profile-type-btn active" id="bedrock-btn">Bedrock</button>
                        <button class="profile-type-btn" id="java-btn">Java</button>
                    </div>
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <span class="bedrock-gamertag">${profile.bedrock_gamertag}</span>
                        <div class="bedrock-xuid tiny">XUID: ${profile.xuid}</div>
                    </div>
                    <div class="bedrock-display">
                        <div class="bedrock-skin-viewer" id="bedrock-skin-viewer">
                            <div class="skin-loading"><div class="skin-spinner"></div><span>Loading 3D skin...</span></div>
                        </div>
                    </div>`;
            } else {
                bedrockHtml = `
                    <div style="text-align: center; padding: 2rem; color: var(--muted);">
                        <i class="fa-brands fa-xbox fa-3x" style="opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>No Bedrock account linked</p>
                        <p class="tiny">Link your Xbox account to display your Bedrock skin</p>
                    </div>`;
            }

            const socialLinksHtml = renderSocialLinks(profile.social_links);
            const showFollowButton = currentUser && currentUser.id !== profile.id;
            const profileActionsHtml = showFollowButton ? `<div class="profile-actions"><button class="btn primary follow-btn"><i class="fa-solid fa-user-plus"></i> Follow</button></div>` : '';

            profileContainer.innerHTML = `
                <div class="profile-header glassy">
                    <div class="profile-banner" style="background-image: url('${profile.banner_url || 'https://whxmfpdmnsungcwlffdx.supabase.co/storage/v1/object/public/assets/default-banner.png'}')"></div>
                    <div class="profile-details">
                        ${profileActionsHtml}
                        <div class="profile-meta">
                            ${pfpHtml}
                            <div class="profile-main-info">
                                <h1>
                                    <span>${profile.username || 'Unnamed'}</span>
                                    <span class="tiny">- ${(profile.view_count || 0).toLocaleString()} views</span> 
                                    <span class="tiny" id="follower-count-text">${(profile.followers_count || 0).toLocaleString()} followers</span>
                                    <span class="tiny" id="following-count-text">${(profile.following_count || 0).toLocaleString()} following</span>
                                </h1>
                                <p class="profile-bio">${profile.bio || "This user hasn't written a bio yet."}</p>
                            </div>
                        </div>
                        <div class="social-links-container">
                            ${socialLinksHtml}
                        </div>
                    </div>
                </div>
                <div class="profile-content-grid">
                    <div id="minecraft-container">
                        <div class="card glassy">
                            <div class="card-body">
                                ${bedrockHtml}
                            </div>
                        </div>
                    </div>
                    <div id="packs-container">
                        <div class="card glassy">
                            <div class="card-body">
                                <div class="packs-header">
                                    <h3>Texture Packs</h3>
                                    ${(currentUser && currentUser.id === profile.id) ? '<div class="upload-btn" title="Upload new pack"><i class="fa-solid fa-plus"></i></div>' : ''}
                                </div>
                                <div class="packs-grid" id="packs-grid-placeholder"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            const packsGridEl = document.getElementById('packs-grid-placeholder');
            if (packs && packs.length > 0) {
                packs.forEach(pack => packsGridEl.appendChild(renderPackCard(pack)));
            } else {
                packsGridEl.innerHTML = `<p class="tiny">This user hasn't uploaded any packs yet.</p>`;
            }

            if (profile.bedrock_gamertag && profile.xuid) {
                initBedrockSkinViewer(profile);
            }

            const uploadBtn = document.querySelector('.upload-btn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', () => {
                    window.location.href = '/texturepacks.html';
                });
            }
        }

        async function initBedrockSkinViewer(profile) {
            const viewerContainer = document.getElementById('bedrock-skin-viewer');
            if (!viewerContainer) return;

            try {
                viewerContainer.innerHTML = '<canvas id="skin-canvas"></canvas>';
                const canvas = document.getElementById('skin-canvas');
                if (!canvas) throw new Error('Canvas not created');

                skinViewer = new skinview3d.SkinViewer({
                    canvas: canvas,
                    width: 280,
                    height: 350,
                });

                skinViewer.controls.enableRotate = true;
                skinViewer.controls.enableZoom = true;
                skinViewer.controls.enablePan = false;
                skinViewer.controls.maxDistance = 70;
                skinViewer.controls.minDistance = 25;

                const skinUrl = `/api/bedrock-skin?xuid=${profile.xuid}&gamertag=${encodeURIComponent(profile.bedrock_gamertag)}`;
                console.log(`[Skin Viewer] Loading skin from: ${skinUrl}`);
                
                await skinViewer.loadSkin(skinUrl);
                
                let animationId;
                const rotateModel = () => {
                    if (skinViewer && skinViewer.playerObject) {
                        skinViewer.playerObject.rotation.y += 0.01;
                        animationId = requestAnimationFrame(rotateModel);
                    }
                };
                rotateModel();
                
                canvas.addEventListener('mousedown', () => cancelAnimationFrame(animationId), { once: true });
                
            } catch (error) {
                console.error('❌ Failed to initialize Bedrock skin viewer:', error);
                showSkinError('Failed to load 3D skin', profile);
            }
        }
        
        function showSkinError(message, profile) {
            const viewerContainer = document.getElementById('bedrock-skin-viewer');
            if (viewerContainer) {
                viewerContainer.innerHTML = `
                    <div class="skin-error">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; color: var(--brand-1); margin-bottom: 0.5rem;"></i>
                        <p style="margin-bottom: 1rem;">${message}</p>
                        <button class="skin-retry-btn" onclick="retryLoadingSkin(event, '${profile.xuid}', '${profile.bedrock_gamertag}')">
                            <i class="fa-solid fa-refresh"></i> Retry
                        </button>
                    </div>`;
            }
        }

        window.retryLoadingSkin = function(event, xuid, gamertag) {
            event.stopPropagation();
            const profile = { xuid: xuid, bedrock_gamertag: gamertag };
            initBedrockSkinViewer(profile);
        };
        
        async function setupFollowSystem(profile, currentUser) {
            const followButton = document.querySelector('.follow-btn');
            if (!followButton || !currentUser || currentUser.id === profile.id) return;

            const { count, error: checkError } = await supabase
                .from('followers')
                .select('*', { count: 'exact', head: true })
                .eq('follower_id', currentUser.id)
                .eq('following_id', profile.id);

            if (checkError) return console.error("Failed to check follow status:", checkError);
                
            let isFollowing = count > 0;
            
            function updateButtonState(newFollowerCount) {
                document.getElementById('follower-count-text').textContent = `${newFollowerCount.toLocaleString()} followers`;
                if (isFollowing) {
                    followButton.innerHTML = `<i class="fa-solid fa-user-check"></i> Following`;
                    followButton.classList.replace('primary', 'ghost');
                } else {
                    followButton.innerHTML = `<i class="fa-solid fa-user-plus"></i> Follow`;
                    followButton.classList.replace('ghost', 'primary');
                }
            }
            updateButtonState(profile.followers_count || 0);

            followButton.addEventListener('click', async () => {
                followButton.disabled = true;
                try {
                    const action = isFollowing
                        ? supabase.from('followers').delete().match({ follower_id: currentUser.id, following_id: profile.id })
                        : supabase.from('followers').insert({ follower_id: currentUser.id, following_id: profile.id });
                    
                    const { error } = await action;
                    if (error) throw error;
                    
                    const { data: updatedProfile, error: fetchError } = await supabase.from('profiles_with_counts').select('followers_count').eq('id', profile.id).single();
                    if(fetchError) throw fetchError;
                    
                    isFollowing = !isFollowing;
                    updateButtonState(updatedProfile?.followers_count || 0);
                } catch (error) {
                    console.error('Follow/Unfollow error:', error);
                } finally {
                    followButton.disabled = false;
                }
            });
        }
        
        async function loadProfilePage(currentUser) {
            try {
                const username = new URLSearchParams(window.location.search).get('user');
                if (!username) return showError('No User Specified', 'Please provide a username in the URL.', false); 

                const { data: profile, error: profileError } = await supabase.from('profiles_with_counts').select('*').ilike('username', username).single();
                
                if (profileError || !profile) {
                    return (profileError && profileError.code === 'PGRST116')
                        ? showError('User Not Found', `User "${username}" was not found.`, false)
                        : showError('Loading Error', 'Failed to load user profile.');
                }

                if (currentUser && currentUser.id !== profile.id) {
                    supabase.rpc('increment_view_count', { profile_id_to_update: profile.id }).then(({ error }) => {
                        if (error) console.error('View count error:', error);
                    });
                }
                
                const { data: packs, error: packsError } = await supabase.from('packs').select('*').eq('user_id', profile.id).order('created_at', { ascending: false });
                if (packsError) console.error('Packs error:', packsError);
                
                renderDashboard(profile, packs || [], currentUser);
                await setupFollowSystem(profile, currentUser);

            } catch (error) {
                console.error("❌ Critical error loading profile:", error);
                showError('Loading Error', 'An unexpected error occurred while loading the profile.');
            }
        }

        document.addEventListener('auth-ready', (event) => {
            const { user } = event.detail;
            loggedInUser = user; 
            loadProfilePage(loggedInUser);
        });
    </script>
    <script type="module" src="auth.js"></script>
</body>
</html>
